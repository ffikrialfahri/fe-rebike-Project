Directory Structure:

└── be-rebike
    └── src
        ├── main
        │   └── java
        │       └── com
        │           └── doaibu
        │               └── rebikeapi
        │                   ├── config
        │                   │   ├── CloudinaryConfig.java
        │                   │   ├── DataInitializer.java
        │                   │   ├── FirebaseConfig.java
        │                   │   ├── JwtConfig.java
        │                   │   ├── MidtransConfig.java
        │                   │   ├── OpenApiConfig.java
        │                   │   ├── PasswordEncoderConfig.java
        │                   │   ├── SecurityConfig.java
        │                   │   └── WebSocketConfig.java
        │                   ├── constant
        │                   │   ├── BikeStatus.java
        │                   │   ├── BookingStatus.java
        │                   │   ├── Endpoint.java
        │                   │   ├── PaymentStatus.java
        │                   │   ├── PayoutStatus.java
        │                   │   └── UserRole.java
        │                   ├── controller
        │                   │   ├── AdminController.java
        │                   │   ├── AdminSettingController.java
        │                   │   ├── AuthController.java
        │                   │   ├── ChatController.java
        │                   │   ├── CustomerController.java
        │                   │   ├── PartnerController.java
        │                   │   ├── PublicController.java
        │                   │   └── UserController.java
        │                   ├── dto
        │                   │   ├── request
        │                   │   │   ├── BikeRequest.java
        │                   │   │   ├── ChangePasswordRequest.java
        │                   │   │   ├── ConfirmTransactionRequest.java
        │                   │   │   ├── CreatePaymentRequest.java
        │                   │   │   ├── ForgotPasswordRequest.java
        │                   │   │   ├── LoginRequest.java
        │                   │   │   ├── PartnerDetailUpdateRequest.java
        │                   │   │   ├── PartnerUpdateRequest.java
        │                   │   │   ├── PayoutRequest.java
        │                   │   │   ├── PayoutRequestPayload.java
        │                   │   │   ├── PickupPointRequest.java
        │                   │   │   ├── ProcessPayoutRequest.java
        │                   │   │   ├── RegisterCustomerRequest.java
        │                   │   │   ├── RegisterPartnerRequest.java
        │                   │   │   ├── ResendOtpRequest.java
        │                   │   │   ├── ResetPasswordRequest.java
        │                   │   │   ├── ResetPasswordWithOtpRequest.java
        │                   │   │   ├── TransactionRequest.java
        │                   │   │   ├── UpdateBikeStatusRequest.java
        │                   │   │   ├── UpdateFcmTokenRequest.java
        │                   │   │   ├── UpdateUserProfileRequest.java
        │                   │   │   ├── VerifyOtpRequest.java
        │                   │   │   ├── VerifyPartnerRequest.java
        │                   │   │   └── VerifyPaymentRequest.java
        │                   │   └── response
        │                   │       ├── other
        │                   │       │   ├── CommonResponse.java
        │                   │       │   └── PagedResponse.java
        │                   │       ├── AdminPartnerResponse.java
        │                   │       ├── BikeDetailResponse.java
        │                   │       ├── BikeResponse.java
        │                   │       ├── BusinessRecommendationResponse.java
        │                   │       ├── DashboardSummaryResponse.java
        │                   │       ├── FinancialSummaryResponse.java
        │                   │       ├── FlaggedTransactionResponse.java
        │                   │       ├── LoginResponse.java
        │                   │       ├── MidtransChargeResponse.java
        │                   │       ├── PartnerDetailResponse.java
        │                   │       ├── PayoutResponse.java
        │                   │       ├── PickupPointResponse.java
        │                   │       ├── RegisterResponse.java
        │                   │       ├── RevenueTrendResponse.java
        │                   │       ├── TransactionDetailResponse.java
        │                   │       ├── TransactionResponse.java
        │                   │       └── UserResponse.java
        │                   ├── entity
        │                   │   ├── Bike.java
        │                   │   ├── ChatMessage.java
        │                   │   ├── Partner.java
        │                   │   ├── Payment.java
        │                   │   ├── Payout.java
        │                   │   ├── PickupPoint.java
        │                   │   ├── Role.java
        │                   │   ├── SystemConfiguration.java
        │                   │   ├── Transaction.java
        │                   │   ├── UsagePolicy.java
        │                   │   └── User.java
        │                   ├── exception
        │                   │   ├── CustomException.java
        │                   │   └── GlobalExceptionHandler.java
        │                   ├── repository
        │                   │   ├── BikeRepository.java
        │                   │   ├── ChatMessageRepository.java
        │                   │   ├── PartnerRepository.java
        │                   │   ├── PaymentRepository.java
        │                   │   ├── PayoutRepository.java
        │                   │   ├── PickupPointRepository.java
        │                   │   ├── RoleRepository.java
        │                   │   ├── SystemConfigurationRepository.java
        │                   │   ├── TransactionRepository.java
        │                   │   ├── UsagePolicyRepository.java
        │                   │   └── UserRepository.java
        │                   ├── security
        │                   │   ├── CustomOAuth2AuthenticationSuccessHandler.java
        │                   │   ├── JwtAuthFilter.java
        │                   │   └── JwtUtil.java
        │                   ├── service
        │                   │   ├── impl
        │                   │   │   ├── AdminDashboardServiceImpl.java
        │                   │   │   ├── AdminSettingServiceImpl.java
        │                   │   │   ├── AIAssistantServiceImpl.java
        │                   │   │   ├── AuthServiceImpl.java
        │                   │   │   ├── BikeServiceImpl.java
        │                   │   │   ├── BusinessInsightServiceImpl.java
        │                   │   │   ├── CloudinaryServiceImpl.java
        │                   │   │   ├── EmailServiceImpl.java
        │                   │   │   ├── FraudDetectionServiceImpl.java
        │                   │   │   ├── MidtransServiceImpl.java
        │                   │   │   ├── NotificationServiceImpl.java
        │                   │   │   ├── PartnerServiceImpl.java
        │                   │   │   ├── PayoutServiceImpl.java
        │                   │   │   ├── PickupPointServiceImpl.java
        │                   │   │   ├── RoleServiceImpl.java
        │                   │   │   ├── ScheduledTasksServiceImpl.java
        │                   │   │   ├── TransactionServiceImpl.java
        │                   │   │   ├── UserDetailsServiceImpl.java
        │                   │   │   └── UserServiceImpl.java
        │                   │   ├── AdminDashboardService.java
        │                   │   ├── AdminSettingService.java
        │                   │   ├── AIAssistantService.java
        │                   │   ├── AuthService.java
        │                   │   ├── BikeService.java
        │                   │   ├── BusinessInsightService.java
        │                   │   ├── CloudinaryService.java
        │                   │   ├── EmailService.java
        │                   │   ├── FraudDetectionService.java
        │                   │   ├── MidtransService.java
        │                   │   ├── NotificationService.java
        │                   │   ├── PartnerService.java
        │                   │   ├── PayoutService.java
        │                   │   ├── PickupPointService.java
        │                   │   ├── RoleService.java
        │                   │   ├── ScheduledTasksService.java
        │                   │   ├── TransactionService.java
        │                   │   └── UserService.java
        │                   ├── util
        │                   │   ├── ResponseUtil.java
        │                   │   └── TokenHolder.java
        │                   └── RebikeApplication.java
        └── test
            └── java
                └── com
                    └── doaibu
                        └── rebikeapi
                            └── RebikeApplicationTests.java



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/CloudinaryConfig.java
---

package com.doaibu.rebikeapi.config;

import com.cloudinary.Cloudinary;
import io.github.cdimascio.dotenv.Dotenv;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class CloudinaryConfig {
    private String cloudName;
    private String apiKey;
    private String apiSecret;

    public CloudinaryConfig() {
        Dotenv dotenv = Dotenv.load();

        this.cloudName = dotenv.get("CLOUDINARY_CLOUD_NAME");
        this.apiKey = dotenv.get("CLOUDINARY_API_KEY");
        this.apiSecret = dotenv.get("CLOUDINARY_API_SECRET");
    }

    @Bean
    public Cloudinary cloudinary() {
        Map<String, String> config = new HashMap<>();
        config.put("cloud_name", cloudName);
        config.put("api_key", apiKey);
        config.put("api_secret", apiSecret);
        return new Cloudinary(config);
    }
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/DataInitializer.java
---

package com.doaibu.rebikeapi.config;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.*;
import com.doaibu.rebikeapi.repository.BikeRepository;
import com.doaibu.rebikeapi.repository.UsagePolicyRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.RoleService;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.*;

@Component
@Profile("dev")
@RequiredArgsConstructor
public class DataInitializer implements CommandLineRunner {

    private final UserRepository userRepository;
    private final RoleService roleService;
    private final PasswordEncoder passwordEncoder;
    private final BikeRepository bikeRepository;
    private final UsagePolicyRepository usagePolicyRepository;

    private final String defaultPhotoUrl = "https://res.cloudinary.com/dpqk0grzl/image/upload/default-photo-profile_pqodkq.png";

    @Override
    public void run(String... args) throws Exception {
        createInitialUsers();
        createInitialBikes();
    }

    private void createInitialUsers() {
        if (!userRepository.existsByEmail("admin@example.com")) {
            String rawPassword = "passadmin";
            Set<Role> adminRole = new HashSet<>();
            adminRole.add(roleService.getOrCreate(UserRole.ADMIN));

            User adminUser = User.builder()
                    .firstName("Admin").lastName("Rebike").username("admin")
                    .email("admin@example.com").password(passwordEncoder.encode(rawPassword))
                    .phoneNumber("081234567890").roles(adminRole).photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now()).isAccountNonExpired(true).isAccountNonLocked(true)
                    .isCredentialsNonExpired(true).isEnabled(true).isEmailVerified(true)
                    .build();
            userRepository.save(adminUser);
            System.out.println("[Rebike Initializer] Created ADMIN: admin@example.com | password: " + rawPassword);
        }

        if (!userRepository.existsByEmail("mitra1@example.com")) {
            String rawPassword = "passmitra1";
            Set<Role> partnerRole = new HashSet<>();
            partnerRole.add(roleService.getOrCreate(UserRole.PARTNER));

            User partnerUser = User.builder()
                    .firstName("Mitra").lastName("Satu").username("mitra1")
                    .email("mitra1@example.com").password(passwordEncoder.encode(rawPassword))
                    .phoneNumber("089876543210").roles(partnerRole).photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now()).isAccountNonExpired(true).isAccountNonLocked(true)
                    .isCredentialsNonExpired(true).isEnabled(true).isEmailVerified(true)
                    .build();
            Partner partner = Partner.builder()
                    .user(partnerUser).locationName("Rental Barokah Jaya")
                    .bankAccountName("Mitra Satu").bankAccountNumber("1234567890")
                    .bankName("BCA").isVerified(true).build();
            partnerUser.setPartnerDetail(partner);
            userRepository.save(partnerUser);
            System.out.println("[Rebike Initializer] Created PARTNER: mitra1@example.com | password: " + rawPassword);
        }

        if (!userRepository.existsByEmail("mitra2@example.com")) {
            String rawPassword = "passmitra2";
            Set<Role> partnerRole = new HashSet<>();
            partnerRole.add(roleService.getOrCreate(UserRole.PARTNER));

            User partnerUser = User.builder()
                    .firstName("Imam").lastName("Baehaqi").username("iambaehaqi")
                    .email("mitra2@example.com").password(passwordEncoder.encode(rawPassword))
                    .phoneNumber("081222333444").roles(partnerRole).photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now()).isAccountNonExpired(true).isAccountNonLocked(true)
                    .isCredentialsNonExpired(true).isEnabled(true).isEmailVerified(true)
                    .build();
            Partner partner = Partner.builder()
                    .user(partnerUser).locationName("Baehaqi Motor")
                    .bankAccountName("Imam Baehaqi").bankAccountNumber("0987654321")
                    .bankName("Mandiri").isVerified(true).build();
            partnerUser.setPartnerDetail(partner);
            userRepository.save(partnerUser);
            System.out.println("[Rebike Initializer] Created PARTNER: mitra2@example.com | password: " + rawPassword);
        }

        if (!userRepository.existsByEmail("customer1@example.com")) {
            String rawPassword = "passcustomer1";
            Set<Role> customerRole = new HashSet<>();
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));

            User customerUser = User.builder()
                    .firstName("Budi").lastName("Santoso").username("budi")
                    .email("customer1@example.com").password(passwordEncoder.encode(rawPassword))
                    .phoneNumber("085611112222").roles(customerRole).photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now()).isAccountNonExpired(true).isAccountNonLocked(true)
                    .isCredentialsNonExpired(true).isEnabled(true).isEmailVerified(true)
                    .build();
            userRepository.save(customerUser);
            System.out.println("[Rebike Initializer] Created CUSTOMER: customer1@example.com | password: " + rawPassword);
        }

        if (!userRepository.existsByEmail("customer2@example.com")) {
            String rawPassword = "passcustomer2";
            Set<Role> customerRole = new HashSet<>();
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));

            User customerUser = User.builder()
                    .firstName("Citra").lastName("Lestari").username("citra")
                    .email("customer2@example.com").password(passwordEncoder.encode(rawPassword))
                    .phoneNumber("085733334444").roles(customerRole).photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now()).isAccountNonExpired(true).isAccountNonLocked(true)
                    .isCredentialsNonExpired(true).isEnabled(true).isEmailVerified(true)
                    .build();
            userRepository.save(customerUser);
            System.out.println("[Rebike Initializer] Created CUSTOMER: customer2@example.com | password: " + rawPassword);
        }

        if (!userRepository.existsByEmail("customer3@example.com")) {
            String rawPassword = "passcustomer3";
            Set<Role> customerRole = new HashSet<>();
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));

            User customerUser = User.builder()
                    .firstName("Dewi").lastName("Anggraini").username("dewi")
                    .email("customer3@example.com").password(passwordEncoder.encode(rawPassword))
                    .phoneNumber("081355556666").roles(customerRole).photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now()).isAccountNonExpired(true).isAccountNonLocked(true)
                    .isCredentialsNonExpired(true).isEnabled(true).isEmailVerified(true)
                    .build();
            userRepository.save(customerUser);
            System.out.println("[Rebike Initializer] Created CUSTOMER: customer3@example.com | password: " + rawPassword);
        }
    }

    private void createInitialBikes() {
        if (bikeRepository.count() > 0) {
            return;
        }

        Optional<User> mitra1Optional = userRepository.findByEmail("mitra1@example.com");
        Optional<User> mitra2Optional = userRepository.findByEmail("mitra2@example.com");

        if (mitra1Optional.isEmpty() || mitra2Optional.isEmpty()) {
            System.out.println("[Rebike Initializer] Skipping bike creation: Mitra not found.");
            return;
        }

        User mitra1 = mitra1Optional.get();
        User mitra2 = mitra2Optional.get();

        Set<UsagePolicy> allPolicies = new HashSet<>(usagePolicyRepository.findAll());
        List<Bike> bikesToCreate = new ArrayList<>();

        bikesToCreate.add(Bike.builder()
                .partner(mitra1)
                .name("Honda Vario 125 CBS")
                .brand("Honda")
                .plateNumber("N 1234 ABC")
                .year(2022)
                .machineCapacity("125cc")
                .transmissionType("AUTOMATIC")
                .weekdayPricePerDay(new BigDecimal("70000"))
                .weekendPricePerDay(new BigDecimal("85000"))
                .status(BikeStatus.AVAILABLE)
                .photoURL("https://i.ibb.co/6y4Yc6Z/honda-vario-125.png")
                .usagePolicies(allPolicies)
                .build());

        bikesToCreate.add(Bike.builder()
                .partner(mitra1)
                .name("Honda Scoopy Stylish")
                .brand("Honda")
                .plateNumber("N 5678 DEF")
                .year(2023)
                .machineCapacity("110cc")
                .transmissionType("AUTOMATIC")
                .weekdayPricePerDay(new BigDecimal("75000"))
                .weekendPricePerDay(new BigDecimal("90000"))
                .status(BikeStatus.AVAILABLE)
                .photoURL("https://i.ibb.co/3sY3jYx/honda-scoopy.png")
                .usagePolicies(allPolicies)
                .build());

        bikesToCreate.add(Bike.builder()
                .partner(mitra2)
                .name("Yamaha NMAX Connected")
                .brand("Yamaha")
                .plateNumber("N 9101 GHI")
                .year(2022)
                .machineCapacity("155cc")
                .transmissionType("AUTOMATIC")
                .weekdayPricePerDay(new BigDecimal("120000"))
                .weekendPricePerDay(new BigDecimal("150000"))
                .status(BikeStatus.AVAILABLE)
                .photoURL("https://i.ibb.co/WcWzWB9/yamaha-nmax.png")
                .usagePolicies(allPolicies)
                .build());

        bikesToCreate.add(Bike.builder()
                .partner(mitra2)
                .name("Honda PCX 160 ABS")
                .brand("Honda")
                .plateNumber("N 1121 JKL")
                .year(2023)
                .machineCapacity("160cc")
                .transmissionType("AUTOMATIC")
                .weekdayPricePerDay(new BigDecimal("130000"))
                .weekendPricePerDay(new BigDecimal("160000"))
                .status(BikeStatus.RENTED) // Contoh status berbeda
                .photoURL("https://i.ibb.co/QjgpT3M/honda-pcx-160.png")
                .usagePolicies(allPolicies)
                .build());

        bikeRepository.saveAll(bikesToCreate);
        System.out.println("[Rebike Initializer] Created " + bikesToCreate.size() + " initial bikes for development.");
    }

    private String generateRandomPassword() {
        return UUID.randomUUID().toString().substring(0, 8);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/FirebaseConfig.java
---

package com.doaibu.rebikeapi.config;

import com.google.auth.oauth2.GoogleCredentials;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import com.google.firebase.messaging.FirebaseMessaging;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;

import java.io.IOException;
import java.io.InputStream;

@Configuration
public class FirebaseConfig {

    @Bean
    public FirebaseApp firebaseApp() throws IOException {
        InputStream serviceAccount = new ClassPathResource("serviceAccountKey.json").getInputStream();

        FirebaseOptions options = FirebaseOptions.builder()
                .setCredentials(GoogleCredentials.fromStream(serviceAccount))
                .build();

        if (FirebaseApp.getApps().isEmpty()) {
            return FirebaseApp.initializeApp(options);
        } else {
            return FirebaseApp.getInstance();
        }
    }

    @Bean
    public FirebaseMessaging firebaseMessaging(FirebaseApp firebaseApp) {
        return FirebaseMessaging.getInstance(firebaseApp);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/JwtConfig.java
---

package com.doaibu.rebikeapi.config;

import io.github.cdimascio.dotenv.Dotenv;
import lombok.Data;
import org.springframework.context.annotation.Configuration;

@Data
@Configuration
public class JwtConfig {
    private String secretKey;
    private long expirationMs;

    public JwtConfig() {
        Dotenv dotenv = Dotenv.load();

        this.secretKey = dotenv.get("JWT_SECRET_KEY");
        this.expirationMs = Long.parseLong(dotenv.get("JWT_EXPIRATION_MS"));
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/MidtransConfig.java
---

package com.doaibu.rebikeapi.config;

import io.github.cdimascio.dotenv.Dotenv;
import lombok.Data;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
@Data
public class MidtransConfig {
    private String serverKey;
    private String apiUrl;

    public MidtransConfig() {
        Dotenv dotenv = Dotenv.load();

        this.serverKey = dotenv.get("MIDTRANS_SERVER_KEY");
        this.apiUrl = dotenv.get("MIDTRANS_API_URL");
    }

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/OpenApiConfig.java
---

package com.doaibu.rebikeapi.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        final String securitySchemeName = "bearerAuth";
        return new OpenAPI()
                .addSecurityItem(new SecurityRequirement().addList(securitySchemeName))
                .components(
                        new Components()
                                .addSecuritySchemes(securitySchemeName,
                                        new SecurityScheme()
                                                .name(securitySchemeName)
                                                .type(SecurityScheme.Type.HTTP)
                                                .scheme("bearer")
                                                .bearerFormat("JWT")
                                )
                )
                .info(new Info().title("Rebike API").version("v1.0").description(
                        "Dokumentasi API lengkap untuk platform rental motor Rebike."));
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/PasswordEncoderConfig.java
---

package com.doaibu.rebikeapi.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class PasswordEncoderConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/SecurityConfig.java
---

package com.doaibu.rebikeapi.config;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.security.CustomOAuth2AuthenticationSuccessHandler;
import com.doaibu.rebikeapi.security.JwtAuthFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.List;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    private final UserDetailsService userDetailsService;
    private final JwtAuthFilter jwtAuthFilter;
    private final CustomOAuth2AuthenticationSuccessHandler oauth2SuccessHandler;
    private final PasswordEncoder passwordEncoder;

    @Value("#{'${cors.allowed-origins}'.split(',')}")
    private List<String> allowedOrigins;

    private static final String[] SWAGGER_WHITELIST = {
            "/swagger-ui.html",
            "/swagger-ui/**",
            "/v3/api-docs/**",
            "/swagger-resources/**",
            "/webjars/**"
    };

    @Bean
    public SecurityFilterChain config(HttpSecurity http) throws Exception {
        return http
                .cors(Customizer.withDefaults())
                .csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(authorizeRequests -> {
                    authorizeRequests
                            .requestMatchers(SWAGGER_WHITELIST).permitAll()
                            .requestMatchers(Endpoint.AUTH + "/**", "/login/oauth2/**", "/oauth2/**").permitAll()
                            .requestMatchers(Endpoint.API + "/callback/**").permitAll()
                            .requestMatchers(HttpMethod.GET, Endpoint.PUBLIC + "/**").permitAll()

                            .requestMatchers(Endpoint.USER + "/**").hasAnyRole("PARTNER", "ADMIN", "CUSTOMER")
                            .requestMatchers(Endpoint.PARTNER + "/**").hasRole("PARTNER")
                            .requestMatchers(Endpoint.ADMIN + "/settings/**").hasRole("ADMIN")
                            .requestMatchers(Endpoint.ADMIN + "/**").hasRole("ADMIN")
                            .requestMatchers(Endpoint.CUSTOMER + "/**").hasRole("CUSTOMER")

                            .anyRequest().authenticated();
                })
                .oauth2Login(oauth -> {
                    oauth.successHandler(oauth2SuccessHandler);
                })
                .authenticationProvider(authenticationProvider())
                .addFilterAfter(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class)
                .build();
    }

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("http://localhost:5173"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("Authorization", "Content-Type", "x-auth-token"));
        configuration.setAllowCredentials(true);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(userDetailsService);
        authProvider.setPasswordEncoder(passwordEncoder);
        return authProvider;
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/WebSocketConfig.java
---

package com.doaibu.rebikeapi.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws").withSockJS();
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.setApplicationDestinationPrefixes("/app");
        registry.enableSimpleBroker("/topic", "/queue");
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/BikeStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum BikeStatus {
    AVAILABLE,
    PENDING,
    RENTED,
    INACTIVE
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/BookingStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum BookingStatus {
    PENDING,
    CONFIRMED,
    IN_PROGRESS,
    COMPLETED,
    CANCELLED
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/Endpoint.java
---

package com.doaibu.rebikeapi.constant;

public class Endpoint {
    public static final String API = "/api";

    public static final String AUTH = API + "/auth";
    
    public static final String PUBLIC = API + "/public";
    
    public static final String USER = API + "/user";

    public static final String CUSTOMER = API + "/customer";
    public static final String PARTNER = API + "/partner";
    public static final String ADMIN = API + "/admin";
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/PaymentStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum PaymentStatus {
    CANCELLED,
    PENDING,
    PAID,
    EXPIRED,
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/PayoutStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum PayoutStatus {
    PENDING,
    PROCESSING,
    APPROVED,
    REJECTED
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/UserRole.java
---

package com.doaibu.rebikeapi.constant;

public enum UserRole {
    ADMIN,
    PARTNER,
    CUSTOMER
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/AdminController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.PickupPointRequest;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.dto.request.VerifyPaymentRequest;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.*;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(Endpoint.ADMIN)
@RequiredArgsConstructor
public class AdminController {

    private final UserService userService;
    private final TransactionService transactionService;
    private final PickupPointService pickupPointService;
    private final PayoutService payoutService;
    private final AdminDashboardService adminDashboardService;
    private final FraudDetectionService fraudDetectionService;
    private final BusinessInsightService businessInsightService;

    @GetMapping("/partners")
    public ResponseEntity<?> getAllPartners(@RequestParam(required = false, defaultValue = "0") int page,
                                            @RequestParam(required = false, defaultValue = "10") int size,
                                            @RequestParam(required = false, defaultValue = "firstName") String sortBy,
                                            @RequestParam(required = false, defaultValue = "asc") String sortDirection) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortDirection.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC, sortBy));

        PagedResponse<AdminPartnerResponse> response = userService.getAllPartners(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All partners retrieved successfully.",
                response);
    }

    @GetMapping("/partners/{partnerId}")
    public ResponseEntity<?> getPartnerById(@PathVariable String partnerId) {
        AdminPartnerResponse response = userService.getPartnerById(partnerId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Partner details retrieved successfully.",
                response);
    }

    @PatchMapping("/partners/{partnerId}/verify")
    public ResponseEntity<?> verifyPartner(@PathVariable String partnerId, @RequestBody Map<String, Boolean> payload) {
        Boolean isVerified = payload.get("isVerified");
        if (isVerified == null) {
            throw new CustomException.BadRequestException("Field 'isVerified' with a boolean value is required.");
        }
        userService.verifyPartner(partnerId, isVerified);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Partner verification status updated successfully.",
                null);
    }

    @GetMapping("/transactions")
    public ResponseEntity<?> getAllTransactions(Pageable pageable) {
        PagedResponse<TransactionDetailResponse> response = transactionService.getAllTransactions(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All transactions retrieved successfully.",
                response);
    }

    @PostMapping("/transactions/{transactionId}/verify-payment")
    public ResponseEntity<?> verifyPayment(@PathVariable String transactionId,
                                           @RequestBody VerifyPaymentRequest request) {
        transactionService.verifyPayment(transactionId, request.isValid(), request.getReason());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Payment verification processed.",
                null);
    }

    @PostMapping("/pickup-points")
    public ResponseEntity<?> createPickupPoint(@RequestBody PickupPointRequest request) {
        PickupPointResponse response = pickupPointService.createPickupPoint(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Pickup point created successfully.",
                response);
    }

    @PutMapping("/pickup-points/{pointId}")
    public ResponseEntity<?> updatePickupPoint(@PathVariable String pointId, @RequestBody PickupPointRequest request) {
        PickupPointResponse response = pickupPointService.updatePickupPoint(pointId, request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Pickup point updated successfully.",
                response);
    }

    @DeleteMapping("/pickup-points/{pointId}")
    public ResponseEntity<?> deletePickupPoint(@PathVariable String pointId) {
        pickupPointService.deletePickupPoint(pointId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Pickup point deleted successfully.",
                null);
    }

    @GetMapping("/payouts")
    public ResponseEntity<?> getAllPayouts() {
        List<PayoutResponse> response = payoutService.getAllPayouts();
        return ResponseUtil.response(
                HttpStatus.OK,
                "All payout requests retrieved.",
                response);
    }

    @PostMapping("/payouts/{payoutId}/process")
    public ResponseEntity<?> processPayout(@PathVariable String payoutId, @RequestBody ProcessPayoutRequest request) {
        payoutService.processPayout(payoutId, request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Payout processed successfully.",
                null);
    }

    @GetMapping("/dashboard/summary")
    public ResponseEntity<?> getDashboardSummary() {
        DashboardSummaryResponse response = adminDashboardService.getDashboardSummary();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Dashboard summary retrieved successfully.",
                response);
    }

    @GetMapping("/fraud-alerts")
    public ResponseEntity<?> getFraudAlerts() {
        List<FlaggedTransactionResponse> response = fraudDetectionService.getFlaggedTransactions();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Fraud alerts retrieved successfully.",
                response);
    }

    @GetMapping("/recommendations")
    public ResponseEntity<?> getBusinessRecommendations() {
        List<BusinessRecommendationResponse> response = businessInsightService.generateRecommendations();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Business recommendations retrieved successfully.",
                response);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/AdminSettingController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.service.AdminSettingService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.Map;

@RestController
@RequestMapping(Endpoint.ADMIN + "/settings")
@RequiredArgsConstructor
public class AdminSettingController {

    private final AdminSettingService adminSettingService;

    @GetMapping("/fee")
    public ResponseEntity<?> getFee() {
        BigDecimal fee = adminSettingService.getPlatformFeePercentage();
        return ResponseUtil.response(HttpStatus.OK, "Fee fetched successfully", Map.of("percentage", fee.multiply(new BigDecimal("100"))));
    }

    @PostMapping("/fee")
    public ResponseEntity<?> updateFee(@RequestBody Map<String, String> payload) {
        BigDecimal newFee = new BigDecimal(payload.get("percentage"));
        adminSettingService.updatePlatformFeePercentage(newFee);
        return ResponseUtil.response(HttpStatus.OK, "Fee updated successfully", null);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/AuthController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.LoginResponse;
import com.doaibu.rebikeapi.dto.response.RegisterResponse;
import com.doaibu.rebikeapi.service.AuthService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(Endpoint.AUTH)
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;

    @Value("${app.frontend-base-url}")
    private String feBaseUrl;

    @PostMapping("/register/customer")
    public ResponseEntity<?> registerCustomer(@Valid @RequestBody RegisterCustomerRequest request) {
        RegisterResponse response = authService.registerCustomer(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "User registered as a Customer successfully.",
                response);
    }

    @PostMapping("/register/partner")
    public ResponseEntity<?> registerPartner(@Valid @RequestBody RegisterPartnerRequest request) {
        RegisterResponse response = authService.registerPartner(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "User registered as a Partner successfully.",
                response);
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(@Valid @RequestBody LoginRequest request) {
        LoginResponse response = authService.login(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Login successfully.",
                response);
    }

    @PostMapping("/forgot-password")
    public ResponseEntity<?> forgotPassword(@Valid @RequestBody ForgotPasswordRequest request) {
        authService.processForgotPassword(request.getEmail(), feBaseUrl);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Password reset link has been sent to your email.",
                null);
    }

    @PostMapping("/reset-password-with-otp")
    public ResponseEntity<?> resetPasswordWithOtp(@Valid @RequestBody ResetPasswordWithOtpRequest request) {
        authService.resetPasswordWithOtp(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Password changed successfully.",
                null);
    }

    @PostMapping("/verify-email")
    public ResponseEntity<?> verifyEmail(@Valid @RequestBody VerifyOtpRequest request) {
        authService.verifyEmailOtp(request.getEmail(), request.getOtp());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Email verified successfully.",
                null);
    }

    @PostMapping("/resend-otp")
    public ResponseEntity<?> resendOtp(@Valid @RequestBody ResendOtpRequest request) {
        authService.resendVerificationOtp(request.getEmail());
        return ResponseUtil.response(
                HttpStatus.OK,
                "OTP code resent successfully.",
                null);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/ChatController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.entity.ChatMessage;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.repository.ChatMessageRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.CloudinaryService;
import com.doaibu.rebikeapi.service.NotificationService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDateTime;
import java.util.Map;
import java.util.Optional;

@Controller
@RequiredArgsConstructor
public class ChatController {

    private final SimpMessagingTemplate messagingTemplate;
    private final ChatMessageRepository chatMessageRepository;
    private final CloudinaryService cloudinaryService;
    private final NotificationService notificationService;
    private final UserRepository userRepository;

    @MessageMapping("/chat.sendMessage")
    public void sendMessage(@Payload ChatMessage chatMessage) {
        chatMessage.setTimestamp(LocalDateTime.now());
        chatMessageRepository.save(chatMessage);

        String destination = "/queue/messages/" + chatMessage.getRecipient().getId();
        messagingTemplate.convertAndSend(destination, chatMessage);

        try {
            Optional<User> recipientOptional = userRepository.findById(chatMessage.getRecipient().getId());

            if (recipientOptional.isPresent()) {
                User recipient = recipientOptional.get();
                String fcmToken = recipient.getFcmToken();

                if (fcmToken != null && !fcmToken.isEmpty()) {
                    String senderName = chatMessage.getSender().getFirstName();
                    String messageContent = chatMessage.getType() == ChatMessage.MessageType.TEXT
                            ? chatMessage.getContent()
                            : "Mengirim gambar...";

                    notificationService.sendNotification(
                            fcmToken,
                            "Pesan baru dari " + senderName,
                            messageContent,
                            Map.of("senderId", chatMessage.getSender().getId(), "screen", "ChatScreen")
                    );
                }
            }
        } catch (Exception e) {
            System.err.println("Gagal mengirim push notification untuk chat: " + e.getMessage());
        }
    }

    @PostMapping("/api/v1/chat/upload-image")
    public ResponseEntity<Map<String, String>> uploadImage(@RequestParam("file") MultipartFile file) {
        String fileUrl = cloudinaryService.uploadFile(file, "chat_images");
        Map<String, String> response = Map.of("url", fileUrl);
        return ResponseEntity.ok(response);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/CustomerController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.TransactionRequest;
import com.doaibu.rebikeapi.dto.response.MidtransChargeResponse;
import com.doaibu.rebikeapi.dto.response.TransactionDetailResponse;
import com.doaibu.rebikeapi.dto.response.TransactionResponse;
import com.doaibu.rebikeapi.service.TransactionService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@RestController
@RequestMapping(Endpoint.CUSTOMER)
@RequiredArgsConstructor
public class CustomerController {

    private final TransactionService transactionService;

    @PostMapping("/transactions")
    public ResponseEntity<?> createBooking(@RequestBody TransactionRequest request) {
        MidtransChargeResponse response = transactionService.createBooking(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Booking created successfully",
                response);
    }

    @GetMapping("/transactions")
    public ResponseEntity<?> getTransactionHistory() {
        List<TransactionResponse> response = transactionService.getTransactionHistory();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Transaction history retrieved successfully",
                response);
    }

    @GetMapping("/transactions/{transactionId}")
    public ResponseEntity<?> getTransactionDetails(@PathVariable String transactionId) {
        TransactionDetailResponse response = transactionService.getTransactionDetails(transactionId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Transaction details retrieved successfully",
                response);
    }

//    @PostMapping("/transactions/{transactionId}/payment")
//    public ResponseEntity<?> uploadPaymentProof(@PathVariable String transactionId,
//                                                @RequestParam("paymentProof") MultipartFile paymentProof) {
//        String paymentProofUrl = "http://example.com/payment_proofs/" + transactionId + "_"
//                + paymentProof.getOriginalFilename();
//        transactionService.uploadPaymentProof(transactionId, paymentProofUrl);
//        return ResponseUtil.response(
//                HttpStatus.OK,
//                "Payment proof uploaded successfully",
//                null);
//    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/PartnerController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.service.BikeService;
import com.doaibu.rebikeapi.service.PartnerService;
import com.doaibu.rebikeapi.service.PayoutService;
import com.doaibu.rebikeapi.service.TransactionService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@RestController
@RequestMapping(Endpoint.PARTNER)
@RequiredArgsConstructor
public class PartnerController {

    private final BikeService bikeService;
    private final PartnerService partnerService;
    private final TransactionService transactionService;
    private final PayoutService payoutService;

    @PutMapping("/profile")
    public ResponseEntity<?> updatePartnerProfile(@RequestBody PartnerDetailUpdateRequest request) {
        partnerService.updatePartnerProfile(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Profile updated successfully",
                null);
    }

    @PostMapping("/bikes")
    public ResponseEntity<?> addBike(@RequestBody BikeRequest bikeRequest, @RequestParam MultipartFile file) {
        BikeResponse response = bikeService.addBike(bikeRequest, file);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Bike added successfully",
                response);
    }

    @GetMapping("/bikes")
    public ResponseEntity<?> getAllMyBikes(@RequestParam(required = false, defaultValue = "0") int page,
                                         @RequestParam(required = false, defaultValue = "10") int size,
                                         @RequestParam(required = false, defaultValue = "name") String sortBy,
                                         @RequestParam(required = false, defaultValue = "asc") String sortDirection) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortDirection.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC, sortBy));

        PagedResponse<BikeResponse> response = bikeService.getAllMyBikes(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All my bikes retrieved successfully",
                response);
    }

    @GetMapping("/bikes/{bikeId}")
    public ResponseEntity<?> getBikeById(@PathVariable String bikeId) {
        BikeDetailResponse response = bikeService.getBikeById(bikeId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike retrieved successfully",
                response);
    }

    @PutMapping("/bikes/{bikeId}")
    public ResponseEntity<?> updateBike(@PathVariable String bikeId, @RequestBody BikeRequest bikeRequest) {
        BikeResponse bikeResponse = bikeService.updateBike(bikeId, bikeRequest);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike updated successfully",
                bikeResponse);
    }

    @PutMapping("/bikes/{bikeId}/status")
    public ResponseEntity<?> updateBikeStatus(@PathVariable String bikeId,
                                              @RequestBody UpdateBikeStatusRequest request) {
        BikeResponse response = bikeService.updateBikeStatus(bikeId, request.getStatus());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike status updated successfully",
                response);
    }

    @DeleteMapping("/bikes/{bikeId}")
    public ResponseEntity<?> deleteBike(@PathVariable String bikeId) {
        bikeService.deleteBike(bikeId);

        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike deleted successfully",
                null);
    }

    @GetMapping("/bank-info")
    public ResponseEntity<?> getBankInformation() {
        PartnerDetailResponse response = partnerService.getBankInformation();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bank information retrieved successfully",
                response);
    }

    @PutMapping("/bank-info")
    public ResponseEntity<?> updateBankInformation(@RequestBody PartnerUpdateRequest request) {
        partnerService.updateBankInformation(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bank information updated successfully",
                null);
    }

    @GetMapping("/transactions")
    public ResponseEntity<?> getTransactions() {
        List<TransactionDetailResponse> response = transactionService.getTransactionsForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Partner transactions retrieved successfully",
                response);
    }

    @PostMapping("/transactions/{transactionId}/confirm")
    public ResponseEntity<?> confirmTransaction(@PathVariable String transactionId,
                                                @RequestBody ConfirmTransactionRequest request) {
        transactionService.confirmTransaction(transactionId, request.getStatus());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Transaction status updated successfully",
                null);
    }

    @GetMapping("/financial-summary")
    public ResponseEntity<?> getFinancialSummary() {
        FinancialSummaryResponse response = transactionService.getFinancialSummaryForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Financial summary retrieved successfully",
                response);
    }

    @GetMapping("/payouts")
    public ResponseEntity<?> getPayoutHistory() {
        List<PayoutResponse> response = payoutService.getPayoutsForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Payout history retrieved",
                response);
    }

    @PostMapping("/payouts")
    public ResponseEntity<?> requestPayout(@RequestBody PayoutRequest request) {
        PayoutResponse response = payoutService.requestPayout(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Payout request submitted",
                response);
    }

    @GetMapping("/dashboard/revenue-trend")
    public ResponseEntity<?> getRevenueTrend() {
        RevenueTrendResponse response = transactionService.getRevenueTrendForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Revenue trend retrieved successfully",
                response
        );
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/PublicController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.response.BikeDetailResponse;
import com.doaibu.rebikeapi.dto.response.BikeResponse;
import com.doaibu.rebikeapi.dto.response.PickupPointResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.service.BikeService;
import com.doaibu.rebikeapi.service.MidtransService;
import com.doaibu.rebikeapi.service.PickupPointService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(Endpoint.PUBLIC)
@RequiredArgsConstructor
public class PublicController {

    private final PickupPointService pickupPointService;
    private final BikeService bikeService;
    private final MidtransService midtransService;

    @GetMapping("/pickup-points")
    public ResponseEntity<?> getAllPickupPoints() {
        List<PickupPointResponse> response = pickupPointService.getAllPickupPoints();
        return ResponseUtil.response(
                HttpStatus.OK,
                "All pickup points retrieved successfully",
                response);
    }

    @GetMapping("/bikes")
    public ResponseEntity<?> getAllBikes(@RequestParam(required = false, defaultValue = "0") int page,
                                         @RequestParam(required = false, defaultValue = "10") int size,
                                         @RequestParam(required = false, defaultValue = "name") String sortBy,
                                         @RequestParam(required = false, defaultValue = "asc") String sortDirection) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortDirection.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC, sortBy));

        PagedResponse<BikeResponse> response = bikeService.getAllBikes(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All bikes retrieved successfully",
                response);
    }

    @GetMapping("/bike/{bikeId}")
    public ResponseEntity<?> getBikeById(@PathVariable String bikeId) {
        BikeDetailResponse response = bikeService.getBikeById(bikeId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike retrieved successfully",
                response);
    }

    @PostMapping("/notification")
    public ResponseEntity<String> handleWebhook(@RequestBody Map<String, Object> payload) {
        midtransService.handleWebhook(payload);
        return ResponseEntity.ok("Notification sent successfully");
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/UserController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.ChangePasswordRequest;
import com.doaibu.rebikeapi.dto.request.UpdateFcmTokenRequest;
import com.doaibu.rebikeapi.dto.request.UpdateUserProfileRequest;
import com.doaibu.rebikeapi.service.UserService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping(Endpoint.USER)
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;
    private final TokenHolder tokenHolder;

    @PatchMapping("/password")
    public ResponseEntity<?> changePassword(@Valid @RequestBody ChangePasswordRequest request) {
        String username = tokenHolder.getUsername();
        userService.changePassword(username, request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Password changed successfully",
                null);
    }

    @PutMapping("/profile")
    public ResponseEntity<?> updateProfile(@Valid @RequestBody UpdateUserProfileRequest request, MultipartFile file) {
        userService.updateProfile(request, file);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Profile updated successfully",
                null);
    }

    @PutMapping("/fcm-token")
    public ResponseEntity<Void> updateFcmToken(@RequestBody UpdateFcmTokenRequest request) {
        userService.updateFcmToken(request);
        return ResponseEntity.ok().build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/BikeRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

import java.math.BigDecimal;

@Getter
public class BikeRequest {
    private String name;
    private String photoURL;
    private String plateNumber;
    private String brand;
    private int year;
    private String machineCapacity;
    private String transmissionType;
    private BigDecimal weekdayPricePerDay;
    private BigDecimal weekendPricePerDay;
    private int stock;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ChangePasswordRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ChangePasswordRequest {
    private String oldPassword;
    private String newPassword;
    private String confirmPassword;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ConfirmTransactionRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import com.doaibu.rebikeapi.constant.BookingStatus;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ConfirmTransactionRequest {
    private BookingStatus status;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/CreatePaymentRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;

@Data
@Builder
public class CreatePaymentRequest {
    private String orderId;
    private BigDecimal grossAmount;
    private String customerName;
    private String customerEmail;
    private String bank;
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ForgotPasswordRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;

@Getter
public class ForgotPasswordRequest {
    @NotBlank
    @Email
    private String email;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/LoginRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class LoginRequest {
    private String email;
    private String password;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PartnerDetailUpdateRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class PartnerDetailUpdateRequest {
    private String locationName;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PartnerUpdateRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class PartnerUpdateRequest {
    private String bankName;
    private String bankAccountName;
    private String bankAccountNumber;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PayoutRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

import java.math.BigDecimal;

@Getter
@Setter
public class PayoutRequest {
    private BigDecimal amount;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PayoutRequestPayload.java
---

package com.doaibu.rebikeapi.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Builder;
import lombok.Data;
import java.util.List;

@Data
@Builder
public class PayoutRequestPayload {
    private List<PayoutDetail> payouts;

    @Data
    @Builder
    public static class PayoutDetail {
        @JsonProperty("beneficiary_name")
        private String beneficiaryName;

        @JsonProperty("beneficiary_account")
        private String beneficiaryAccount;

        @JsonProperty("beneficiary_bank")
        private String beneficiaryBank;

        @JsonProperty("beneficiary_email")
        private String beneficiaryEmail;

        private String amount;

        private String notes;

        @JsonProperty("reference_no")
        private String referenceNo;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PickupPointRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class PickupPointRequest {
    private String locationName;
    private String address;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ProcessPayoutRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ProcessPayoutRequest {
    private PayoutStatus status;
    private String notes;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/RegisterCustomerRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class RegisterCustomerRequest {
    @NotBlank
    private String firstName;

    @NotBlank
    private String lastName;

    @NotBlank(message = "Username tidak boleh kosong")
    private String username;

    @NotBlank(message = "Email tidak boleh kosong")
    @Email(message = "Format email tidak valid")
    private String email;

    @NotBlank(message = "Password tidak boleh kosong")
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String password;

    @NotBlank(message = "Nomor telepon tidak boleh kosong")
    private String phoneNumber;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/RegisterPartnerRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class RegisterPartnerRequest {
    @NotBlank
    private String firstName;

    @NotBlank
    private String lastName;

    @NotBlank(message = "Username tidak boleh kosong")
    private String username;

    @NotBlank(message = "Email tidak boleh kosong")
    @Email(message = "Format email tidak valid")
    private String email;

    @NotBlank(message = "Password tidak boleh kosong")
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String password;

    @NotBlank(message = "Nomor telepon tidak boleh kosong")
    private String phoneNumber;

    private String locationName;
    private String bankAccountName;
    private String bankAccountNumber;
    private String bankName;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ResendOtpRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;

@Getter
public class ResendOtpRequest {
    @NotBlank
    @Email
    private String email;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ResetPasswordRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class ResetPasswordRequest {
    @NotBlank
    private String token;

    @NotBlank
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String newPassword;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ResetPasswordWithOtpRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class ResetPasswordWithOtpRequest {
    @NotBlank
    @Email
    private String email;

    @NotBlank
    private String otp;

    @NotBlank
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String newPassword;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/TransactionRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

import java.time.LocalDateTime;

@Getter
public class TransactionRequest {
    private String bikeID;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private String pickupPointId;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/UpdateBikeStatusRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import com.doaibu.rebikeapi.constant.BikeStatus;
import lombok.Getter;
import lombok.Setter;

@Getter
public class UpdateBikeStatusRequest {
    private BikeStatus status;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/UpdateFcmTokenRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Data;

@Data
public class UpdateFcmTokenRequest {
    private String fcmToken;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/UpdateUserProfileRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class UpdateUserProfileRequest {
    private String firstName;
    private String lastName;
    private String username;
    private String phoneNumber;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/VerifyOtpRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;

@Getter
public class VerifyOtpRequest {
    @NotBlank
    @Email
    private String email;

    @NotBlank
    private String otp;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/VerifyPartnerRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class VerifyPartnerRequest {
    private boolean isVerified;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/VerifyPaymentRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class VerifyPaymentRequest {
    private boolean isValid;
    private String reason;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/other/CommonResponse.java
---

package com.doaibu.rebikeapi.dto.response.other;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class CommonResponse<T> {
    private String message;
    private int statusCode;
    private T data;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/other/PagedResponse.java
---

package com.doaibu.rebikeapi.dto.response.other;

import lombok.Builder;
import lombok.Data;
import java.util.List;

@Data
@Builder
public class PagedResponse<T> {
    private List<T> data;
    private int page;
    private int size;
    private long totalElements;
    private int totalPages;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/AdminPartnerResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
public class AdminPartnerResponse {
    private String id;
    private String name;
    private String email;
    private String locationName;
    private int totalBikes;
    private boolean isVerified;

    public AdminPartnerResponse(String id, String name, String email, String locationName, Integer totalBikes, boolean isVerified) {
        this.id = id;
        this.name = name;
        this.email = email;
        this.locationName = locationName;
        this.totalBikes = (totalBikes != null) ? totalBikes : 0;
        this.isVerified = isVerified;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/BikeDetailResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.BikeStatus;
import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.Set;

@Data
@Builder
public class BikeDetailResponse {
    private String bikeID;
    private String name;
    private String photoURL;
    private String brand;
    private String plateNumber;
    private int year;
    private String transmissionType;
    private String machineCapacity;
    private BigDecimal weekdayPricePerDay;
    private BigDecimal weekendPricePerDay;
    private BikeStatus status;
    private Set<UsagePolicyResponse> usagePolicies;
    private PartnerInfo partner;

    @Data
    @Builder
    public static class UsagePolicyResponse {
        private String policyID;
        private String policyName;
        private String description;
        private boolean isPermitted;
    }

    @Data
    @Builder
    public static class PartnerInfo {
        private String locationName;
        private boolean isVerified;
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/BikeResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;

@Data
@Builder
public class BikeResponse {
    private String bikeID;
    private String name;
    private String photoURL;
    private String brand;
    private BigDecimal weekdayPricePerDay;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/BusinessRecommendationResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class BusinessRecommendationResponse {
    private String recommendation;
    private String reason;
    private String severity;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/DashboardSummaryResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

@Data
@Builder
public class DashboardSummaryResponse {
    private long totalUsers;
    private long totalPartners;
    private long totalTransactions;
    private BigDecimal platformRevenue;
    private ChartData userGrowth;
    private ChartData partnerGrowth;

    @Data
    @Builder
    public static class ChartData {
        private List<String> labels;
        private List<Long> data;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/FinancialSummaryResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;

@Data
@Builder
public class FinancialSummaryResponse {
    private BigDecimal totalRevenue;
    private Integer totalCompletedTransactions;
    private Integer totalPendingTransactions;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/FlaggedTransactionResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
public class FlaggedTransactionResponse {
    private String transactionId;
    private String customerName;
    private String bikeName;
    private LocalDateTime transactionDate;
    private BigDecimal totalCost;
    private String reason;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/LoginResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.UserRole;
import lombok.Builder;
import lombok.Data;

import java.util.Set;

@Data
@Builder
public class LoginResponse {
    private Set<UserRole> roles;
    private String token;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/MidtransChargeResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

@Data
public class MidtransChargeResponse {
    @JsonProperty("transaction_id")
    private String transactionId;

    @JsonProperty("order_id")
    private String orderId;

    @JsonProperty("payment_type")
    private String paymentType;

    @JsonProperty("transaction_status")
    private String transactionStatus;

    @JsonProperty("va_numbers")
    private Object vaNumbers;

    @JsonProperty("redirect_url")
    private String redirectUrl;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/PartnerDetailResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PartnerDetailResponse {
    private String bankName;
    private String bankAccountName;
    private String bankAccountNumber;
    private boolean isVerified;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/PayoutResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
public class PayoutResponse {
    private String id;
    private String partnerName;
    private BigDecimal amount;
    private PayoutStatus status;
    private LocalDateTime requestedAt;
    private LocalDateTime processedAt;
    private String bankDetailsSnapshot;
    private String notes;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/PickupPointResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PickupPointResponse {
    private String pickupPointID;
    private String locationName;
    private String address;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/RegisterResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class RegisterResponse {
    private String userID;
    private String email;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/RevenueTrendResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
public class RevenueTrendResponse {
    private List<String> labels;
    private List<BigDecimal> data;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/TransactionDetailResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class TransactionDetailResponse {
    private String transactionID;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private BigDecimal baseCost;
    private BigDecimal totalCost;
    private PaymentStatus paymentStatus;
    private BookingStatus bookingStatus;
    private BikeResponse bike;
    private UserResponse customer;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/TransactionResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
public class TransactionResponse {
    private String transactionID;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private BigDecimal baseCost;
    private BigDecimal totalCost;
    private PaymentStatus paymentStatus;
    private BookingStatus bookingStatus;

    @Data
    @Builder
    public static class AdditionalFeeResponse {
        private String feeID;
        private String description;
        private BigDecimal amount;
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/UserResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class UserResponse {
    private String userID;
    private String firstName;
    private String lastName;
    private String email;
    private String phoneNumber;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Bike.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.BikeStatus;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.util.Objects;
import java.util.Set;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "mst_bike")
public class Bike {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(nullable = false)
    private String name;

    @Column(name = "photo_url", nullable = false)
    private String photoURL;

    @Column(nullable = false)
    private String brand;

    @Column(name = "plate_number", nullable = false, unique = true)
    private String plateNumber;

    @Column(nullable = false)
    private int year;

    @Column(name = "machine_capacity", nullable = false)
    private String machineCapacity;

    @Column(name = "transmission_type", nullable = false)
    private String transmissionType;

    @Column(name = "weekday_price_per_day", nullable = false)
    private BigDecimal weekdayPricePerDay;

    @Column(name = "weekend_price_per_day", nullable = false)
    private BigDecimal weekendPricePerDay;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private BikeStatus status;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "partner_id", nullable = false)
    private User partner;

    @OneToMany(mappedBy = "bike", cascade = CascadeType.ALL)
    private Set<Transaction> transactions;

    @ManyToMany
    @JoinTable(
            name = "trx_bike_usage_policy",
            joinColumns = @JoinColumn(name = "bike_id"),
            inverseJoinColumns = @JoinColumn(name = "usage_policy_id")
    )
    private Set<UsagePolicy> usagePolicies;

    @Version
    private Long version;

    @Override
    public final boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Bike bike = (Bike) o;
        return id != null && Objects.equals(id, bike.id);
    }

    @Override
    public final int hashCode() {
        return Objects.hash(id);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/ChatMessage.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "chat_messages")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ChatMessage {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @ManyToOne
    @JoinColumn(name = "sender_id")
    private User sender;

    @ManyToOne
    @JoinColumn(name = "recipient_id")
    private User recipient;

    @Lob
    @Column(columnDefinition = "TEXT")
    private String content;

    private LocalDateTime timestamp;

    @Enumerated(EnumType.STRING)
    private MessageType type;

    public enum MessageType {
        TEXT,
        IMAGE
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Partner.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "mst_partner")
public class Partner {
    @Id
    private String id;

    @OneToOne
    @MapsId
    @JoinColumn(name = "id")
    private User user;

    @Column(name = "location_name", nullable = true)
    private String locationName;

    @Column(name = "bank_name", nullable = true)
    private String bankName;

    @Column(name = "bank_account_name", nullable = true)
    private String bankAccountName;

    @Column(name = "bank_account_number", nullable = true)
    private String bankAccountNumber;

    @Column(name = "is_verified", nullable = false)
    private boolean isVerified;
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Payment.java
---

package com.doaibu.rebikeapi.entity;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import com.doaibu.rebikeapi.constant.PaymentStatus;

import jakarta.persistence.*;
import lombok.*;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "trx_payment")
public class Payment {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(nullable = false, unique = true)
    private String orderId;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private PaymentStatus status;

    @Column(name = "payment_type")
    private String paymentType;

    @Column(nullable = false)
    private BigDecimal amount;

    @Column(name = "va_number")
    private String vaNumber;

    @Column(name = "bank")
    private String bank;

    @Column(name = "snap_url")
    private String snapUrl;

    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @OneToOne
    @JoinColumn(name = "transaction_id", nullable = false)
    private Transaction transaction;

    @PrePersist
    public void prePersist() {
        this.createdAt = LocalDateTime.now();
    }

    @PreUpdate
    public void preUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Payout.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "trx_payout")
public class Payout {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "partner_id", nullable = false)
    private User partner;

    @Column(nullable = false)
    private BigDecimal amount;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private PayoutStatus status;

    @Column(name = "requested_at", nullable = false)
    private LocalDateTime requestedAt;

    @Column(name = "processed_at")
    private LocalDateTime processedAt;

    @Column(name = "bank_details_snapshot", columnDefinition = "TEXT")
    private String bankDetailsSnapshot;

    @Column
    private String notes;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/PickupPoint.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
@Table(name = "mst_pickup_point")
public class PickupPoint {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(name = "location_name", nullable = false)
    private String locationName;

    @Column(columnDefinition = "TEXT", nullable = false)
    private String address;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Role.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.UserRole;
import jakarta.persistence.*;
import lombok.*;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
@Table(name = "mst_role")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole name;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/SystemConfiguration.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "system_configuration")
public class SystemConfiguration {
    @Id
    private String configKey;
    private String configValue;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Transaction.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;
import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "trx_transaction")
public class Transaction {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "bike_id", nullable = false)
    private Bike bike;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "customer_id", nullable = false)
    private User customer;

    @Column(name = "start_date", nullable = false)
    private LocalDateTime startDate;

    @Column(name = "end_date", nullable = false)
    private LocalDateTime endDate;

    @Column(name = "base_cost", nullable = false)
    private BigDecimal baseCost;

    @Column(name = "additional_costs", nullable = false)
    private BigDecimal additionalCosts;

    @Column(name = "total_cost", nullable = false)
    private BigDecimal totalCost;

    @Enumerated(EnumType.STRING)
    @Column(name = "booking_status", nullable = false)
    private BookingStatus bookingStatus;

    @Enumerated(EnumType.STRING)
    @Column(name = "payment_status", nullable = false)
    private PaymentStatus paymentStatus;

    @OneToOne(mappedBy = "transaction", cascade = CascadeType.ALL)
    private Payment payment;

    @Column(name = "payment_proof_url", nullable = true)
    private String paymentProofUrl;

    @Column(name = "booking_date")
    private LocalDateTime bookingDate;

    @Column(name = "is_flagged_as_potential_fraud")
    private boolean isFlaggedAsPotentialFraud = false;

    @Column(name = "fraud_flag_reason")
    private String fraudFlagReason;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @PrePersist
    public void prePersist() {
        this.createdAt = LocalDateTime.now();
    }

    @PreUpdate
    public void preUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/UsagePolicy.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;

import java.util.Objects;
import java.util.Set;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "mst_usage_policy")
public class UsagePolicy {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(name = "policy_name", nullable = false)
    private String policyName;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(name = "is_permitted", nullable = false)
    private boolean isPermitted;

    @ManyToMany(mappedBy = "usagePolicies")
    private Set<Bike> bikes;

    @Override
    public final boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        UsagePolicy that = (UsagePolicy) o;
        return id != null && Objects.equals(id, that.id);
    }

    @Override
    public final int hashCode() {
        return Objects.hash(id);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/User.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import java.time.LocalDateTime;
import java.util.Collection;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;

@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Entity
@Table(name = "mst_user")
public class User implements UserDetails {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(name = "first_name", nullable = false)
    private String firstName;

    @Column(name = "last_name")
    private String lastName;

    @Column(nullable = false, unique = true)
    private String username;

    @Column(nullable = false, unique = true)
    private String email;

    @Column(nullable = false)
    private String password;

    @Column(name = "phone_number", nullable = false)
    private String phoneNumber;

    @Column(name = "photo_url")
    private String photoUrl;

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(name = "is_account_non_expired")
    private boolean isAccountNonExpired;

    @Column(name = "is_account_non_locked")
    private boolean isAccountNonLocked;

    @Column(name = "is_credentials_non_expired")
    private boolean isCredentialsNonExpired;

    @Column(name = "is_enabled")
    private boolean isEnabled = false;

    @Column(name = "is_email_verified")
    private boolean isEmailVerified = false;

    @Column(name = "verification_otp")
    private String verificationOtp;

    @Column(name = "otp_expiry_time")
    private LocalDateTime otpExpiryTime;

    @Column(name = "reset_password_token")
    private String resetPasswordToken;

    @Column(name = "reset_password_token_expiry")
    private LocalDateTime resetPasswordTokenExpiry;

    @Column(name = "fcm_token")
    private String fcmToken;

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(name = "trx_user_role", joinColumns = @JoinColumn(name = "user_id"), inverseJoinColumns = @JoinColumn(name = "role_id"))
    private Set<Role> roles;

    @OneToMany(mappedBy = "customer", cascade = CascadeType.ALL)
    private Set<Transaction> transactions;

    @OneToMany(mappedBy = "partner", cascade = CascadeType.ALL)
    private Set<Bike> ownedBikes;

    @OneToOne(mappedBy = "user", cascade = CascadeType.ALL)
    private Partner partnerDetail;

    @Version
    private Long version;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return roles.stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName().name()))
                .collect(Collectors.toList());
    }

    @Override
    public String getUsername() { return username; }

    @Override
    public String getPassword() { return password; }

    @Override
    public boolean isAccountNonExpired() { return isAccountNonExpired; }

    @Override
    public boolean isAccountNonLocked() { return isAccountNonLocked; }

    @Override
    public boolean isCredentialsNonExpired() { return isCredentialsNonExpired; }

    @Override
    public boolean isEnabled() { return isEnabled; }

    @Override
    public final boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return id != null && Objects.equals(id, user.id);
    }

    @Override
    public final int hashCode() {
        return Objects.hash(id);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/exception/CustomException.java
---

package com.doaibu.rebikeapi.exception;

public class CustomException {

    public static class BadRequestException extends RuntimeException {
        public BadRequestException(String message) {
            super(message);
        }
    }

    public static class AuthenticationException extends RuntimeException {
        public AuthenticationException(String message) {
            super(message);
        }
    }

    public static class AuthorizationException extends RuntimeException {
        public AuthorizationException(String message) {
            super(message);
        }
    }

    public static class ResourceNotFoundException extends RuntimeException {
        public ResourceNotFoundException(String message) {
            super(message);
        }
    }

    public static class ConflictException extends RuntimeException {
        public ConflictException(String message) {
            super(message);
        }
    }

    public static class PaymentException extends RuntimeException {
        public PaymentException(String message) {
            super(message);
        }
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/exception/GlobalExceptionHandler.java
---

package com.doaibu.rebikeapi.exception;

import com.doaibu.rebikeapi.util.ResponseUtil;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(CustomException.BadRequestException.class)
    public ResponseEntity<?> handleBadRequest(CustomException.BadRequestException ex) {
        return ResponseUtil.response(
                HttpStatus.BAD_REQUEST,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.AuthenticationException.class)
    public ResponseEntity<?> handleAuthentication(CustomException.AuthenticationException ex) {
        return ResponseUtil.response(
                HttpStatus.UNAUTHORIZED,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.AuthorizationException.class)
    public ResponseEntity<?> handleAuthorization(CustomException.AuthorizationException ex) {
        return ResponseUtil.response(
                HttpStatus.FORBIDDEN,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.ResourceNotFoundException.class)
    public ResponseEntity<?> handleNotFound(CustomException.ResourceNotFoundException ex) {
        return ResponseUtil.response(
                HttpStatus.NOT_FOUND,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.ConflictException.class)
    public ResponseEntity<?> handleConflict(CustomException.ConflictException ex) {
        return ResponseUtil.response(
                HttpStatus.CONFLICT,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.PaymentException.class)
    public ResponseEntity<?> handlePayment(CustomException.PaymentException ex) {
        return ResponseUtil.response(
                HttpStatus.PAYMENT_REQUIRED,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleAll(Exception ex) {
        ex.printStackTrace();

        return ResponseUtil.response(
                HttpStatus.INTERNAL_SERVER_ERROR,
                "An unexpected internal server error occurred.",
                null);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/BikeRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.Bike;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BikeRepository extends JpaRepository<Bike, String> {
    Page<Bike> findByPartner(User partner, Pageable pageable);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/ChatMessageRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.ChatMessage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ChatMessageRepository extends JpaRepository<ChatMessage, String> {

    @Query("SELECT cm FROM ChatMessage cm WHERE " +
            "(cm.sender.id = :userA_id AND cm.recipient.id = :userB_id) OR " +
            "(cm.sender.id = :userB_id AND cm.recipient.id = :userA_id) " +
            "ORDER BY cm.timestamp ASC")
    List<ChatMessage> findConversationBetweenUsers(@Param("userA_id") String userA_id,
                                                   @Param("userB_id") String userB_id);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PartnerRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface PartnerRepository extends JpaRepository<Partner, String> {
    Optional<Partner> findByUser(User user);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PaymentRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.Payment;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface PaymentRepository extends JpaRepository<Payment, String> {
    Optional<Payment> findByOrderId(String orderId);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PayoutRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import com.doaibu.rebikeapi.entity.Payout;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface PayoutRepository extends JpaRepository<Payout, String> {
    List<Payout> findByPartnerOrderByRequestedAtDesc(User partner);
    List<Payout> findAllByStatus(PayoutStatus status);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PickupPointRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.PickupPoint;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface PickupPointRepository extends JpaRepository<PickupPoint, String> {

}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/RoleRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.Role;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface RoleRepository extends JpaRepository<Role, String> {
    Optional<Role> findByName(UserRole name);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/SystemConfigurationRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.SystemConfiguration;
import org.springframework.data.jpa.repository.JpaRepository;

public interface SystemConfigurationRepository extends JpaRepository<SystemConfiguration, String> {
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/TransactionRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface TransactionRepository extends JpaRepository<Transaction, String> {
    List<Transaction> findByCustomer(User customer);

    List<Transaction> findByBike_Partner(User partner);

    @Query("SELECT SUM(t.totalCost) FROM Transaction t WHERE t.bookingStatus = :status")
    BigDecimal sumTotalCostByBookingStatus(BookingStatus status);

    List<Transaction> findAllByBookingStatusAndStartDateBetween(BookingStatus bookingStatus, LocalDateTime start, LocalDateTime end);

    List<Transaction> findAllByIsFlaggedAsPotentialFraud(boolean isFlagged);

    List<Transaction> findAllByCreatedAtAfter(LocalDateTime dateTime);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/UsagePolicyRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.UsagePolicy;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UsagePolicyRepository extends JpaRepository<UsagePolicy, String> {
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/UserRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.response.AdminPartnerResponse;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import com.doaibu.rebikeapi.entity.Role;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.Set;

@Repository
public interface UserRepository extends JpaRepository<User, String> {
    Optional<User> findByUsername(String username);

    Optional<User> findByEmail(String email);

    Boolean existsByEmail(String email);

    Boolean existsByUsername(String username);

    @Query("SELECT new com.doaibu.rebikeapi.dto.response.AdminPartnerResponse(" +
            "u.id, " +
            "CONCAT(u.firstName, ' ', u.lastName), " +
            "u.email, " +
            "p.locationName, " +
            "size(u.ownedBikes), " +
            "p.isVerified) " +
            "FROM User u JOIN u.partnerDetail p WHERE :role MEMBER OF u.roles")
    Page<AdminPartnerResponse> findAllPartnersWithBikeCount(@Param("role") Role role, Pageable pageable);

    List<User> findAllByRoles_Name(UserRole name);

    long countByRolesContaining(Role partnerRole);

    @Query("SELECT COUNT(u) FROM User u WHERE u.createdAt BETWEEN :start AND :end")
    long countNewUsersBetween(@Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

    @Query("SELECT COUNT(u) FROM User u WHERE :role MEMBER OF u.roles AND u.createdAt BETWEEN :start AND :end")
    long countNewUsersWithRoleBetween(@Param("role") Role role, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/security/CustomOAuth2AuthenticationSuccessHandler.java
---

package com.doaibu.rebikeapi.security;

import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.service.AuthService;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.DefaultOAuth2User;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;

import java.io.IOException;

@Component
@RequiredArgsConstructor
public class CustomOAuth2AuthenticationSuccessHandler implements AuthenticationSuccessHandler {

    private final AuthService authService;
    private final JwtUtil jwtUtil;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        DefaultOAuth2User oauth2User = (DefaultOAuth2User) authentication.getPrincipal();
        String email = oauth2User.getAttribute("email");
        String name = oauth2User.getAttribute("name");

        User user = authService.processOAuthPostLogin(email, name);
        String token = jwtUtil.generateToken(user);

        String redirectUrl = UriComponentsBuilder.fromUriString("http://localhost:5173/auth/sso-callback")
                .queryParam("token", token)
                .build().toUriString();

        response.sendRedirect(redirectUrl);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/security/JwtAuthFilter.java
---

package com.doaibu.rebikeapi.security;

import com.doaibu.rebikeapi.service.impl.UserDetailsServiceImpl;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@RequiredArgsConstructor
@Component
public class JwtAuthFilter extends OncePerRequestFilter {
    private final JwtUtil jwtUtil;
    private final UserDetailsServiceImpl userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        String authHeader = request.getHeader("Authorization");

        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            String username = jwtUtil.extractUsername(token);

            if (jwtUtil.validateToken(token)) {
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);

                UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
                        username,
                        null,
                        userDetails.getAuthorities());

                SecurityContextHolder.getContext().setAuthentication(auth);
            }
        }

        filterChain.doFilter(request, response);
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/security/JwtUtil.java
---

package com.doaibu.rebikeapi.security;

import com.doaibu.rebikeapi.config.JwtConfig;
import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTVerifier;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.exceptions.JWTVerificationException;
import com.auth0.jwt.interfaces.DecodedJWT;
import com.doaibu.rebikeapi.entity.User;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.stereotype.Component;

import java.util.Date;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class JwtUtil {

    private final JwtConfig jwtConfig;

    public String generateToken(User user) {
        return JWT.create()
                .withSubject(user.getUsername())
                .withClaim("roles", user.getAuthorities().stream().map(GrantedAuthority::getAuthority).collect(Collectors.toList()))
                .withClaim("firstName", user.getFirstName())
                .withClaim("lastName", user.getLastName())
                .withClaim("email", user.getEmail())
                .withClaim("phoneNumber", user.getPhoneNumber())
                .withClaim("photoUrl", user.getPhotoUrl())
                .withIssuedAt(new Date())
                .withExpiresAt(new Date(System.currentTimeMillis() + jwtConfig.getExpirationMs()))
                .sign(Algorithm.HMAC256(jwtConfig.getSecretKey()));
    }

    public boolean validateToken(String token) {
        try {
            JWTVerifier verifier = JWT.require(Algorithm.HMAC256(jwtConfig.getSecretKey())).build();
            verifier.verify(token);
            return true;
        } catch (JWTVerificationException e) {
            return false;
        }
    }

    public String extractUsername(String token) {
        DecodedJWT jwt = JWT.decode(token);
        return jwt.getSubject();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AdminDashboardServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.response.DashboardSummaryResponse;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.repository.RoleRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.AdminDashboardService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.TextStyle;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

@Service
@RequiredArgsConstructor
public class AdminDashboardServiceImpl implements AdminDashboardService {

    private final UserRepository userRepository;
    private final TransactionRepository transactionRepository;
    private final RoleRepository roleRepository;
    private static final BigDecimal PLATFORM_FEE_PERCENTAGE = new BigDecimal("0.10");

    @Override
    public DashboardSummaryResponse getDashboardSummary() {
        Role partnerRole = roleRepository.findByName(UserRole.PARTNER)
                .orElseThrow(() -> new IllegalStateException("Partner role not found in database"));

        long totalUsers = userRepository.count();
        long totalPartners = userRepository.countByRolesContaining(partnerRole);
        long totalTransactions = transactionRepository.count();

        BigDecimal totalRevenue = transactionRepository.sumTotalCostByBookingStatus(BookingStatus.COMPLETED);
        BigDecimal platformRevenue = (totalRevenue != null) ? totalRevenue.multiply(PLATFORM_FEE_PERCENTAGE) : BigDecimal.ZERO;

        LocalDateTime now = LocalDateTime.now();
        List<String> labels = IntStream.range(0, 6)
                .mapToObj(i -> now.minusMonths(i).getMonth())
                .map(month -> month.getDisplayName(TextStyle.SHORT, new Locale("id", "ID")))
                .collect(Collectors.toList());
        java.util.Collections.reverse(labels);

        List<Long> userGrowthData = new ArrayList<>();
        List<Long> partnerGrowthData = new ArrayList<>();

        for (int i = 5; i >= 0; i--) {
            LocalDateTime startOfMonth = now.minusMonths(i).withDayOfMonth(1).withHour(0).withMinute(0).withSecond(0);
            LocalDateTime endOfMonth = startOfMonth.plusMonths(1).minusNanos(1);
            userGrowthData.add(userRepository.countNewUsersBetween(startOfMonth, endOfMonth));
            partnerGrowthData.add(userRepository.countNewUsersWithRoleBetween(partnerRole, startOfMonth, endOfMonth));
        }

        DashboardSummaryResponse.ChartData userGrowth = DashboardSummaryResponse.ChartData.builder()
                .labels(labels)
                .data(userGrowthData)
                .build();
        DashboardSummaryResponse.ChartData partnerGrowth = DashboardSummaryResponse.ChartData.builder()
                .labels(labels)
                .data(partnerGrowthData)
                .build();

        return DashboardSummaryResponse.builder()
                .totalUsers(totalUsers)
                .totalPartners(totalPartners)
                .totalTransactions(totalTransactions)
                .platformRevenue(platformRevenue)
                .userGrowth(userGrowth)
                .partnerGrowth(partnerGrowth)
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AdminSettingServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.entity.SystemConfiguration;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.SystemConfigurationRepository;
import com.doaibu.rebikeapi.service.AdminSettingService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;

@Service
@RequiredArgsConstructor
public class AdminSettingServiceImpl implements AdminSettingService {

    private final SystemConfigurationRepository systemConfigRepository;
    private static final String FEE_KEY = "platform_fee_percentage";

    @Override
    public BigDecimal getPlatformFeePercentage() {
        return new BigDecimal(systemConfigRepository.findById(FEE_KEY)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Platform fee setting not found."))
                .getConfigValue());
    }

    @Override
    public void updatePlatformFeePercentage(BigDecimal newFee) {
        if (newFee.compareTo(BigDecimal.ZERO) < 0 || newFee.compareTo(new BigDecimal("100")) > 0) {
            throw new CustomException.BadRequestException("Fee percentage must be between 0 and 100.");
        }
        BigDecimal feeValue = newFee.divide(new BigDecimal("100"));

        SystemConfiguration feeConfig = systemConfigRepository.findById(FEE_KEY)
                .orElse(SystemConfiguration.builder().configKey(FEE_KEY).build());

        feeConfig.setConfigValue(feeValue.toPlainString());
        systemConfigRepository.save(feeConfig);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AIAssistantServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PayoutStatus;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.entity.Payout;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.repository.PayoutRepository;
import com.doaibu.rebikeapi.repository.SystemConfigurationRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.PayoutService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import com.doaibu.rebikeapi.service.AIAssistantService;

import java.math.BigDecimal;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class AIAssistantServiceImpl implements AIAssistantService{

    private final PayoutRepository payoutRepository;
    private final TransactionRepository transactionRepository;
    private final SystemConfigurationRepository systemConfigRepository;
    private final PayoutService payoutService;

    @Override
    @Scheduled(cron = "0 */15 * * * *")
    public void autoProcessPendingPayouts() {
        log.info("[AI Assistant] Running job: Auto Process Pending Payouts...");
        List<Payout> pendingPayouts = payoutRepository.findAllByStatus(PayoutStatus.PENDING);

        if (pendingPayouts.isEmpty()) {
            log.info("[AI Assistant] No pending payouts to process.");
            return;
        }

        log.info("[AI Assistant] Found {} pending payout(s).", pendingPayouts.size());

        for (Payout payout : pendingPayouts) {
            try {
                User partner = payout.getPartner();
                BigDecimal requestedAmount = payout.getAmount();

                BigDecimal availableBalance = calculateAvailableBalance(partner);

                if (requestedAmount.compareTo(availableBalance) <= 0) {
                    ProcessPayoutRequest processRequest = new ProcessPayoutRequest();
                    processRequest.setStatus(PayoutStatus.APPROVED);
                    processRequest.setNotes("Auto-approved by AI Assistant. Balance sufficient.");
                    payoutService.processPayout(payout.getId(), processRequest);
                    log.info("[AI Assistant] Auto-approved payout ID: {} for partner: {}", payout.getId(), partner.getUsername());
                } else {
                    ProcessPayoutRequest processRequest = new ProcessPayoutRequest();
                    processRequest.setStatus(PayoutStatus.REJECTED);
                    processRequest.setNotes("Auto-rejected by AI Assistant. Insufficient balance. Available: " + availableBalance);
                    payoutService.processPayout(payout.getId(), processRequest);
                    log.info("[AI Assistant] Auto-rejected payout ID: {} for partner: {}. Reason: Insufficient balance.", payout.getId(), partner.getUsername());
                }
            } catch (Exception e) {
                log.error("[AI Assistant] Error processing payout ID: {}. Error: {}", payout.getId(), e.getMessage());
            }
        }
    }

    private BigDecimal calculateAvailableBalance(User partner) {
        BigDecimal totalRevenue = transactionRepository.findByBike_Partner(partner).stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .map(Transaction::getTotalCost)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal platformFeePercentage = new BigDecimal(
                systemConfigRepository.findById("platform_fee_percentage")
                        .orElseThrow(() -> new IllegalStateException("Platform fee not configured."))
                        .getConfigValue()
        );

        BigDecimal totalFee = totalRevenue.multiply(platformFeePercentage);
        BigDecimal netRevenue = totalRevenue.subtract(totalFee);

        List<Payout> partnerPayouts = payoutRepository.findByPartnerOrderByRequestedAtDesc(partner);
        BigDecimal totalPaidOutOrPending = partnerPayouts.stream()
                .filter(p -> p.getStatus() == PayoutStatus.APPROVED || p.getStatus() == PayoutStatus.PROCESSING || p.getStatus() == PayoutStatus.PENDING)
                .map(Payout::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        return netRevenue.subtract(totalPaidOutOrPending);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AuthServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.LoginResponse;
import com.doaibu.rebikeapi.dto.response.RegisterResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.security.JwtUtil;
import com.doaibu.rebikeapi.service.*;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.apache.commons.text.similarity.FuzzyScore;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.security.SecureRandom;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class AuthServiceImpl implements AuthService {

    private static final Logger logger = LoggerFactory.getLogger(AuthServiceImpl.class);

    private final UserRepository userRepository;
    private final RoleService roleService;
    private final PasswordEncoder passwordEncoder;
    private final EmailService emailService;
    private final JwtUtil jwtUtil;
    private final NotificationService notificationService;
    private final UserService userService;
    private final Random random = new SecureRandom();

    @Value("${app.user.default-photo-url}")
    private String defaultPhotoUrl;

    @Override
    @Transactional
    public RegisterResponse registerCustomer(RegisterCustomerRequest request) {
        try {
            if (request.getEmail() == null || request.getEmail().isBlank() ||
                    request.getPassword() == null || request.getPassword().isBlank()) {
                throw new CustomException.BadRequestException("Email and password are required.");
            }

            if (userRepository.existsByEmail(request.getEmail())) {
                throw new CustomException.ConflictException("Email already in use.");
            }

            if (userRepository.existsByUsername(request.getUsername())) {
                throw new CustomException.ConflictException("Username already in use.");
            }

            Set<Role> customerRole = new HashSet<>();
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));
            User user = buildUser(request.getFirstName(), request.getLastName(), request.getUsername(), request.getEmail(), request.getPassword(), request.getPhoneNumber(), customerRole);
            User savedUser = userRepository.save(user);
            return mapToRegisterResponse(savedUser);
        } catch (CustomException.BadRequestException e) {
            logger.error("Failed to send verification email for {}. Rolling back transaction.", request.getEmail());
            throw e;
        }
    }

    @Override
    @Transactional
    public RegisterResponse registerPartner(RegisterPartnerRequest request) {
        User savedUser;
        try {
            if (request.getEmail() == null || request.getEmail().isBlank() ||
                    request.getPassword() == null || request.getPassword().isBlank()) {
                throw new CustomException.BadRequestException("Email and password are required.");
            }

            if (userRepository.existsByEmail(request.getEmail())) {
                throw new CustomException.ConflictException("Email already in use.");
            }
            if (userRepository.existsByUsername(request.getUsername())) {
                throw new CustomException.ConflictException("Username already in use.");
            }

            Set<Role> partnerRole = new HashSet<>();
            partnerRole.add(roleService.getOrCreate(UserRole.PARTNER));
            User user = buildUser(
                    request.getFirstName(), request.getLastName(), request.getUsername(),
                    request.getEmail(), request.getPassword(), request.getPhoneNumber(),
                    partnerRole
            );
            Partner partner = Partner.builder()
                    .user(user)
                    .isVerified(false)
                    .locationName(request.getLocationName())
                    .bankAccountName(request.getBankAccountName())
                    .bankAccountNumber(request.getBankAccountNumber())
                    .bankName(request.getBankName())
                    .build();
            user.setPartnerDetail(partner);
            savedUser = userRepository.save(user);

            Partner partnerDetail = savedUser.getPartnerDetail();
            if (isPartnerDataTrustworthy(savedUser, partnerDetail)) {
                userService.verifyPartner(savedUser.getId(), true);
                logger.info("[AI Assistant] Auto-verified partner: {}", savedUser.getEmail());
            }

        } catch (CustomException.BadRequestException e) {
            logger.error("Failed to send verification email for partner {}. Rolling back transaction.", request.getEmail());
            throw e;
        }

        try {
            List<User> admins = userRepository.findAllByRoles_Name(UserRole.ADMIN);
            for (User admin : admins) {
                if (admin.getFcmToken() != null && !admin.getFcmToken().isEmpty()) {
                    String locationName = savedUser.getPartnerDetail() != null ?
                            savedUser.getPartnerDetail().getLocationName() : "N/A";
                    notificationService.sendNotification(
                            admin.getFcmToken(),
                            "🆕 Pendaftaran Mitra Baru",
                            "Mitra '" + locationName + "' telah mendaftar dan menunggu verifikasi.",
                            Map.of("partnerId", savedUser.getId(), "screen", "PartnerVerification")
                    );
                }
            }
        } catch (Exception e) {
            System.err.println("Gagal mengirim notifikasi pendaftaran mitra ke admin: " + e.getMessage());
        }

        return mapToRegisterResponse(savedUser);
    }

    private boolean isPartnerDataTrustworthy(User user, Partner partner) {
        if (user == null || partner == null) {
            return false;
        }

        if (partner.getBankName() == null || partner.getBankAccountNumber() == null || partner.getBankAccountName() == null) {
            return false;
        }

        FuzzyScore fuzzyScore = new FuzzyScore(Locale.ENGLISH);
        String fullName = (user.getFirstName() + " " + user.getLastName()).toLowerCase();
        String bankAccountName = partner.getBankAccountName().toLowerCase();

        Integer score = fuzzyScore.fuzzyScore(fullName, bankAccountName);

        if (score < 15) {
            logger.warn("[AI Assistant] Partner verification check failed for {}. Reason: Name mismatch (Score: {})", user.getEmail(), score);
            return false;
        }

        logger.info("[AI Assistant] Partner verification check passed for {}. Name match score: {}", user.getEmail(), score);
        return true;
    }

    @Override
    @Transactional
    public void verifyEmailOtp(String email, String otp) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (user.isEmailVerified()) {
            throw new CustomException.BadRequestException("Email has been verified.");
        }
        if (user.getOtpExpiryTime().isBefore(LocalDateTime.now())) {
            throw new CustomException.BadRequestException("OTP code has expired.");
        }
        if (!passwordEncoder.matches(otp, user.getVerificationOtp())) {
            throw new CustomException.BadRequestException("OTP code does not match.");
        }

        user.setEmailVerified(true);
        user.setEnabled(true);
        user.setVerificationOtp(null);
        user.setOtpExpiryTime(null);
        userRepository.save(user);
    }

    @Override
    @Transactional
    public void resendVerificationOtp(String email) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (user.isEmailVerified()) {
            throw new CustomException.BadRequestException("Email has been verified.");
        }
        String newOtp = generateOtp();
        user.setVerificationOtp(passwordEncoder.encode(newOtp));
        user.setOtpExpiryTime(LocalDateTime.now().plusMinutes(10));
        userRepository.save(user);
        sendVerificationEmail(user, newOtp);
    }

    @Override
    public LoginResponse login(LoginRequest request) {
        User user = userRepository.findByEmail(request.getEmail())
                .orElseThrow(() -> new CustomException.AuthenticationException("Email or password is incorrect."));
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new CustomException.AuthenticationException("Email or password is incorrect.");
        }
        if (!user.isEmailVerified()) {
            throw new CustomException.AuthorizationException("Email is not verified. Please try again.");
        }
        if (!user.isEnabled()) {
            throw new CustomException.AuthorizationException("Your account is disabled.");
        }

        String token = jwtUtil.generateToken(user);
        return LoginResponse.builder()
                .roles(user.getRoles().stream().map(Role::getName).collect(Collectors.toSet()))
                .token(token)
                .build();
    }

    @Override
    @Transactional
    public void processForgotPassword(String email, String feBaseUrl) {
        userRepository.findByEmail(email).ifPresent(user -> {
            String otp = generateOtp();
            user.setResetPasswordToken(passwordEncoder.encode(otp));
            user.setResetPasswordTokenExpiry(LocalDateTime.now().plusMinutes(10));
            userRepository.save(user);

            String emailText = "Anda menerima email ini karena ada permintaan untuk mereset password akun Rebike Anda.\n\n"
                    + "Gunakan kode OTP ini untuk melanjutkan: \n\n"
                    + "Kode OTP: " + otp + "\n\n"
                    + "PENTING: Kode ini hanya berlaku selama 10 menit. Jika Anda tidak meminta ini, abaikan email ini.";

            emailService.sendEmail(user.getEmail(), "Reset Password Rebike (Berlaku 10 Menit)", emailText);
        });
    }

    @Override
    @Transactional
    public void resetPasswordWithOtp(ResetPasswordWithOtpRequest request) {
        User user = userRepository.findByEmail(request.getEmail())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (user.getResetPasswordToken() == null || user.getResetPasswordTokenExpiry().isBefore(LocalDateTime.now())) {
            throw new CustomException.BadRequestException("OTP code has expired.");
        }
        if (!passwordEncoder.matches(request.getOtp(), user.getResetPasswordToken())) {
            throw new CustomException.BadRequestException("OTP code does not match.");
        }
        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        user.setResetPasswordToken(null);
        user.setResetPasswordTokenExpiry(null);
        userRepository.save(user);
    }

    @Override
    @Transactional
    public User processOAuthPostLogin(String email, String name) {
        return userRepository.findByEmail(email).orElseGet(() -> {
            Set<Role> customerRole = new HashSet<>();
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));

            User newUser = User.builder()
                    .email(email).username(email).firstName(name)
                    .password(passwordEncoder.encode(UUID.randomUUID().toString()))
                    .roles(customerRole).createdAt(LocalDateTime.now())
                    .isAccountNonExpired(true).isAccountNonLocked(true).isCredentialsNonExpired(true)
                    .isEnabled(true).isEmailVerified(true)
                    .build();

            return userRepository.save(newUser);
        });
    }

    private String generateOtp() {
        return String.format("%06d", random.nextInt(999999));
    }

    private void sendVerificationEmail(User user, String otp) {
        String emailText = "Gunakan kode OTP ini untuk verifikasi email Rebike Anda.\n\n"
                + "Kode OTP: " + otp + "\n\n"
                + "PENTING: Kode ini hanya berlaku selama 10 menit. Jangan berikan kode ini kepada siapapun.";
        emailService.sendEmail(user.getEmail(), "Verifikasi Email Rebike (Berlaku 10 Menit)", emailText);
    }

    private User buildUser(String firstName, String lastName, String username, String email, String password, String phoneNumber, Set<Role> roles) {
        String otp = generateOtp();
        User user = User.builder()
                .firstName(firstName).lastName(lastName)
                .username(username).email(email)
                .password(passwordEncoder.encode(password))
                .phoneNumber(phoneNumber)
                .photoUrl(defaultPhotoUrl)
                .roles(roles).createdAt(LocalDateTime.now())
                .isAccountNonExpired(true).isAccountNonLocked(true).isCredentialsNonExpired(true)
                .isEnabled(false).isEmailVerified(false)
                .verificationOtp(passwordEncoder.encode(otp))
                .otpExpiryTime(LocalDateTime.now().plusMinutes(10))
                .build();
        sendVerificationEmail(user, otp);
        return user;
    }

    private RegisterResponse mapToRegisterResponse(User user) {
        return RegisterResponse.builder()
                .userID(user.getId())
                .email(user.getEmail())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/BikeServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.dto.request.BikeRequest;
import com.doaibu.rebikeapi.dto.response.BikeDetailResponse;
import com.doaibu.rebikeapi.dto.response.BikeResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.Bike;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.BikeRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.BikeService;
import com.doaibu.rebikeapi.service.CloudinaryService;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class BikeServiceImpl implements BikeService {

    private final BikeRepository bikeRepository;
    private final UserRepository userRepository;
    private final CloudinaryService cloudinaryService;
    private final TokenHolder tokenHolder;

    private final long maxSize = 5 * 1024 * 1024;

    @Override
    @Transactional
    public BikeResponse addBike(BikeRequest request, MultipartFile file) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (partner.getPartnerDetail() == null || !partner.getPartnerDetail().isVerified()) {
            throw new CustomException.AuthorizationException("Your partner account is not verified. Please contact administrator.");
        }

        if (file.getSize() > maxSize) {
            throw new CustomException.BadRequestException("File size exceeds 5MB limit.");
        }

        String fileName = file.getOriginalFilename();
        if (!fileName.endsWith(".jpg") && !fileName.endsWith(".jpeg") && !fileName.endsWith(".png")) {
            throw new CustomException.BadRequestException("Only JPG/PNG files are allowed.");
        }

        String url = cloudinaryService.uploadFile(file, "bikes");

        Bike bike = mapToBike(request);
        bike.setPartner(partner);
        bike.setStatus(BikeStatus.AVAILABLE);
        bike.setPhotoURL(url);
        bikeRepository.save(bike);
        return mapToBikeResponse(bike);
    }

    @Override
    public PagedResponse<BikeResponse> getAllBikes(Pageable pageable) {
        Page<Bike> bikePage = bikeRepository.findAll(pageable);
        List<BikeResponse> bikeResponses = bikePage.getContent().stream()
                .map(this::mapToBikeResponse)
                .collect(Collectors.toList());
        return PagedResponse.<BikeResponse>builder()
                .data(bikeResponses)
                .page(bikePage.getNumber())
                .size(bikePage.getSize())
                .totalElements(bikePage.getTotalElements())
                .totalPages(bikePage.getTotalPages())
                .build();
    }

    @Override
    public PagedResponse<BikeResponse> getAllMyBikes(Pageable pageable) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (!partner.getPartnerDetail().isVerified()) {
            throw new CustomException.AuthorizationException("Your partner account is not verified. Please contact administrator.");
        }

        Page<Bike> bikePage = bikeRepository.findByPartner(partner, pageable);
        List<BikeResponse> bikeResponses = bikePage.getContent().stream()
                .map(this::mapToBikeResponse)
                .collect(Collectors.toList());
        return PagedResponse.<BikeResponse>builder()
                .data(bikeResponses)
                .page(bikePage.getNumber())
                .size(bikePage.getSize())
                .totalElements(bikePage.getTotalElements())
                .totalPages(bikePage.getTotalPages())
                .build();
    }

    @Override
    public BikeDetailResponse getBikeById(String id) {
        Bike bike = bikeRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));
        return mapToBikeDetailResponse(bike);
    }

    @Override
    @Transactional
    public BikeResponse updateBike(String id, BikeRequest request) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Bike bike = bikeRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));

        if (!Objects.equals(bike.getPartner().getId(), partner.getId())) {
            throw new CustomException.AuthorizationException("You are not authorized to modify this bike.");
        }

        bike.setName(request.getName());
        bike.setPhotoURL(request.getPhotoURL());
        bike.setBrand(request.getBrand());
        bike.setPlateNumber(request.getPlateNumber());
        bike.setYear(request.getYear());
        bike.setMachineCapacity(request.getMachineCapacity());
        bike.setTransmissionType(request.getTransmissionType());
        bike.setWeekdayPricePerDay(request.getWeekdayPricePerDay());
        bike.setWeekendPricePerDay(request.getWeekendPricePerDay());
        bikeRepository.save(bike);
        return mapToBikeResponse(bike);
    }

    @Override
    @Transactional
    public BikeResponse updateBikeStatus(String bikeId, BikeStatus status) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Bike bike = bikeRepository.findById(bikeId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));
        if (!Objects.equals(bike.getPartner().getId(), partner.getId())) {
            throw new CustomException.AuthorizationException("You are not authorized to modify this bike.");
        }

        bike.setStatus(status);
        bikeRepository.save(bike);
        return mapToBikeResponse(bike);
    }

    @Override
    @Transactional
    public void deleteBike(String id) {
        Bike bike = bikeRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));
        bikeRepository.delete(bike);
    }

    private Bike mapToBike(BikeRequest request) {
        return Bike.builder()
                .name(request.getName())
                .photoURL(request.getPhotoURL())
                .brand(request.getBrand())
                .plateNumber(request.getPlateNumber())
                .year(request.getYear())
                .machineCapacity(request.getMachineCapacity())
                .transmissionType(request.getTransmissionType())
                .weekdayPricePerDay(request.getWeekdayPricePerDay())
                .weekendPricePerDay(request.getWeekendPricePerDay())
                .build();
    }

    private BikeResponse mapToBikeResponse(Bike bike) {
        return BikeResponse.builder()
                .bikeID(bike.getId())
                .name(bike.getName())
                .photoURL(bike.getPhotoURL())
                .brand(bike.getBrand())
                .weekdayPricePerDay(bike.getWeekdayPricePerDay())
                .build();
    }

    private BikeDetailResponse mapToBikeDetailResponse(Bike bike) {
        return BikeDetailResponse.builder()
                .bikeID(bike.getId())
                .name(bike.getName())
                .photoURL(bike.getPhotoURL())
                .brand(bike.getBrand())
                .plateNumber(bike.getPlateNumber())
                .year(bike.getYear())
                .transmissionType(bike.getTransmissionType())
                .machineCapacity(bike.getMachineCapacity())
                .weekdayPricePerDay(bike.getWeekdayPricePerDay())
                .weekendPricePerDay(bike.getWeekendPricePerDay())
                .status(bike.getStatus())
                .usagePolicies(
                        bike.getUsagePolicies().stream()
                                .map(policy -> BikeDetailResponse.UsagePolicyResponse.builder()
                                        .policyID(policy.getId())
                                        .policyName(policy.getPolicyName())
                                        .description(policy.getDescription())
                                        .isPermitted(policy.isPermitted())
                                        .build())
                                .collect(Collectors.toSet()))
                .partner(BikeDetailResponse.PartnerInfo.builder()
                        .locationName(bike.getPartner().getPartnerDetail().getLocationName())
                        .isVerified(bike.getPartner().getPartnerDetail().isVerified())
                        .build())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/BusinessInsightServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.response.BusinessRecommendationResponse;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.BusinessInsightService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class BusinessInsightServiceImpl implements BusinessInsightService {

    private final UserRepository userRepository;

    @Override
    public List<BusinessRecommendationResponse> generateRecommendations() {
        List<BusinessRecommendationResponse> recommendations = new ArrayList<>();

        long thisMonthUsers = userRepository.countNewUsersBetween(
                LocalDateTime.now().withDayOfMonth(1).toLocalDate().atStartOfDay(),
                LocalDateTime.now()
        );
        long lastMonthUsers = userRepository.countNewUsersBetween(
                LocalDateTime.now().minusMonths(1).withDayOfMonth(1).toLocalDate().atStartOfDay(),
                LocalDateTime.now().withDayOfMonth(1).toLocalDate().atStartOfDay().minusNanos(1)
        );

        if (lastMonthUsers > 0 && ((double)thisMonthUsers / lastMonthUsers) < 0.85) { // Pertumbuhan < 85% (turun > 15%)
            recommendations.add(BusinessRecommendationResponse.builder()
                    .recommendation("Lakukan promosi untuk pengguna baru.")
                    .reason("Pertumbuhan pengguna baru bulan ini melambat signifikan dibandingkan bulan lalu.")
                    .severity("HIGH")
                    .build());
        }

        if(recommendations.isEmpty()){
            recommendations.add(BusinessRecommendationResponse.builder()
                    .recommendation("Semua metrik terlihat baik.")
                    .reason("Tidak ada anomali negatif yang terdeteksi pada metrik utama.")
                    .severity("LOW")
                    .build());
        }

        return recommendations;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/CloudinaryServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.cloudinary.Cloudinary;
import com.doaibu.rebikeapi.service.CloudinaryService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class CloudinaryServiceImpl implements CloudinaryService {

    private final Cloudinary cloudinary;

    @Override
    public String uploadFile(MultipartFile file, String folder) {
        try {
            Map<?, ?> result = cloudinary.uploader().upload(file.getBytes(),
                    Map.of("folder", folder));
            return (String) result.get("secure_url");
        } catch (IOException e) {
            throw new RuntimeException("Upload to Cloudinary failed", e);
        }
    }

    @Override
    public void deleteByPublicId(String publicId) {
        try {
            cloudinary.uploader().destroy(publicId, Map.of());
        } catch (IOException e) {
            throw new RuntimeException("Failed to delete file from Cloudinary", e);
        }
    }
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/EmailServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.EmailService;
import lombok.RequiredArgsConstructor;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class EmailServiceImpl implements EmailService {

    private final JavaMailSender mailSender;

    @Override
    public void sendEmail(String to, String subject, String text) {
        try {
            SimpleMailMessage message = new SimpleMailMessage();
            message.setTo(to);
            message.setSubject(subject);
            message.setText(text);
            mailSender.send(message);
        } catch (Exception e) {
            throw new CustomException.BadRequestException("Failed to send verification email, please try again later.");
        }
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/FraudDetectionServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.response.FlaggedTransactionResponse;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.FraudDetectionService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class FraudDetectionServiceImpl implements FraudDetectionService {

    private final TransactionRepository transactionRepository;
    private static final int RENTAL_FREQUENCY_THRESHOLD = 3;
    private static final int RENTAL_FREQUENCY_HOURS = 24;

    @Override
    @Scheduled(cron = "0 0 */1 * * *")
    public void detectAnomalies() {
        log.info("[AI Assistant] Running job: Fraud Detection...");

        LocalDateTime thresholdTime = LocalDateTime.now().minusHours(RENTAL_FREQUENCY_HOURS);

        List<Transaction> recentTransactions = transactionRepository.findAllByCreatedAtAfter(thresholdTime);

        Map<String, List<Transaction>> transactionsByUser = recentTransactions.stream()
                .collect(Collectors.groupingBy(tx -> tx.getCustomer().getId()));

        for (Map.Entry<String, List<Transaction>> entry : transactionsByUser.entrySet()) {
            if (entry.getValue().size() > RENTAL_FREQUENCY_THRESHOLD) {
                log.warn("[AI Assistant] Potential fraud detected for user ID: {}. Found {} rentals in the last {} hours.",
                        entry.getKey(), entry.getValue().size(), RENTAL_FREQUENCY_HOURS);

                for (Transaction tx : entry.getValue()) {
                    tx.setFlaggedAsPotentialFraud(true);
                    tx.setFraudFlagReason("Frequent rentals (" + entry.getValue().size() + "x in " + RENTAL_FREQUENCY_HOURS + "h) by user.");
                    transactionRepository.save(tx);
                }
            }
        }

        log.info("[AI Assistant] Fraud Detection job finished.");
    }

    @Override
    public List<FlaggedTransactionResponse> getFlaggedTransactions() {
        return transactionRepository.findAllByIsFlaggedAsPotentialFraud(true).stream()
                .map(tx -> FlaggedTransactionResponse.builder()
                        .transactionId(tx.getId())
                        .customerName(tx.getCustomer().getFirstName() + " " + tx.getCustomer().getLastName())
                        .bikeName(tx.getBike().getName())
                        .transactionDate(tx.getCreatedAt())
                        .totalCost(tx.getTotalCost())
                        .reason(tx.getFraudFlagReason())
                        .build())
                .collect(Collectors.toList());
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/MidtransServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.PaymentStatus;
import com.doaibu.rebikeapi.dto.request.CreatePaymentRequest;
import com.doaibu.rebikeapi.dto.response.MidtransChargeResponse;
import com.doaibu.rebikeapi.entity.Payment;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PaymentRepository;
import com.doaibu.rebikeapi.config.MidtransConfig;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.MidtransService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class MidtransServiceImpl implements MidtransService {

    private final PaymentRepository paymentRepository;
    private final MidtransConfig config;
    private final RestTemplate restTemplate;
    private final TransactionRepository transactionRepository;

    public MidtransChargeResponse createTransaction(CreatePaymentRequest request) {
        /** For integration with FE
         String base64Key = Base64.getEncoder().encodeToString((config.getServerKey() + ":").getBytes());
         HttpHeaders headers = new HttpHeaders();
         headers.setContentType(MediaType.APPLICATION_JSON);
         headers.set("Authorization", "Basic " + base64Key);

         Map<String, Object> payload = new HashMap<>();

         payload.put("payment_type", "bank_transfer");

         Map<String, Object> transactionDetails = Map.of(
         "order_id", request.getOrderId(),
         "gross_amount", request.getGrossAmount()
         );
         Map<String, Object> customerDetails = Map.of(
         "name", request.getCustomerName(),
         "email", request.getCustomerEmail()
         );

         payload.put("transaction_details", transactionDetails);
         payload.put("customer_details", customerDetails);

         HttpEntity<Map<String, Object>> entity = new HttpEntity<>(payload, headers);
         ResponseEntity<MidtransChargeResponse> response = restTemplate.exchange(
         config.getApiUrl(),
         HttpMethod.POST,
         entity,
         MidtransChargeResponse.class
         );

         return response.getBody();*/

        String base64Key = Base64.getEncoder().encodeToString((config.getServerKey() + ":").getBytes());
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("Authorization", "Basic " + base64Key);

        Map<String, Object> payload = new HashMap<>();

        Map<String, Object> transactionDetails = Map.of(
                "order_id", request.getOrderId(),
                "gross_amount", request.getGrossAmount()
        );

        Map<String, Object> customerDetails = Map.of(
                "name", request.getCustomerName(),
                "email", request.getCustomerEmail()
        );

        Map<String, Object> bankTransfer = Map.of("bank", request.getBank());

        payload.put("payment_type", "bank_transfer");
        payload.put("transaction_details", transactionDetails);
        payload.put("customer_details", customerDetails);
        payload.put("bank_transfer", bankTransfer);

        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(payload, headers);
        ResponseEntity<MidtransChargeResponse> response = restTemplate.exchange(
                config.getApiUrl(),
                HttpMethod.POST,
                entity,
                MidtransChargeResponse.class
        );

        return response.getBody();
    }

    @Override
    public void handleWebhook(Map<String, Object> payload) {
        String orderId = (String) payload.get("order_id");
        String paymentType = (String) payload.get("payment_type");
        String trxStatus = (String) payload.get("transaction_status");
        BigDecimal amount = new BigDecimal((String) payload.get("gross_amount"));

        Payment payment = paymentRepository.findByOrderId(orderId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Payment not found."));

        PaymentStatus status = null;
        if ("settlement".equals(trxStatus)) {
            status = PaymentStatus.PAID;
        } else if ("expired".equals(trxStatus)) {
            status = PaymentStatus.EXPIRED;
        } else if ("cancelled".equals(trxStatus)) {
            status = PaymentStatus.CANCELLED;
        }

        payment.setOrderId(orderId);
        payment.setPaymentType(paymentType);
        payment.setStatus(status);
        payment.setAmount(amount);
        payment.setUpdatedAt(LocalDateTime.now());
        paymentRepository.save(payment);

        Transaction transaction = payment.getTransaction();
        transaction.setPaymentStatus(status);
        transactionRepository.save(transaction);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/NotificationServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.service.NotificationService;
import com.google.firebase.messaging.FirebaseMessaging;
import com.google.firebase.messaging.FirebaseMessagingException;
import com.google.firebase.messaging.Message;
import com.google.firebase.messaging.Notification;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
@RequiredArgsConstructor
public class NotificationServiceImpl implements NotificationService {

    private final FirebaseMessaging firebaseMessaging;

    @Override
    public void sendNotification(String token, String title, String body, Map<String, String> data) {
        Notification notification = Notification.builder()
                .setTitle(title)
                .setBody(body)
                .build();

        Message message = Message.builder()
                .setToken(token)
                .setNotification(notification)
                .putAllData(data)
                .build();

        try {
            firebaseMessaging.send(message);
            System.out.println("Successfully sent message to token: " + token);
        } catch (FirebaseMessagingException e) {
            System.err.println("Failed to send notification: " + e.getMessage());
        }
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/PartnerServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.request.PartnerDetailUpdateRequest;
import com.doaibu.rebikeapi.dto.request.PartnerUpdateRequest;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PartnerRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.PartnerService;
import com.doaibu.rebikeapi.util.TokenHolder;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
@RequiredArgsConstructor
public class PartnerServiceImpl implements PartnerService {

    private final PartnerRepository partnerRepository;
    private final UserRepository userRepository;
    private final TokenHolder tokenHolder;

    @Override
    public void updatePartnerProfile(PartnerDetailUpdateRequest request) {
        String username = tokenHolder.getUsername();
        Optional<User> userOptional = userRepository.findByUsername(username);

        if (userOptional.isPresent()) {
            User user = userOptional.get();
            Optional<Partner> partnerOptional = partnerRepository.findByUser(user);

            if (partnerOptional.isPresent()) {
                Partner partner = partnerOptional.get();

                partner.setLocationName(request.getLocationName());
                partnerRepository.save(partner);
            } else {
                throw new CustomException.ResourceNotFoundException("Partner not found for the authenticated user.");
            }
        } else {
            throw new CustomException.ResourceNotFoundException("User not found.");
        }
    }

    @Override
    public PartnerDetailResponse getBankInformation() {
        String username = tokenHolder.getUsername();
        Optional<User> userOptional = userRepository.findByUsername(username);

        if (userOptional.isPresent()) {
            User user = userOptional.get();
            Optional<Partner> partnerOptional = partnerRepository.findByUser(user);

            if (partnerOptional.isPresent()) {
                Partner partner = partnerOptional.get();

                return PartnerDetailResponse.builder()
                        .bankName(partner.getBankName())
                        .bankAccountName(partner.getBankAccountName())
                        .bankAccountNumber(partner.getBankAccountNumber())
                        .isVerified(partner.isVerified())
                        .build();
            } else {
                throw new CustomException.ResourceNotFoundException("Partner not found for the authenticated user.");
            }
        } else {
            throw new CustomException.ResourceNotFoundException("User not found.");
        }
    }

    @Override
    public void updateBankInformation(PartnerUpdateRequest request) {
        String username = tokenHolder.getUsername();
        Optional<User> userOptional = userRepository.findByUsername(username);

        if (userOptional.isPresent()) {
            User user = userOptional.get();
            Optional<Partner> partnerOptional = partnerRepository.findByUser(user);

            if (partnerOptional.isPresent()) {
                Partner partner = partnerOptional.get();
                
                partner.setBankName(request.getBankName());
                partner.setBankAccountName(request.getBankAccountName());
                partner.setBankAccountNumber(request.getBankAccountNumber());
                partnerRepository.save(partner);
            } else {
                throw new CustomException.ResourceNotFoundException("Partner not found for the authenticated user.");
            }
        } else {
            throw new CustomException.ResourceNotFoundException("User not found.");
        }
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/PayoutServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PayoutStatus;
import com.doaibu.rebikeapi.dto.request.PayoutRequest;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.dto.response.PayoutResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.Payout;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PayoutRepository;
import com.doaibu.rebikeapi.repository.SystemConfigurationRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.PayoutService;
import com.doaibu.rebikeapi.util.TokenHolder;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.beans.factory.annotation.Value;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class PayoutServiceImpl implements PayoutService {

    private final PayoutRepository payoutRepository;
    private final UserRepository userRepository;
    private final TransactionRepository transactionRepository;
    private final TokenHolder tokenHolder;
    private final SystemConfigurationRepository systemConfigRepository;

    @Value("${app.payout.min-amount}")
    private BigDecimal minPayoutAmount;

    @Override
    public List<PayoutResponse> getAllPayouts() {
        return payoutRepository.findAll().stream()
                .map(this::mapToPayoutResponse)
                .collect(Collectors.toList());
    }

    @Override
    public List<PayoutResponse> getPayoutsForPartner() {
        User partnerUser = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        return payoutRepository.findByPartnerOrderByRequestedAtDesc(partnerUser).stream()
                .map(this::mapToPayoutResponse)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional
    public PayoutResponse requestPayout(PayoutRequest request) {
        User partnerUser = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Partner partnerDetails = partnerUser.getPartnerDetail();

        if (!partnerDetails.isVerified()) {
            throw new CustomException.AuthorizationException("Akun Anda harus terverifikasi untuk dapat mengajukan pencairan dana.");
        }

        if (partnerDetails.getBankName() == null || partnerDetails.getBankAccountNumber() == null) {
            throw new CustomException.BadRequestException("Bank information is incomplete. Please complete it in your profile.");
        }

        BigDecimal platformFeePercentage = new BigDecimal(
                systemConfigRepository.findById("platform_fee_percentage")
                        .orElseThrow(() -> new IllegalStateException("Platform fee not configured."))
                        .getConfigValue()
        );
        BigDecimal totalRevenue = transactionRepository.findByBike_Partner(partnerUser).stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .map(Transaction::getTotalCost)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal totalFee = totalRevenue.multiply(platformFeePercentage);
        BigDecimal netRevenue = totalRevenue.subtract(totalFee);

        List<Payout> partnerPayouts = payoutRepository.findByPartnerOrderByRequestedAtDesc(partnerUser);

        BigDecimal totalPaidOut = partnerPayouts.stream()
                .filter(p -> p.getStatus() == PayoutStatus.APPROVED)
                .map(Payout::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal totalPendingOrProcessing = partnerPayouts.stream()
                .filter(p -> p.getStatus() == PayoutStatus.PENDING || p.getStatus() == PayoutStatus.PROCESSING)
                .map(Payout::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal availableBalance = netRevenue.subtract(totalPaidOut).subtract(totalPendingOrProcessing);

        if (request.getAmount().compareTo(availableBalance) > 0) {
            throw new CustomException.BadRequestException("The withdrawal amount exceeds the available balance. Balance is IDR " + availableBalance);
        }

        if (request.getAmount().compareTo(minPayoutAmount) < 0) {
            throw new CustomException.BadRequestException("The minimum withdrawal amount is IDR " + minPayoutAmount);
        }

        String bankDetails = String.format("%s - %s a/n %s",
                partnerDetails.getBankName(),
                partnerDetails.getBankAccountNumber(),
                partnerDetails.getBankAccountName());
        Payout payout = Payout.builder()
                .partner(partnerUser)
                .amount(request.getAmount())
                .status(PayoutStatus.PENDING)
                .requestedAt(LocalDateTime.now())
                .bankDetailsSnapshot(bankDetails)
                .build();
        payoutRepository.save(payout);
        return mapToPayoutResponse(payout);
    }

    @Override
    @Transactional
    public void processPayout(String payoutId, ProcessPayoutRequest request) {
        Payout payout = payoutRepository.findById(payoutId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Payout request not found."));
        if (payout.getStatus() != PayoutStatus.PENDING) {
            throw new CustomException.BadRequestException("This payout has already been processed.");
        }

        if (request.getStatus() == PayoutStatus.APPROVED) {
            payout.setStatus(PayoutStatus.APPROVED);
            payout.setNotes(request.getNotes() != null ? request.getNotes() : "Approved manually by admin.");
        } else if (request.getStatus() == PayoutStatus.REJECTED) {
            payout.setStatus(PayoutStatus.REJECTED);
            payout.setNotes(request.getNotes());
        } else {
            payout.setStatus(request.getStatus());
            payout.setNotes(request.getNotes());
        }


        payout.setProcessedAt(LocalDateTime.now());
        payoutRepository.save(payout);
    }

    private PayoutResponse mapToPayoutResponse(Payout payout) {
        return PayoutResponse.builder()
                .id(payout.getId())
                .partnerName(payout.getPartner().getFirstName())
                .amount(payout.getAmount())
                .status(payout.getStatus())
                .requestedAt(payout.getRequestedAt())
                .processedAt(payout.getProcessedAt())
                .bankDetailsSnapshot(payout.getBankDetailsSnapshot())
                .notes(payout.getNotes())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/PickupPointServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.request.PickupPointRequest;
import com.doaibu.rebikeapi.dto.response.PickupPointResponse;
import com.doaibu.rebikeapi.entity.PickupPoint;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PickupPointRepository;
import com.doaibu.rebikeapi.service.PickupPointService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class PickupPointServiceImpl implements PickupPointService {

    private final PickupPointRepository pickupPointRepository;

    @Override
    public PickupPointResponse createPickupPoint(PickupPointRequest request) {
        PickupPoint pickupPoint = PickupPoint.builder()
                .locationName(request.getLocationName())
                .address(request.getAddress())
                .build();

        pickupPointRepository.save(pickupPoint);
        return mapToPickupPointResponse(pickupPoint);
    }

    @Override
    public List<PickupPointResponse> getAllPickupPoints() {
        return pickupPointRepository.findAll().stream()
                .map(this::mapToPickupPointResponse)
                .collect(Collectors.toList());
    }

    @Override
    public PickupPointResponse updatePickupPoint(String id, PickupPointRequest request) {
        PickupPoint pickupPoint = pickupPointRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Pickup point not found."));

        pickupPoint.setLocationName(request.getLocationName());
        pickupPoint.setAddress(request.getAddress());
        pickupPointRepository.save(pickupPoint);
        return mapToPickupPointResponse(pickupPoint);
    }

    @Override
    public void deletePickupPoint(String id) {
        if (!pickupPointRepository.existsById(id)) {
            throw new CustomException.ResourceNotFoundException("Pickup point not found.");
        }

        pickupPointRepository.deleteById(id);
    }

    public PickupPointResponse mapToPickupPointResponse(PickupPoint pickupPoint) {
        return PickupPointResponse.builder()
                .pickupPointID(pickupPoint.getId())
                .locationName(pickupPoint.getLocationName())
                .address(pickupPoint.getAddress())
                .build();
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/RoleServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.repository.RoleRepository;
import com.doaibu.rebikeapi.service.RoleService;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
@RequiredArgsConstructor
public class RoleServiceImpl implements RoleService {
    private final RoleRepository roleRepository;

    @Override
    public Optional<Role> findByName(UserRole name) {
        return roleRepository.findByName(name);
    }

    @Override
    public Role save(Role role) {
        return roleRepository.save(role);
    }

    @Override
    public Role getOrCreate(UserRole name) {
        return findByName(name)
                .orElseGet(() -> {
                    Role role = new Role();
                    role.setName(name);
                    return save(role);
                });
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/ScheduledTasksServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.NotificationService;
import com.doaibu.rebikeapi.service.ScheduledTasksService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class ScheduledTasksServiceImpl implements ScheduledTasksService {

    private final TransactionRepository transactionRepository;
    private final NotificationService notificationService;

    @Override
    @Scheduled(cron = "0 0 * * * *")
    public void sendRentalReminders() {
        log.info("Running scheduled task: sendRentalReminders");
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime reminderWindowStart = now.plusHours(1);
        LocalDateTime reminderWindowEnd = now.plusHours(2);

        List<Transaction> upcomingTransactions = transactionRepository
                .findAllByBookingStatusAndStartDateBetween(BookingStatus.CONFIRMED, reminderWindowStart, reminderWindowEnd);

        for (Transaction tx : upcomingTransactions) {
            try {
                String fcmToken = tx.getCustomer().getFcmToken();
                if (fcmToken != null && !fcmToken.isEmpty()) {
                    notificationService.sendNotification(
                            fcmToken,
                            "⏰ Pengingat Jadwal Sewa",
                            "Sewa " + tx.getBike().getName() + " Anda akan segera dimulai.",
                            Map.of("transactionId", tx.getId(), "screen", "TransactionDetail")
                    );
                    log.info("Reminder sent for transaction ID: {}", tx.getId());
                }
            } catch (Exception e) {
                log.error("Failed to send reminder for transaction ID: {}. Error: {}", tx.getId(), e.getMessage());
            }
        }
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/TransactionServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;
import com.doaibu.rebikeapi.dto.request.CreatePaymentRequest;
import com.doaibu.rebikeapi.dto.request.TransactionRequest;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.Bike;
import com.doaibu.rebikeapi.entity.Payment;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.BikeRepository;
import com.doaibu.rebikeapi.repository.PaymentRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.MidtransService;
import com.doaibu.rebikeapi.service.NotificationService;
import com.doaibu.rebikeapi.service.TransactionService;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.orm.ObjectOptimisticLockingFailureException;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.Month;
import java.time.format.TextStyle;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class TransactionServiceImpl implements TransactionService {

    private final TransactionRepository transactionRepository;
    private final PaymentRepository paymentRepository;
    private final MidtransService midtransService;
    private final BikeRepository bikeRepository;
    private final UserRepository userRepository;
    private final NotificationService notificationService;
    private final TokenHolder tokenHolder;

    @Override
    @Transactional
    public MidtransChargeResponse createBooking(TransactionRequest request) {
        try {
            User customer = userRepository.findByUsername(tokenHolder.getUsername())
                    .orElseThrow(() -> new CustomException.ResourceNotFoundException("Customer not found."));
            Bike bike = bikeRepository.findById(request.getBikeID())
                    .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));

            if (bike.getStatus() != BikeStatus.AVAILABLE) {
                throw new CustomException.BadRequestException("Bike is not available for booking.");
            }

            bike.setStatus(BikeStatus.PENDING);
            bikeRepository.save(bike);

            long days = ChronoUnit.DAYS.between(request.getStartDate(), request.getEndDate()) + 1;
            BigDecimal baseCost = bike.getWeekdayPricePerDay().multiply(BigDecimal.valueOf(days));

            Transaction transaction = Transaction.builder()
                    .bike(bike)
                    .customer(customer)
                    .startDate(request.getStartDate())
                    .endDate(request.getEndDate())
                    .baseCost(baseCost)
                    .additionalCosts(BigDecimal.ZERO)
                    .totalCost(baseCost)
                    .bookingStatus(BookingStatus.PENDING)
                    .paymentStatus(PaymentStatus.PENDING)
                    .build();

            transactionRepository.save(transaction);

            String orderId = "INV-RBK-" + transaction.getId();
            CreatePaymentRequest payRequest = CreatePaymentRequest.builder()
                    .orderId(orderId)
                    .grossAmount(transaction.getTotalCost())
                    .customerName(customer.getFirstName() + " " + customer.getLastName())
                    .customerEmail(customer.getEmail())
                    .bank("BRI") // remove for integration with fe
                    .build();
            MidtransChargeResponse response = midtransService.createTransaction(payRequest);

            String bank = null;
            String vaNumber = null;
            if (response.getVaNumbers() instanceof List<?> vaList && !vaList.isEmpty()) {
                Object vaObj = vaList.get(0);
                if (vaObj instanceof Map<?, ?> map) {
                    bank = (String) map.get("bank");
                    vaNumber = (String) map.get("va_number");
                }
            }

            Payment payment = Payment.builder()
                    .orderId(orderId)
                    .status(PaymentStatus.PENDING)
                    .paymentType(response.getPaymentType())
                    .amount(baseCost)
                    .bank(bank)
                    .vaNumber(vaNumber)
                    .snapUrl(response.getRedirectUrl())
                    .transaction(transaction)
                    .build();

            paymentRepository.save(payment);
            return response;
        } catch (ObjectOptimisticLockingFailureException e) {
            throw new CustomException.ConflictException("Sorry, this bike has just been reserved by someone else.");
        }
    }

    @Override
    public PagedResponse<TransactionDetailResponse> getAllTransactions(Pageable pageable) {
        Page<Transaction> transactionPage = transactionRepository.findAll(pageable);
        List<TransactionDetailResponse> transactionResponses = transactionPage.stream()
                .map(this::mapToTransactionDetailedResponse)
                .collect(Collectors.toList());
        return PagedResponse.<TransactionDetailResponse>builder()
                .data(transactionResponses)
                .page(transactionPage.getNumber())
                .size(transactionPage.getSize())
                .totalElements(transactionPage.getTotalElements())
                .totalPages(transactionPage.getTotalPages())
                .build();
    }

    @Override
    public List<TransactionResponse> getTransactionHistory() {
        User customer = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Customer not found."));
        return transactionRepository.findByCustomer(customer).stream()
                .map(this::mapToTransactionResponse)
                .collect(Collectors.toList());
    }

    @Override
    public TransactionDetailResponse getTransactionDetails(String transactionId) {
        User currentUser = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));

        Transaction transaction = transactionRepository.findById(transactionId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));

        boolean isCustomer = transaction.getCustomer().getId().equals(currentUser.getId());
        boolean isPartner = transaction.getBike().getPartner().getId().equals(currentUser.getId());

        if (!isCustomer && !isPartner) {
            throw new CustomException.AuthorizationException("You are not authorized to view this transaction.");
        }

        return mapToTransactionDetailedResponse(transaction);
    }

    @Override
    public List<TransactionDetailResponse> getTransactionsForPartner() {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        return transactionRepository.findByBike_Partner(partner).stream()
                .map(this::mapToTransactionDetailedResponse)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional
    public void verifyPayment(String transactionId, boolean isValid, String reason) {
        Transaction transaction = transactionRepository.findById(transactionId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));
        if (isValid) {
            transaction.setPaymentStatus(PaymentStatus.PAID);
            transaction.setBookingStatus(BookingStatus.CONFIRMED);
        } else {
            transaction.setPaymentStatus(PaymentStatus.EXPIRED);
            transaction.setBookingStatus(BookingStatus.CANCELLED);
        }

        transactionRepository.save(transaction);
    }

//    @Transactional
//    @Override
//    public void uploadPaymentProof(String transactionId, String paymentProofUrl) {
//        Transaction transaction = transactionRepository.findById(transactionId)
//                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));
//        transaction.setPaymentStatus(PaymentStatus.PENDING);
//        transactionRepository.save(transaction);
//    }

    @Override
    @Transactional
    public void confirmTransaction(String transactionId, BookingStatus status) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Transaction transaction = transactionRepository.findById(transactionId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));
        if (!Objects.equals(transaction.getBike().getPartner().getId(), partner.getId())) {
            throw new CustomException.AuthorizationException("You are not authorized to modify this transaction.");
        }

        if (transaction.getBookingStatus() != BookingStatus.PENDING) {
            throw new CustomException.BadRequestException("Only pending transactions can be confirmed or cancelled.");
        }

        transaction.setBookingStatus(status);
        Transaction savedTransaction = transactionRepository.save(transaction);
        try {
            User customer = savedTransaction.getCustomer();
            if (customer.getFcmToken() != null && !customer.getFcmToken().isEmpty()) {
                String title = "";
                String body = "";

                if (savedTransaction.getBookingStatus() == BookingStatus.CONFIRMED) {
                    title = "✅ Order Dikonfirmasi!";
                    body = "Pesanan Anda untuk sepeda '" + savedTransaction.getBike().getName() + "' telah diterima.";
                } else if (savedTransaction.getBookingStatus() == BookingStatus.CANCELLED) {
                    title = "❌ Order Dibatalkan";
                    body = "Pesanan Anda untuk sepeda '" + savedTransaction.getBike().getName() + "' telah dibatalkan oleh partner.";
                }

                if (!title.isEmpty()) {
                    notificationService.sendNotification(
                            customer.getFcmToken(), title, body,
                            Map.of("transactionId", savedTransaction.getId(), "screen", "TransactionDetail")
                    );
                }
            }
        } catch (Exception e) {
            System.err.println("Gagal mengirim notifikasi konfirmasi ke pelanggan: " + e.getMessage());
        }
    }

    @Override
    public FinancialSummaryResponse getFinancialSummaryForPartner() {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        List<Transaction> transactions = transactionRepository.findByBike_Partner(partner);

        BigDecimal totalRevenue = transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .map(Transaction::getTotalCost)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        int totalCompleted = (int) transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .count();
        int totalPending = (int) transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.PENDING)
                .count();
        return FinancialSummaryResponse.builder()
                .totalRevenue(totalRevenue)
                .totalCompletedTransactions(totalCompleted)
                .totalPendingTransactions(totalPending)
                .build();
    }

    @Override
    public RevenueTrendResponse getRevenueTrendForPartner() {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        List<Transaction> transactions = transactionRepository.findByBike_Partner(partner);

        Map<Month, BigDecimal> monthlyRevenue = transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED && t.getStartDate().getYear() == LocalDate.now().getYear())
                .collect(Collectors.groupingBy(
                        t -> t.getStartDate().getMonth(),
                        Collectors.mapping(Transaction::getTotalCost, Collectors.reducing(BigDecimal.ZERO, BigDecimal::add))
                ));
        List<String> labels = new ArrayList<>();
        List<BigDecimal> data = new ArrayList<>();
        LocalDate currentDate = LocalDate.now();
        for (int i = 5; i >= 0; i--) {
            Month month = currentDate.minusMonths(i).getMonth();
            String monthLabel = month.getDisplayName(TextStyle.SHORT, new Locale("id", "ID"));
            labels.add(monthLabel);
            data.add(monthlyRevenue.getOrDefault(month, BigDecimal.ZERO));
        }

        return RevenueTrendResponse.builder()
                .labels(labels)
                .data(data)
                .build();
    }

    private TransactionResponse mapToTransactionResponse(Transaction transaction) {
        return TransactionResponse.builder()
                .transactionID(transaction.getId())
                .startDate(transaction.getStartDate())
                .endDate(transaction.getEndDate())
                .baseCost(transaction.getBaseCost())
                .totalCost(transaction.getTotalCost())
                .paymentStatus(transaction.getPaymentStatus())
                .bookingStatus(transaction.getBookingStatus())
                .build();
    }

    private TransactionDetailResponse mapToTransactionDetailedResponse(Transaction transaction) {
        return TransactionDetailResponse.builder()
                .transactionID(transaction.getId())
                .startDate(transaction.getStartDate())
                .endDate(transaction.getEndDate())
                .baseCost(transaction.getBaseCost())
                .totalCost(transaction.getTotalCost())
                .paymentStatus(transaction.getPaymentStatus())
                .bookingStatus(transaction.getBookingStatus())
                .bike(mapToBikeResponse(transaction.getBike()))
                .customer(mapToUserResponse(transaction.getCustomer()))
                .build();
    }

    private BikeResponse mapToBikeResponse(Bike bike) {
        return BikeResponse.builder()
                .bikeID(bike.getId())
                .name(bike.getName())
                .brand(bike.getBrand())
                .weekdayPricePerDay(bike.getWeekdayPricePerDay())
                .build();
    }

    private UserResponse mapToUserResponse(User user) {
        return UserResponse.builder()
                .userID(user.getId())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/UserDetailsServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.repository.UserRepository;

import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class UserDetailsServiceImpl implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return userRepository.findByUsername(username)
                .orElseThrow(() -> new UsernameNotFoundException("Username not found"));
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/UserServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.request.ChangePasswordRequest;
import com.doaibu.rebikeapi.dto.request.UpdateFcmTokenRequest;
import com.doaibu.rebikeapi.dto.request.UpdateUserProfileRequest;
import com.doaibu.rebikeapi.dto.response.AdminPartnerResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PartnerRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.CloudinaryService;
import com.doaibu.rebikeapi.service.RoleService;
import com.doaibu.rebikeapi.service.UserService;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {

    private final UserRepository userRepository;
    private final RoleService roleService;
    private final PasswordEncoder passwordEncoder;
    private final PartnerRepository partnerRepository;
    private final CloudinaryService cloudinaryService;
    private final TokenHolder tokenHolder;

    private final long maxSize = 5 * 1024 * 1024;

    @Override
    public PagedResponse<AdminPartnerResponse> getAllPartners(Pageable pageable) {
        Role partnerRole = roleService.getOrCreate(UserRole.PARTNER);
        Page<AdminPartnerResponse> partnerPage = userRepository.findAllPartnersWithBikeCount(partnerRole, pageable);

        return PagedResponse.<AdminPartnerResponse>builder()
                .data(partnerPage.getContent())
                .page(partnerPage.getNumber())
                .size(partnerPage.getSize())
                .totalElements(partnerPage.getTotalElements())
                .totalPages(partnerPage.getTotalPages())
                .build();
    }

    @Override
    public AdminPartnerResponse getPartnerById(String partnerId) {
        User user = userRepository.findById(partnerId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        if (user.getRoles().stream().noneMatch(role -> role.getName().equals(UserRole.PARTNER))) {
            throw new CustomException.BadRequestException("User is not a partner.");
        }
        return mapToAdminPartnerResponse(user);
    }

    @Override
    @Transactional
    public void updateProfile(UpdateUserProfileRequest request, MultipartFile file) {
        String username = tokenHolder.getUsername();
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "User not found."));
        if (file != null && !file.isEmpty()) {
            if (file.getSize() > maxSize) {
                throw new CustomException.BadRequestException("File size exceeds 5MB limit.");
            }
            String fileName = file.getOriginalFilename();
            if (fileName != null && !fileName.endsWith(".jpg") && !fileName.endsWith(".jpeg") && !fileName.endsWith(".png")) {
                throw new CustomException.BadRequestException("Only JPG/PNG files are allowed.");
            }

            String url = cloudinaryService.uploadFile(file, "profile_pictures");
            user.setPhotoUrl(url);
        }

        user.setFirstName(request.getFirstName());
        user.setLastName(request.getLastName());
        user.setUsername(request.getUsername());
        user.setPhoneNumber(request.getPhoneNumber());
        userRepository.save(user);
    }

    @Override
    @Transactional
    public void verifyPartner(String partnerId, boolean isVerified) {
        Partner partner = partnerRepository.findById(partnerId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        partner.setVerified(isVerified);
        partnerRepository.save(partner);
    }

    @Override
    @Transactional
    public void changePassword(String username, ChangePasswordRequest request) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "User not found."));
        if (!passwordEncoder.matches(request.getOldPassword(), user.getPassword())) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Old password is incorrect.");
        }
        if (!request.getNewPassword().equals(request.getConfirmPassword())) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Confirm password does not match.");
        }
        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        userRepository.save(user);
    }

    @Override
    @Transactional
    public void updateFcmToken(UpdateFcmTokenRequest request) {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        String email;
        if (principal instanceof UserDetails) {
            email = ((UserDetails) principal).getUsername();
        } else {
            email = principal.toString();
        }
        User currentUser = userRepository.findByEmail(email)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User with email '" + email + "' not found"));
        currentUser.setFcmToken(request.getFcmToken());
        userRepository.save(currentUser);
    }

    private AdminPartnerResponse mapToAdminPartnerResponse(User user) {
        Partner partnerDetails = user.getPartnerDetail();
        return AdminPartnerResponse.builder()
                .id(user.getId())
                .name(user.getFirstName() + " " + user.getLastName())
                .email(user.getEmail())
                .locationName(partnerDetails != null ? partnerDetails.getLocationName() : "N/A")
                .totalBikes(user.getOwnedBikes() != null ? user.getOwnedBikes().size() : 0)
                .isVerified(partnerDetails != null && partnerDetails.isVerified())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AdminDashboardService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.response.DashboardSummaryResponse;

public interface AdminDashboardService {
    DashboardSummaryResponse getDashboardSummary();
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AdminSettingService.java
---

package com.doaibu.rebikeapi.service;

import java.math.BigDecimal;

public interface AdminSettingService {
    BigDecimal getPlatformFeePercentage();
    void updatePlatformFeePercentage(BigDecimal newFee);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AIAssistantService.java
---

package com.doaibu.rebikeapi.service;

public interface AIAssistantService {

    void autoProcessPendingPayouts();

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AuthService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.LoginResponse;
import com.doaibu.rebikeapi.dto.response.RegisterResponse;
import com.doaibu.rebikeapi.entity.User;

public interface AuthService {

    RegisterResponse registerCustomer(RegisterCustomerRequest request);

    RegisterResponse registerPartner(RegisterPartnerRequest request);

    void verifyEmailOtp(String email, String otp);

    void resendVerificationOtp(String email);

    LoginResponse login(LoginRequest request);

    void processForgotPassword(String email, String feBaseUrl);

    void resetPasswordWithOtp(ResetPasswordWithOtpRequest request);

    User processOAuthPostLogin(String email, String name);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/BikeService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.dto.request.BikeRequest;
import com.doaibu.rebikeapi.dto.response.BikeDetailResponse;
import com.doaibu.rebikeapi.dto.response.BikeResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import org.springframework.data.domain.Pageable;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

public interface BikeService {
    BikeResponse addBike(BikeRequest request, MultipartFile file);

    PagedResponse<BikeResponse> getAllBikes(Pageable pageable);

    PagedResponse<BikeResponse> getAllMyBikes(Pageable pageable);

    BikeDetailResponse getBikeById(String id);

    BikeResponse updateBike(String id, BikeRequest request);

    BikeResponse updateBikeStatus(String bikeId, BikeStatus status);

    void deleteBike(String id);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/BusinessInsightService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.response.BusinessRecommendationResponse;
import java.util.List;

public interface BusinessInsightService {
    List<BusinessRecommendationResponse> generateRecommendations();
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/CloudinaryService.java
---

package com.doaibu.rebikeapi.service;

import org.springframework.web.multipart.MultipartFile;

public interface CloudinaryService {
    String uploadFile(MultipartFile file, String folder);

    void deleteByPublicId(String publicId);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/EmailService.java
---

package com.doaibu.rebikeapi.service;

public interface EmailService {
    void sendEmail(String to, String subject, String text);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/FraudDetectionService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.response.FlaggedTransactionResponse;
import java.util.List;

public interface FraudDetectionService {
    void detectAnomalies();
    List<FlaggedTransactionResponse> getFlaggedTransactions();
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/MidtransService.java
---

package com.doaibu.rebikeapi.service;

import java.util.Map;

import com.doaibu.rebikeapi.dto.request.CreatePaymentRequest;
import com.doaibu.rebikeapi.dto.response.MidtransChargeResponse;

public interface MidtransService {
    MidtransChargeResponse createTransaction(CreatePaymentRequest request);

    void handleWebhook(Map<String, Object> payload);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/NotificationService.java
---

package com.doaibu.rebikeapi.service;

import java.util.Map;

public interface NotificationService {
    void sendNotification(String token, String title, String body, Map<String, String> data);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/PartnerService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.PartnerDetailUpdateRequest;
import com.doaibu.rebikeapi.dto.request.PartnerUpdateRequest;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;

public interface PartnerService {
    void updatePartnerProfile(PartnerDetailUpdateRequest request);

    PartnerDetailResponse getBankInformation();

    void updateBankInformation(PartnerUpdateRequest request);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/PayoutService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.PayoutRequest;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.dto.response.PayoutResponse;

import java.util.List;

public interface PayoutService {
    List<PayoutResponse> getAllPayouts();

    List<PayoutResponse> getPayoutsForPartner();

    PayoutResponse requestPayout(PayoutRequest request);

    void processPayout(String payoutId, ProcessPayoutRequest request);

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/PickupPointService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.PickupPointRequest;
import com.doaibu.rebikeapi.dto.response.PickupPointResponse;

import java.util.List;

public interface PickupPointService {
    PickupPointResponse createPickupPoint(PickupPointRequest request);

    List<PickupPointResponse> getAllPickupPoints();

    PickupPointResponse updatePickupPoint(String id, PickupPointRequest request);

    void deletePickupPoint(String id);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/RoleService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.Role;

import java.util.Optional;

public interface RoleService {
    Optional<Role> findByName(UserRole name);

    Role save(Role role);

    Role getOrCreate(UserRole name);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/ScheduledTasksService.java
---

package com.doaibu.rebikeapi.service;

public interface ScheduledTasksService {

    void sendRentalReminders();

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/TransactionService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.dto.request.TransactionRequest;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import org.springframework.data.domain.Pageable;

import java.util.List;

public interface TransactionService {
    MidtransChargeResponse createBooking(TransactionRequest request);

    PagedResponse<TransactionDetailResponse> getAllTransactions(Pageable pageable);
    List<TransactionResponse> getTransactionHistory();

    TransactionDetailResponse getTransactionDetails(String transactionId);

    List<TransactionDetailResponse> getTransactionsForPartner();

    void verifyPayment(String transactionId, boolean isValid, String reason);

//    void uploadPaymentProof(String transactionId, String paymentProofUrl);
    void confirmTransaction(String transactionId, BookingStatus status);

    FinancialSummaryResponse getFinancialSummaryForPartner();

    RevenueTrendResponse getRevenueTrendForPartner();

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/UserService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.ChangePasswordRequest;
import com.doaibu.rebikeapi.dto.request.UpdateFcmTokenRequest;
import com.doaibu.rebikeapi.dto.request.UpdateUserProfileRequest;
import com.doaibu.rebikeapi.dto.response.AdminPartnerResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import org.springframework.data.domain.Pageable;
import org.springframework.web.multipart.MultipartFile;

public interface UserService {

    PagedResponse<AdminPartnerResponse> getAllPartners(Pageable pageable);

    AdminPartnerResponse getPartnerById(String partnerId);

    void updateProfile(UpdateUserProfileRequest request, MultipartFile file);

    void verifyPartner(String partnerId, boolean isVerified);

    void changePassword(String username, ChangePasswordRequest request);

    void updateFcmToken(UpdateFcmTokenRequest request);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/util/ResponseUtil.java
---

package com.doaibu.rebikeapi.util;

import com.doaibu.rebikeapi.dto.response.other.CommonResponse;
Directory Structure:

└── be-rebike
    └── src
        ├── main
        │   └── java
        │       └── com
        │           └── doaibu
        │               └── rebikeapi
        │                   ├── config
        │                   │   ├── CloudinaryConfig.java
        │                   │   ├── DataInitializer.java
        │                   │   ├── FirebaseConfig.java
        │                   │   ├── JwtConfig.java
        │                   │   ├── MidtransConfig.java
        │                   │   ├── OpenApiConfig.java
        │                   │   ├── PasswordEncoderConfig.java
        │                   │   ├── SecurityConfig.java
        │                   │   └── WebSocketConfig.java
        │                   ├── constant
        │                   │   ├── BikeStatus.java
        │                   │   ├── BookingStatus.java
        │                   │   ├── Endpoint.java
        │                   │   ├── PaymentStatus.java
        │                   │   ├── PayoutStatus.java
        │                   │   └── UserRole.java
        │                   ├── controller
        │                   │   ├── AdminController.java
        │                   │   ├── AdminSettingController.java
        │                   │   ├── AuthController.java
        │                   │   ├── ChatController.java
        │                   │   ├── CustomerController.java
        │                   │   ├── PartnerController.java
        │                   │   ├── PublicController.java
        │                   │   └── UserController.java
        │                   ├── dto
        │                   │   ├── request
        │                   │   │   ├── BikeRequest.java
        │                   │   │   ├── ChangePasswordRequest.java
        │                   │   │   ├── ConfirmTransactionRequest.java
        │                   │   │   ├── CreatePaymentRequest.java
        │                   │   │   ├── ForgotPasswordRequest.java
        │                   │   │   ├── LoginRequest.java
        │                   │   │   ├── PartnerDetailUpdateRequest.java
        │                   │   │   ├── PartnerUpdateRequest.java
        │                   │   │   ├── PayoutRequest.java
        │                   │   │   ├── PayoutRequestPayload.java
        │                   │   │   ├── PickupPointRequest.java
        │                   │   │   ├── ProcessPayoutRequest.java
        │                   │   │   ├── RegisterCustomerRequest.java
        │                   │   │   ├── RegisterPartnerRequest.java
        │                   │   │   ├── ResendOtpRequest.java
        │                   │   │   ├── ResetPasswordRequest.java
        │                   │   │   ├── ResetPasswordWithOtpRequest.java
        │                   │   │   ├── TransactionRequest.java
        │                   │   │   ├── UpdateBikeStatusRequest.java
        │                   │   │   ├── UpdateFcmTokenRequest.java
        │                   │   │   ├── UpdateUserProfileRequest.java
        │                   │   │   ├── VerifyOtpRequest.java
        │                   │   │   ├── VerifyPartnerRequest.java
        │                   │   │   └── VerifyPaymentRequest.java
        │                   │   └── response
        │                   │       ├── other
        │                   │       │   ├── CommonResponse.java
        │                   │       │   └── PagedResponse.java
        │                   │       ├── AdminPartnerResponse.java
        │                   │       ├── BikeDetailResponse.java
        │                   │       ├── BikeResponse.java
        │                   │       ├── BusinessRecommendationResponse.java
        │                   │       ├── DashboardSummaryResponse.java
        │                   │       ├── FinancialSummaryResponse.java
        │                   │       ├── FlaggedTransactionResponse.java
        │                   │       ├── LoginResponse.java
        │                   │       ├── MidtransChargeResponse.java
        │                   │       ├── PartnerDetailResponse.java
        │                   │       ├── PayoutResponse.java
        │                   │       ├── PickupPointResponse.java
        │                   │       ├── RegisterResponse.java
        │                   │       ├── RevenueTrendResponse.java
        │                   │       ├── TransactionDetailResponse.java
        │                   │       ├── TransactionResponse.java
        │                   │       └── UserResponse.java
        │                   ├── entity
        │                   │   ├── Bike.java
        │                   │   ├── ChatMessage.java
        │                   │   ├── Partner.java
        │                   │   ├── Payment.java
        │                   │   ├── Payout.java
        │                   │   ├── PickupPoint.java
        │                   │   ├── Role.java
        │                   │   ├── SystemConfiguration.java
        │                   │   ├── Transaction.java
        │                   │   ├── UsagePolicy.java
        │                   │   └── User.java
        │                   ├── exception
        │                   │   ├── CustomException.java
        │                   │   └── GlobalExceptionHandler.java
        │                   ├── repository
        │                   │   ├── BikeRepository.java
        │                   │   ├── ChatMessageRepository.java
        │                   │   ├── PartnerRepository.java
        │                   │   ├── PaymentRepository.java
        │                   │   ├── PayoutRepository.java
        │                   │   ├── PickupPointRepository.java
        │                   │   ├── RoleRepository.java
        │                   │   ├── SystemConfigurationRepository.java
        │                   │   ├── TransactionRepository.java
        │                   │   ├── UsagePolicyRepository.java
        │                   │   └── UserRepository.java
        │                   ├── security
        │                   │   ├── CustomOAuth2AuthenticationSuccessHandler.java
        │                   │   ├── JwtAuthFilter.java
        │                   │   └── JwtUtil.java
        │                   ├── service
        │                   │   ├── impl
        │                   │   │   ├── AdminDashboardServiceImpl.java
        │                   │   │   ├── AdminSettingServiceImpl.java
        │                   │   │   ├── AIAssistantServiceImpl.java
        │                   │   │   ├── AuthServiceImpl.java
        │                   │   │   ├── BikeServiceImpl.java
        │                   │   │   ├── BusinessInsightServiceImpl.java
        │                   │   │   ├── CloudinaryServiceImpl.java
        │                   │   │   ├── EmailServiceImpl.java
        │                   │   │   ├── FraudDetectionServiceImpl.java
        │                   │   │   ├── MidtransServiceImpl.java
        │                   │   │   ├── NotificationServiceImpl.java
        │                   │   │   ├── PartnerServiceImpl.java
        │                   │   │   ├── PayoutServiceImpl.java
        │                   │   │   ├── PickupPointServiceImpl.java
        │                   │   │   ├── RoleServiceImpl.java
        │                   │   │   ├── ScheduledTasksServiceImpl.java
        │                   │   │   ├── TransactionServiceImpl.java
        │                   │   │   ├── UserDetailsServiceImpl.java
        │                   │   │   └── UserServiceImpl.java
        │                   │   ├── AdminDashboardService.java
        │                   │   ├── AdminSettingService.java
        │                   │   ├── AIAssistantService.java
        │                   │   ├── AuthService.java
        │                   │   ├── BikeService.java
        │                   │   ├── BusinessInsightService.java
        │                   │   ├── CloudinaryService.java
        │                   │   ├── EmailService.java
        │                   │   ├── FraudDetectionService.java
        │                   │   ├── MidtransService.java
        │                   │   ├── NotificationService.java
        │                   │   ├── PartnerService.java
        │                   │   ├── PayoutService.java
        │                   │   ├── PickupPointService.java
        │                   │   ├── RoleService.java
        │                   │   ├── ScheduledTasksService.java
        │                   │   ├── TransactionService.java
        │                   │   └── UserService.java
        │                   ├── util
        │                   │   ├── ResponseUtil.java
        │                   │   └── TokenHolder.java
        │                   └── RebikeApplication.java
        └── test
            └── java
                └── com
                    └── doaibu
                        └── rebikeapi
                            └── RebikeApplicationTests.java



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/CloudinaryConfig.java
---

package com.doaibu.rebikeapi.config;

import com.cloudinary.Cloudinary;
import io.github.cdimascio.dotenv.Dotenv;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class CloudinaryConfig {
    private String cloudName;
    private String apiKey;
    private String apiSecret;

    public CloudinaryConfig() {
        Dotenv dotenv = Dotenv.load();

        this.cloudName = dotenv.get("CLOUDINARY_CLOUD_NAME");
        this.apiKey = dotenv.get("CLOUDINARY_API_KEY");
        this.apiSecret = dotenv.get("CLOUDINARY_API_SECRET");
    }

    @Bean
    public Cloudinary cloudinary() {
        Map<String, String> config = new HashMap<>();
        config.put("cloud_name", cloudName);
        config.put("api_key", apiKey);
        config.put("api_secret", apiSecret);
        return new Cloudinary(config);
    }
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/DataInitializer.java
---

package com.doaibu.rebikeapi.config;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;
import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.*;
import com.doaibu.rebikeapi.repository.BikeRepository;
import com.doaibu.rebikeapi.repository.PickupPointRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UsagePolicyRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.RoleService;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.stream.Collectors;

@Component
@Profile("dev")
@RequiredArgsConstructor
public class DataInitializer implements CommandLineRunner {

    private final UserRepository userRepository;
    private final RoleService roleService;
    private final PasswordEncoder passwordEncoder;
    private final BikeRepository bikeRepository;
    private final UsagePolicyRepository usagePolicyRepository;
    private final PickupPointRepository pickupPointRepository;
    private final TransactionRepository transactionRepository;

    private final String defaultPhotoUrl = "https://res.cloudinary.com/dpqk0grzl/image/upload/default-photo-profile_pqodkq.png";

    private final Random random = new Random();

    @Override
    @Transactional
    public void run(String... args) throws Exception {
        Set<Role> customerRole = new HashSet<>();
        customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));

        Set<Role> partnerRole = new HashSet<>();
        partnerRole.add(roleService.getOrCreate(UserRole.PARTNER));

        if (userRepository.count() < 100 || bikeRepository.count() < 100 || transactionRepository.count() < 50) {
            System.out.println("[Rebike DataInitializer] Starting generation of additional dummy data.");

            ensureInitialRolesAndPoliciesExist();

            createAdditionalDummyUsers(customerRole, partnerRole);
            createAdditionalDummyBikes();
            createAdditionalDummyTransactions();

            System.out.println("[Rebike DataInitializer] Additional dummy data generation finished.");
        } else {
            System.out.println("[Rebike DataInitializer] Sufficient dummy data already exists. Skipping generation.");
        }
    }

    private void ensureInitialRolesAndPoliciesExist() {
        roleService.getOrCreate(UserRole.ADMIN);
        roleService.getOrCreate(UserRole.PARTNER);
        roleService.getOrCreate(UserRole.CUSTOMER);

        if (usagePolicyRepository.count() == 0) {
            usagePolicyRepository.saveAll(Arrays.asList(
                    UsagePolicy.builder().policyName("No Smoking").description("No smoking on the bike").isPermitted(false).build(),
                    UsagePolicy.builder().policyName("Helmet Required").description("Helmet must be worn at all times").isPermitted(true).build(),
                    UsagePolicy.builder().policyName("Fuel Full Tank").description("Return with full tank").isPermitted(true).build()
            ));
        }

        if (pickupPointRepository.count() == 0) {
            pickupPointRepository.saveAll(Arrays.asList(
                    PickupPoint.builder().locationName("Kantor Pusat Rebike").address("Jl. Raya Contoh No. 123, Kota Malang").build(),
                    PickupPoint.builder().locationName("Bandara Abdul Rachman Saleh").address("Jl. Raya Bandara, Pakis, Malang").build(),
                    PickupPoint.builder().locationName("Stasiun Malang Kota Baru").address("Jl. Trunojoyo No.10, Klojen, Malang").build()
            ));
        }
    }


    private void createAdditionalDummyUsers(Set<Role> customerRole, Set<Role> partnerRole) {
        long existingUsersCount = userRepository.count();
        int targetUsers = 100;
        int usersToGenerate = (int) (targetUsers - existingUsersCount);

        if (usersToGenerate <= 0) {
            System.out.println("[Rebike Initializer] Target user count already met or exceeded.");
            return;
        }

        for (int i = 0; i < usersToGenerate; i++) {
            UserRole roleType = random.nextBoolean() ? UserRole.CUSTOMER : UserRole.PARTNER;
            Set<Role> roles = (roleType == UserRole.CUSTOMER) ? customerRole : partnerRole;

            String firstName = "GenUser" + (i + 1);
            String lastName = (roleType == UserRole.CUSTOMER ? "Customer" : "Partner") + random.nextInt(100);
            String baseUsername = (roleType.name().toLowerCase() + "gen" + (i + 1)).replaceAll("[^a-zA-Z0-9]", "");
            String username = baseUsername;
            String email = username + "@rebike.com";

            int attempt = 0;
            while (userRepository.existsByEmail(email) || userRepository.existsByUsername(username)) {
                attempt++;
                username = baseUsername + attempt;
                email = username + "@rebike.com";
                if (attempt > 100) {
                    System.err.println("Failed to generate unique username/email after many attempts.");
                    return;
                }
            }


            String password = passwordEncoder.encode("password" + (i + 1));
            String phoneNumber = "08" + String.format("%09d", random.nextInt(1000000000));

            User user = User.builder()
                    .firstName(firstName)
                    .lastName(lastName)
                    .username(username)
                    .email(email)
                    .password(password)
                    .phoneNumber(phoneNumber)
                    .roles(roles)
                    .photoUrl(defaultPhotoUrl)
                    .createdAt(LocalDateTime.now())
                    .isAccountNonExpired(true)
                    .isAccountNonLocked(true)
                    .isCredentialsNonExpired(true)
                    .isEnabled(true)
                    .isEmailVerified(true)
                    .build();

            if (roleType.equals(UserRole.PARTNER)) {
                Partner partner = Partner.builder()
                        .user(user)
                        .locationName("Rental " + firstName + " " + lastName)
                        .bankAccountName(firstName + " " + lastName)
                        .bankAccountNumber(String.format("%010d", random.nextInt(1000000000)))
                        .bankName(random.nextBoolean() ? "BCA" : "Mandiri")
                        .isVerified(true)
                        .build();
                user.setPartnerDetail(partner);
            }
            userRepository.save(user);
            System.out.println("[Rebike Initializer] Created additional " + roleType.name() + ": " + email);
        }
    }


    private void createAdditionalDummyBikes() {
        long existingBikesCount = bikeRepository.count();
        int targetBikes = 100;
        int bikesToGenerate = (int) (targetBikes - existingBikesCount);

        if (bikesToGenerate <= 0) {
            System.out.println("[Rebike Initializer] Target bike count already met or exceeded.");
            return;
        }

        List<User> partners = userRepository.findAllByRoles_Name(UserRole.PARTNER);
        if (partners.isEmpty()) {
            System.out.println("[Rebike Initializer] No partners found to create dummy bikes. Ensure users (partners) are created first.");
            return;
        }

        Set<UsagePolicy> allPolicies = new HashSet<>(usagePolicyRepository.findAll());
        if (allPolicies.isEmpty()) {
            System.out.println("[Rebike Initializer] No usage policies found. Please ensure policies are migrated via Flyway.");
            return;
        }

        List<String> brands = Arrays.asList("Honda", "Yamaha", "Suzuki", "Kawasaki", "Vespa", "BMW", "Ducati");
        List<String> models = Arrays.asList("Vario", "Scoopy", "Beat", "NMAX", "Aerox", "PCX", "CBR", "Ninja", "GS", "Monster", "Sprint");
        String[] transmissionTypes = {"AUTOMATIC", "MANUAL"};
        BikeStatus[] statuses = {BikeStatus.AVAILABLE, BikeStatus.PENDING, BikeStatus.RENTED, BikeStatus.INACTIVE};

        List<Bike> bikesToCreate = new ArrayList<>();
        for (int i = 0; i < bikesToGenerate; i++) {
            User randomPartner = partners.get(random.nextInt(partners.size()));
            String brand = brands.get(random.nextInt(brands.size()));
            String model = models.get(random.nextInt(models.size()));
            String name = brand + " " + model + " " + (100 + random.nextInt(100));
            String plateNumber = generateRandomPlateNumber();

            int attempt = 0;
            while (bikeRepository.findByPlateNumber(plateNumber).isPresent()) {
                attempt++;
                plateNumber = generateRandomPlateNumber();
                if (attempt > 100) {
                    System.err.println("Failed to generate unique plate number after many attempts. Skipping some bikes.");
                    break;
                }
            }
            if (attempt > 100) continue;

            int year = 2018 + random.nextInt(7);
            String machineCapacity = (100 + random.nextInt(150)) + "cc";
            String transmissionType = transmissionTypes[random.nextInt(transmissionTypes.length)];
            BigDecimal weekdayPrice = new BigDecimal(50000 + random.nextInt(150000));
            BigDecimal weekendPrice = weekdayPrice.add(new BigDecimal(10000 + random.nextInt(30000)));
            BikeStatus status = statuses[random.nextInt(statuses.length)];
            String photoURL = "https://picsum.photos/id/" + (100 + random.nextInt(100)) + "/200/300";

            Bike bike = Bike.builder()
                    .partner(randomPartner)
                    .name(name)
                    .brand(brand)
                    .plateNumber(plateNumber)
                    .year(year)
                    .machineCapacity(machineCapacity)
                    .transmissionType(transmissionType)
                    .weekdayPricePerDay(weekdayPrice)
                    .weekendPricePerDay(weekendPrice)
                    .status(status)
                    .photoURL(photoURL)
                    .usagePolicies(allPolicies)
                    .build();
            bikesToCreate.add(bike);
        }
        bikeRepository.saveAll(bikesToCreate);
        System.out.println("[Rebike Initializer] Created " + bikesToCreate.size() + " additional dummy bikes.");
    }

    private String generateRandomPlateNumber() {
        String[] prefixes = {"N", "L", "W", "P", "DK", "B", "F", "D", "AG"};
        String prefix = prefixes[random.nextInt(prefixes.length)];
        int number = 1 + random.nextInt(9999);
        char suffix1 = (char) ('A' + random.nextInt(26));
        char suffix2 = (char) ('A' + random.nextInt(26));
        char suffix3 = (char) ('A' + random.nextInt(26));
        return String.format("%s %d %c%c%c", prefix, number, suffix1, suffix2, suffix3);
    }

    @Transactional
    protected void createAdditionalDummyTransactions() {
        long existingTransactionsCount = transactionRepository.count();
        int targetTransactions = 50;
        int transactionsToGenerate = (int) (targetTransactions - existingTransactionsCount);

        if (transactionsToGenerate <= 0) {
            System.out.println("[Rebike Initializer] Target transaction count already met or exceeded.");
            return;
        }

        List<User> customers = userRepository.findAllByRoles_Name(UserRole.CUSTOMER);
        List<Bike> allBikes = bikeRepository.findAll();
        List<PickupPoint> pickupPoints = pickupPointRepository.findAll();

        if (customers.isEmpty()) {
            System.out.println("[Rebike Initializer] Skipping transaction creation: No customers found. Ensure users are created first.");
            return;
        }
        if (allBikes.isEmpty()) {
            System.out.println("[Rebike Initializer] Skipping transaction creation: No bikes found. Ensure bikes are created first.");
            return;
        }
        if (pickupPoints.isEmpty()) {
            System.out.println("[Rebike Initializer] Skipping transaction creation: No pickup points found. Ensure pickup points are migrated via Flyway.");
            return;
        }

        List<Transaction> transactionsToCreate = new ArrayList<>();
        List<Bike> bikesToUpdate = new ArrayList<>();

        for (int i = 0; i < transactionsToGenerate; i++) {
            User randomCustomer = customers.get(random.nextInt(customers.size()));
            Bike currentBike = allBikes.get(random.nextInt(allBikes.size()));

            Optional<Bike> bikeOptional = bikeRepository.findById(currentBike.getId());
            if (bikeOptional.isEmpty()) {
                System.err.println("Error: Bike with ID " + currentBike.getId() + " not found for transaction creation. Skipping.");
                continue;
            }
            currentBike = bikeOptional.get();


            LocalDateTime startDate = LocalDateTime.now().plusDays(random.nextInt(61) - 30);
            LocalDateTime endDate = startDate.plusDays(1 + random.nextInt(7));

            if (endDate.isBefore(startDate)) {
                LocalDateTime temp = startDate;
                startDate = endDate;
                endDate = temp;
            }

            BigDecimal baseCost = currentBike.getWeekdayPricePerDay().multiply(BigDecimal.valueOf(ChronoUnit.DAYS.between(startDate, endDate) + 1));
            BigDecimal additionalCost = new BigDecimal(random.nextInt(50001));
            BigDecimal totalCost = baseCost.add(additionalCost);

            BookingStatus bookingStatus;
            PaymentStatus paymentStatus;

            int statusChoice = random.nextInt(4);

            if (statusChoice == 0) {
                bookingStatus = BookingStatus.CONFIRMED;
                paymentStatus = PaymentStatus.PAID;
                currentBike.setStatus(BikeStatus.RENTED);
            } else if (statusChoice == 1) {
                bookingStatus = BookingStatus.COMPLETED;
                paymentStatus = PaymentStatus.PAID;
                currentBike.setStatus(BikeStatus.AVAILABLE);
            } else if (statusChoice == 2) {
                bookingStatus = BookingStatus.PENDING;
                paymentStatus = PaymentStatus.PENDING;
                currentBike.setStatus(BikeStatus.PENDING);
            } else {
                bookingStatus = BookingStatus.CANCELLED;
                paymentStatus = random.nextBoolean() ? PaymentStatus.CANCELLED : PaymentStatus.EXPIRED;
                currentBike.setStatus(BikeStatus.AVAILABLE);
            }

            Transaction transaction = Transaction.builder()
                    .bike(currentBike)
                    .customer(randomCustomer)
                    .startDate(startDate)
                    .endDate(endDate)
                    .baseCost(baseCost)
                    .additionalCosts(additionalCost)
                    .totalCost(totalCost)
                    .bookingStatus(bookingStatus)
                    .paymentStatus(paymentStatus)
                    .bookingDate(LocalDateTime.now().minusDays(random.nextInt(31)))
                    .isFlaggedAsPotentialFraud(random.nextBoolean())
                    .fraudFlagReason(random.nextBoolean() ? "Frequent rentals by user." : null)
                    .build();
            transactionsToCreate.add(transaction);

            bikesToUpdate.add(currentBike);
        }

        transactionRepository.saveAll(transactionsToCreate);
        bikeRepository.saveAll(bikesToUpdate);
        System.out.println("[Rebike Initializer] Created " + transactionsToCreate.size() + " dummy transactions and updated " + bikesToUpdate.size() + " bikes.");
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/FirebaseConfig.java
---

package com.doaibu.rebikeapi.config;

import com.google.auth.oauth2.GoogleCredentials;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import com.google.firebase.messaging.FirebaseMessaging;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;

import java.io.IOException;
import java.io.InputStream;

@Configuration
public class FirebaseConfig {

    @Bean
    public FirebaseApp firebaseApp() throws IOException {
        InputStream serviceAccount = new ClassPathResource("serviceAccountKey.json").getInputStream();

        FirebaseOptions options = FirebaseOptions.builder()
                .setCredentials(GoogleCredentials.fromStream(serviceAccount))
                .build();

        if (FirebaseApp.getApps().isEmpty()) {
            return FirebaseApp.initializeApp(options);
        } else {
            return FirebaseApp.getInstance();
        }
    }

    @Bean
    public FirebaseMessaging firebaseMessaging(FirebaseApp firebaseApp) {
        return FirebaseMessaging.getInstance(firebaseApp);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/JwtConfig.java
---

package com.doaibu.rebikeapi.config;

import io.github.cdimascio.dotenv.Dotenv;
import lombok.Data;
import org.springframework.context.annotation.Configuration;

@Data
@Configuration
public class JwtConfig {
    private String secretKey;
    private long expirationMs;

    public JwtConfig() {
        Dotenv dotenv = Dotenv.load();

        this.secretKey = dotenv.get("JWT_SECRET_KEY");
        this.expirationMs = Long.parseLong(dotenv.get("JWT_EXPIRATION_MS"));

    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/MidtransConfig.java
---

package com.doaibu.rebikeapi.config;

import io.github.cdimascio.dotenv.Dotenv;
import lombok.Data;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
@Data
public class MidtransConfig {
    private String serverKey;
    private String apiUrl;

    public MidtransConfig() {
        Dotenv dotenv = Dotenv.load();

        this.serverKey = dotenv.get("MIDTRANS_SERVER_KEY");
        this.apiUrl = dotenv.get("MIDTRANS_API_URL");
    }

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/OpenApiConfig.java
---

package com.doaibu.rebikeapi.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        final String securitySchemeName = "bearerAuth";
        return new OpenAPI()
                .addSecurityItem(new SecurityRequirement().addList(securitySchemeName))
                .components(
                        new Components()
                                .addSecuritySchemes(securitySchemeName,
                                        new SecurityScheme()
                                                .name(securitySchemeName)
                                                .type(SecurityScheme.Type.HTTP)
                                                .scheme("bearer")
                                                .bearerFormat("JWT")
                                )
                )
                .info(new Info().title("Rebike API").version("v1.0").description(
                        "Dokumentasi API lengkap untuk platform rental motor Rebike."));
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/PasswordEncoderConfig.java
---

package com.doaibu.rebikeapi.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
public class PasswordEncoderConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/SecurityConfig.java
---

package com.doaibu.rebikeapi.config;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.security.CustomOAuth2AuthenticationSuccessHandler;
import com.doaibu.rebikeapi.security.JwtAuthFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.List;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {
    private final UserDetailsService userDetailsService;
    private final JwtAuthFilter jwtAuthFilter;
    private final CustomOAuth2AuthenticationSuccessHandler oauth2SuccessHandler;
    private final PasswordEncoder passwordEncoder;

    @Value("#{'${cors.allowed-origins}'.split(',')}")
    private List<String> allowedOrigins;

    private static final String[] SWAGGER_WHITELIST = {
            "/swagger-ui.html",
            "/swagger-ui/**",
            "/v3/api-docs/**",
            "/swagger-resources/**",
            "/webjars/**"
    };

    @Bean
    public SecurityFilterChain config(HttpSecurity http) throws Exception {
        return http
                .cors(Customizer.withDefaults())
                .csrf(AbstractHttpConfigurer::disable)
                .authorizeHttpRequests(authorizeRequests -> {
                    authorizeRequests
                            .requestMatchers(SWAGGER_WHITELIST).permitAll()
                            .requestMatchers(Endpoint.AUTH + "/**", "/login/oauth2/**", "/oauth2/**").permitAll()
                            .requestMatchers(Endpoint.API + "/callback/**").permitAll()
                            .requestMatchers(HttpMethod.GET, Endpoint.PUBLIC + "/**").permitAll()

                            .requestMatchers(Endpoint.USER + "/**").hasAnyRole("PARTNER", "ADMIN", "CUSTOMER")
                            .requestMatchers(Endpoint.PARTNER + "/**").hasRole("PARTNER")
                            .requestMatchers(Endpoint.ADMIN + "/settings/**").hasRole("ADMIN")
                            .requestMatchers(Endpoint.ADMIN + "/**").hasRole("ADMIN")
                            .requestMatchers(Endpoint.CUSTOMER + "/**").hasRole("CUSTOMER")

                            .anyRequest().authenticated();
                })
                .oauth2Login(oauth -> {
                    oauth.successHandler(oauth2SuccessHandler);
                })
                .authenticationProvider(authenticationProvider())
                .addFilterAfter(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class)
                .build();
    }

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("http://localhost:5173"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("Authorization", "Content-Type", "x-auth-token"));
        configuration.setAllowCredentials(true);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(userDetailsService);
        authProvider.setPasswordEncoder(passwordEncoder);
        return authProvider;
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/config/WebSocketConfig.java
---

package com.doaibu.rebikeapi.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws").withSockJS();
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.setApplicationDestinationPrefixes("/app");
        registry.enableSimpleBroker("/topic", "/queue");
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/BikeStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum BikeStatus {
    AVAILABLE,
    PENDING,
    RENTED,
    INACTIVE
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/BookingStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum BookingStatus {
    PENDING,
    CONFIRMED,
    IN_PROGRESS,
    COMPLETED,
    CANCELLED
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/Endpoint.java
---

package com.doaibu.rebikeapi.constant;

public class Endpoint {
    public static final String API = "/api";

    public static final String AUTH = API + "/auth";
    
    public static final String PUBLIC = API + "/public";
    
    public static final String USER = API + "/user";

    public static final String CUSTOMER = API + "/customer";
    public static final String PARTNER = API + "/partner";
    public static final String ADMIN = API + "/admin";
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/PaymentStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum PaymentStatus {
    CANCELLED,
    PENDING,
    PAID,
    EXPIRED,
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/PayoutStatus.java
---

package com.doaibu.rebikeapi.constant;

public enum PayoutStatus {
    PENDING,
    PROCESSING,
    APPROVED,
    REJECTED
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/constant/UserRole.java
---

package com.doaibu.rebikeapi.constant;

public enum UserRole {
    ADMIN,
    PARTNER,
    CUSTOMER
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/AdminController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.PickupPointRequest;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.dto.request.VerifyPaymentRequest;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.*;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(Endpoint.ADMIN)
@RequiredArgsConstructor
public class AdminController {

    private final UserService userService;
    private final TransactionService transactionService;
    private final PickupPointService pickupPointService;
    private final PayoutService payoutService;
    private final AdminDashboardService adminDashboardService;
    private final FraudDetectionService fraudDetectionService;
    private final BusinessInsightService businessInsightService;

    @GetMapping("/partners")
    public ResponseEntity<?> getAllPartners(@RequestParam(required = false, defaultValue = "0") int page,
                                            @RequestParam(required = false, defaultValue = "10") int size,
                                            @RequestParam(required = false, defaultValue = "firstName") String sortBy,
                                            @RequestParam(required = false, defaultValue = "asc") String sortDirection) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortDirection.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC, sortBy));

        PagedResponse<AdminPartnerResponse> response = userService.getAllPartners(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All partners retrieved successfully.",
                response);
    }

    @GetMapping("/partners/{partnerId}")
    public ResponseEntity<?> getPartnerById(@PathVariable String partnerId) {
        AdminPartnerResponse response = userService.getPartnerById(partnerId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Partner details retrieved successfully.",
                response);
    }

    @PatchMapping("/partners/{partnerId}/verify")
    public ResponseEntity<?> verifyPartner(@PathVariable String partnerId, @RequestBody Map<String, Boolean> payload) {
        Boolean isVerified = payload.get("isVerified");
        if (isVerified == null) {
            throw new CustomException.BadRequestException("Field 'isVerified' with a boolean value is required.");
        }
        userService.verifyPartner(partnerId, isVerified);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Partner verification status updated successfully.",
                null);
    }

    @GetMapping("/transactions")
    public ResponseEntity<?> getAllTransactions(Pageable pageable) {
        PagedResponse<TransactionDetailResponse> response = transactionService.getAllTransactions(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All transactions retrieved successfully.",
                response);
    }

    @PostMapping("/transactions/{transactionId}/verify-payment")
    public ResponseEntity<?> verifyPayment(@PathVariable String transactionId,
                                           @RequestBody VerifyPaymentRequest request) {
        transactionService.verifyPayment(transactionId, request.isValid(), request.getReason());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Payment verification processed.",
                null);
    }

    @PostMapping("/pickup-points")
    public ResponseEntity<?> createPickupPoint(@RequestBody PickupPointRequest request) {
        PickupPointResponse response = pickupPointService.createPickupPoint(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Pickup point created successfully.",
                response);
    }

    @PutMapping("/pickup-points/{pointId}")
    public ResponseEntity<?> updatePickupPoint(@PathVariable String pointId, @RequestBody PickupPointRequest request) {
        PickupPointResponse response = pickupPointService.updatePickupPoint(pointId, request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Pickup point updated successfully.",
                response);
    }

    @DeleteMapping("/pickup-points/{pointId}")
    public ResponseEntity<?> deletePickupPoint(@PathVariable String pointId) {
        pickupPointService.deletePickupPoint(pointId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Pickup point deleted successfully.",
                null);
    }

    @GetMapping("/payouts")
    public ResponseEntity<?> getAllPayouts() {
        List<PayoutResponse> response = payoutService.getAllPayouts();
        return ResponseUtil.response(
                HttpStatus.OK,
                "All payout requests retrieved.",
                response);
    }

    @PostMapping("/payouts/{payoutId}/process")
    public ResponseEntity<?> processPayout(@PathVariable String payoutId, @RequestBody ProcessPayoutRequest request) {
        payoutService.processPayout(payoutId, request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Payout processed successfully.",
                null);
    }

    @GetMapping("/dashboard/summary")
    public ResponseEntity<?> getDashboardSummary() {
        DashboardSummaryResponse response = adminDashboardService.getDashboardSummary();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Dashboard summary retrieved successfully.",
                response);
    }

    @GetMapping("/fraud-alerts")
    public ResponseEntity<?> getFraudAlerts() {
        List<FlaggedTransactionResponse> response = fraudDetectionService.getFlaggedTransactions();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Fraud alerts retrieved successfully.",
                response);
    }

    @GetMapping("/recommendations")
    public ResponseEntity<?> getBusinessRecommendations() {
        List<BusinessRecommendationResponse> response = businessInsightService.generateRecommendations();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Business recommendations retrieved successfully.",
                response);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/AdminSettingController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.service.AdminSettingService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.Map;

@RestController
@RequestMapping(Endpoint.ADMIN + "/settings")
@RequiredArgsConstructor
public class AdminSettingController {

    private final AdminSettingService adminSettingService;

    @GetMapping("/fee")
    public ResponseEntity<?> getFee() {
        BigDecimal fee = adminSettingService.getPlatformFeePercentage();
        return ResponseUtil.response(HttpStatus.OK, "Fee fetched successfully", Map.of("percentage", fee.multiply(new BigDecimal("100"))));
    }

    @PostMapping("/fee")
    public ResponseEntity<?> updateFee(@RequestBody Map<String, String> payload) {
        BigDecimal newFee = new BigDecimal(payload.get("percentage"));
        adminSettingService.updatePlatformFeePercentage(newFee);
        return ResponseUtil.response(HttpStatus.OK, "Fee updated successfully", null);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/AuthController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.LoginResponse;
import com.doaibu.rebikeapi.dto.response.RegisterResponse;
import com.doaibu.rebikeapi.service.AuthService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping(Endpoint.AUTH)
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;

    @Value("${app.frontend-base-url}")
    private String feBaseUrl;

    @PostMapping("/register/customer")
    public ResponseEntity<?> registerCustomer(@Valid @RequestBody RegisterCustomerRequest request) {
        RegisterResponse response = authService.registerCustomer(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "User registered as a Customer successfully.",
                response);
    }

    @PostMapping("/register/partner")
    public ResponseEntity<?> registerPartner(@Valid @RequestBody RegisterPartnerRequest request) {
        RegisterResponse response = authService.registerPartner(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "User registered as a Partner successfully.",
                response);
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(@Valid @RequestBody LoginRequest request) {
        LoginResponse response = authService.login(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Login successfully.",
                response);
    }

    @PostMapping("/forgot-password")
    public ResponseEntity<?> forgotPassword(@Valid @RequestBody ForgotPasswordRequest request) {
        authService.processForgotPassword(request.getEmail(), feBaseUrl);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Password reset link has been sent to your email.",
                null);
    }

    @PostMapping("/reset-password-with-otp")
    public ResponseEntity<?> resetPasswordWithOtp(@Valid @RequestBody ResetPasswordWithOtpRequest request) {
        authService.resetPasswordWithOtp(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Password changed successfully.",
                null);
    }

    @PostMapping("/verify-email")
    public ResponseEntity<?> verifyEmail(@Valid @RequestBody VerifyOtpRequest request) {
        authService.verifyEmailOtp(request.getEmail(), request.getOtp());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Email verified successfully.",
                null);
    }

    @PostMapping("/resend-otp")
    public ResponseEntity<?> resendOtp(@Valid @RequestBody ResendOtpRequest request) {
        authService.resendVerificationOtp(request.getEmail());
        return ResponseUtil.response(
                HttpStatus.OK,
                "OTP code resent successfully.",
                null);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/ChatController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.entity.ChatMessage;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.repository.ChatMessageRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.CloudinaryService;
import com.doaibu.rebikeapi.service.NotificationService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import java.time.LocalDateTime;
import java.util.Map;
import java.util.Optional;

@Controller
@RequiredArgsConstructor
public class ChatController {

    private final SimpMessagingTemplate messagingTemplate;
    private final ChatMessageRepository chatMessageRepository;
    private final CloudinaryService cloudinaryService;
    private final NotificationService notificationService;
    private final UserRepository userRepository;

    @MessageMapping("/chat.sendMessage")
    public void sendMessage(@Payload ChatMessage chatMessage) {
        chatMessage.setTimestamp(LocalDateTime.now());
        chatMessageRepository.save(chatMessage);

        String destination = "/queue/messages/" + chatMessage.getRecipient().getId();
        messagingTemplate.convertAndSend(destination, chatMessage);

        try {
            Optional<User> recipientOptional = userRepository.findById(chatMessage.getRecipient().getId());

            if (recipientOptional.isPresent()) {
                User recipient = recipientOptional.get();
                String fcmToken = recipient.getFcmToken();

                if (fcmToken != null && !fcmToken.isEmpty()) {
                    String senderName = chatMessage.getSender().getFirstName();
                    String messageContent = chatMessage.getType() == ChatMessage.MessageType.TEXT
                            ? chatMessage.getContent()
                            : "Mengirim gambar...";

                    notificationService.sendNotification(
                            fcmToken,
                            "Pesan baru dari " + senderName,
                            messageContent,
                            Map.of("senderId", chatMessage.getSender().getId(), "screen", "ChatScreen")
                    );
                }
            }
        } catch (Exception e) {
            System.err.println("Gagal mengirim push notification untuk chat: " + e.getMessage());
        }
    }

    @PostMapping("/api/v1/chat/upload-image")
    public ResponseEntity<Map<String, String>> uploadImage(@RequestParam("file") MultipartFile file) {
        String fileUrl = cloudinaryService.uploadFile(file, "chat_images");
        Map<String, String> response = Map.of("url", fileUrl);
        return ResponseEntity.ok(response);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/CustomerController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.TransactionRequest;
import com.doaibu.rebikeapi.dto.response.MidtransChargeResponse;
import com.doaibu.rebikeapi.dto.response.TransactionDetailResponse;
import com.doaibu.rebikeapi.dto.response.TransactionResponse;
import com.doaibu.rebikeapi.dto.response.UserResponse;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.TransactionService;
import com.doaibu.rebikeapi.service.UserService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@RestController
@RequestMapping(Endpoint.CUSTOMER)
@RequiredArgsConstructor
public class CustomerController {

    private final TransactionService transactionService;
    private final UserService userService;

    @PostMapping("/transactions")
    public ResponseEntity<?> createBooking(@RequestBody TransactionRequest request) {
        MidtransChargeResponse response = transactionService.createBooking(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Booking created successfully",
                response);
    }

    @GetMapping("/transactions")
    public ResponseEntity<?> getTransactionHistory() {
        List<TransactionResponse> response = transactionService.getTransactionHistory();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Transaction history retrieved successfully",
                response);
    }

    @GetMapping("/transactions/{transactionId}")
    public ResponseEntity<?> getTransactionDetails(@PathVariable String transactionId) {
        TransactionDetailResponse response = transactionService.getTransactionDetails(transactionId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Transaction details retrieved successfully",
                response);
    }

//    @PostMapping("/transactions/{transactionId}/payment")
//    public ResponseEntity<?> uploadPaymentProof(@PathVariable String transactionId,
//                                                @RequestParam("paymentProof") MultipartFile paymentProof) {
//        String paymentProofUrl = "http://example.com/payment_proofs/" + transactionId + "_"
//                + paymentProof.getOriginalFilename();
//        transactionService.uploadPaymentProof(transactionId, paymentProofUrl);
//        return ResponseUtil.response(
//                HttpStatus.OK,
//                "Payment proof uploaded successfully",
//                null);
//    }

    // New endpoint for getting customer's own profile
    @GetMapping("/profile")
    public ResponseEntity<?> getMyCustomerProfile() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        String userId;
        if (principal instanceof User) {
            userId = ((User) principal).getId();
        } else {
            throw new CustomException.AuthenticationException("User not authenticated or principal type is not User.");
        }

        UserResponse response = userService.getCustomerProfile(userId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Customer profile retrieved successfully",
                response);
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/PartnerController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.*;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@RestController
@RequestMapping(Endpoint.PARTNER)
@RequiredArgsConstructor
public class PartnerController {

    private final BikeService bikeService;
    private final PartnerService partnerService;
    private final TransactionService transactionService;
    private final PayoutService payoutService;
    private final UserService userService;

    @PutMapping("/profile")
    public ResponseEntity<?> updatePartnerProfile(@RequestBody PartnerDetailUpdateRequest request) {
        partnerService.updatePartnerProfile(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Profile updated successfully",
                null);
    }

    @PostMapping("/bikes")
    public ResponseEntity<?> addBike(@RequestBody BikeRequest bikeRequest, @RequestParam MultipartFile file) {
        BikeResponse response = bikeService.addBike(bikeRequest, file);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Bike added successfully",
                response);
    }

    @GetMapping("/bikes")
    public ResponseEntity<?> getAllMyBikes(@RequestParam(required = false, defaultValue = "0") int page,
                                         @RequestParam(required = false, defaultValue = "10") int size,
                                         @RequestParam(required = false, defaultValue = "name") String sortBy,
                                         @RequestParam(required = false, defaultValue = "asc") String sortDirection) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortDirection.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC, sortBy));

        PagedResponse<BikeResponse> response = bikeService.getAllMyBikes(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All my bikes retrieved successfully",
                response);
    }

    @GetMapping("/bikes/{bikeId}")
    public ResponseEntity<?> getBikeById(@PathVariable String bikeId) {
        BikeDetailResponse response = bikeService.getBikeById(bikeId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike retrieved successfully",
                response);
    }

    @PutMapping("/bikes/{bikeId}")
    public ResponseEntity<?> updateBike(@PathVariable String bikeId, @RequestBody BikeRequest bikeRequest) {
        BikeResponse bikeResponse = bikeService.updateBike(bikeId, bikeRequest);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike updated successfully",
                bikeResponse);
    }

    @PutMapping("/bikes/{bikeId}/status")
    public ResponseEntity<?> updateBikeStatus(@PathVariable String bikeId,
                                              @RequestBody UpdateBikeStatusRequest request) {
        BikeResponse response = bikeService.updateBikeStatus(bikeId, request.getStatus());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike status updated successfully",
                response);
    }

    @DeleteMapping("/bikes/{bikeId}")
    public ResponseEntity<?> deleteBike(@PathVariable String bikeId) {
        bikeService.deleteBike(bikeId);

        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike deleted successfully",
                null);
    }

    @GetMapping("/bank-info")
    public ResponseEntity<?> getBankInformation() {
        PartnerDetailResponse response = partnerService.getBankInformation();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bank information retrieved successfully",
                response);
    }

    @PutMapping("/bank-info")
    public ResponseEntity<?> updateBankInformation(@RequestBody PartnerUpdateRequest request) {
        partnerService.updateBankInformation(request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bank information updated successfully",
                null);
    }

    @GetMapping("/transactions")
    public ResponseEntity<?> getTransactions() {
        List<TransactionDetailResponse> response = transactionService.getTransactionsForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Partner transactions retrieved successfully",
                response);
    }

    @PostMapping("/transactions/{transactionId}/confirm")
    public ResponseEntity<?> confirmTransaction(@PathVariable String transactionId,
                                                @RequestBody ConfirmTransactionRequest request) {
        transactionService.confirmTransaction(transactionId, request.getStatus());
        return ResponseUtil.response(
                HttpStatus.OK,
                "Transaction status updated successfully",
                null);
    }

    @GetMapping("/financial-summary")
    public ResponseEntity<?> getFinancialSummary() {
        FinancialSummaryResponse response = transactionService.getFinancialSummaryForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Financial summary retrieved successfully",
                response);
    }

    @GetMapping("/payouts")
    public ResponseEntity<?> getPayoutHistory() {
        List<PayoutResponse> response = payoutService.getPayoutsForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Payout history retrieved",
                response);
    }

    @PostMapping("/payouts")
    public ResponseEntity<?> requestPayout(@RequestBody PayoutRequest request) {
        PayoutResponse response = payoutService.requestPayout(request);
        return ResponseUtil.response(
                HttpStatus.CREATED,
                "Payout request submitted",
                response);
    }

    @GetMapping("/dashboard/revenue-trend")
    public ResponseEntity<?> getRevenueTrend() {
        RevenueTrendResponse response = transactionService.getRevenueTrendForPartner();
        return ResponseUtil.response(
                HttpStatus.OK,
                "Revenue trend retrieved successfully",
                response
        );
    }

    @GetMapping("/profile")
    public ResponseEntity<?> getMyPartnerProfile() {
        System.out.println("DEBUG Controller: Entering getMyPartnerProfile()"); // Tambahkan ini
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        User currentUser = (User) principal;
        System.out.println("DEBUG Controller: Current User ID: " + currentUser.getId());
        System.out.println("DEBUG Controller: Current User Roles: " + SecurityContextHolder.getContext().getAuthentication().getAuthorities());

        try {
            PartnerDetailResponse response = userService.getPartnerProfile(currentUser.getId());
            System.out.println("DEBUG Controller: Exiting getMyPartnerProfile() successfully."); // Tambahkan ini
            return ResponseUtil.response(
                    HttpStatus.OK,
                    "Partner profile retrieved successfully",
                    response);
        } catch (Exception e) {
            System.err.println("DEBUG Controller: Exception in getMyPartnerProfile(): " + e.getMessage()); // Tambahkan ini
            e.printStackTrace(); // Penting untuk melihat stack trace
            throw e; // Lempar ulang exception agar GlobalExceptionHandler menangkapnya
        }
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/PublicController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.dto.response.BikeDetailResponse;
import com.doaibu.rebikeapi.dto.response.BikeResponse;
import com.doaibu.rebikeapi.dto.response.PickupPointResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.service.BikeService;
import com.doaibu.rebikeapi.service.MidtransService;
import com.doaibu.rebikeapi.service.PickupPointService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping(Endpoint.PUBLIC)
@RequiredArgsConstructor
public class PublicController {

    private final PickupPointService pickupPointService;
    private final BikeService bikeService;
    private final MidtransService midtransService;

    @GetMapping("/pickup-points")
    public ResponseEntity<?> getAllPickupPoints() {
        List<PickupPointResponse> response = pickupPointService.getAllPickupPoints();
        return ResponseUtil.response(
                HttpStatus.OK,
                "All pickup points retrieved successfully",
                response);
    }

    @GetMapping("/bikes")
    public ResponseEntity<?> getAllBikes(@RequestParam(required = false, defaultValue = "0") int page,
                                         @RequestParam(required = false, defaultValue = "10") int size,
                                         @RequestParam(required = false, defaultValue = "name") String sortBy,
                                         @RequestParam(required = false, defaultValue = "asc") String sortDirection) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortDirection.equalsIgnoreCase("asc") ?
                Sort.Direction.ASC : Sort.Direction.DESC, sortBy));

        PagedResponse<BikeResponse> response = bikeService.getAllBikes(pageable);
        return ResponseUtil.response(
                HttpStatus.OK,
                "All bikes retrieved successfully",
                response);
    }

    @GetMapping("/bike/{bikeId}")
    public ResponseEntity<?> getBikeById(@PathVariable String bikeId) {
        BikeDetailResponse response = bikeService.getBikeById(bikeId);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Bike retrieved successfully",
                response);
    }

    @PostMapping("/notification")
    public ResponseEntity<String> handleWebhook(@RequestBody Map<String, Object> payload) {
        midtransService.handleWebhook(payload);
        return ResponseEntity.ok("Notification sent successfully");
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/controller/UserController.java
---

package com.doaibu.rebikeapi.controller;

import com.doaibu.rebikeapi.constant.Endpoint;
import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.request.ChangePasswordRequest;
import com.doaibu.rebikeapi.dto.request.UpdateFcmTokenRequest;
import com.doaibu.rebikeapi.dto.request.UpdateUserProfileRequest;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;
import com.doaibu.rebikeapi.dto.response.UserResponse;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.UserService;
import com.doaibu.rebikeapi.util.ResponseUtil;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.Set;
import java.util.stream.Collectors;

@RestController
@RequestMapping(Endpoint.USER)
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;
    private final TokenHolder tokenHolder;

    @PatchMapping("/password")
    public ResponseEntity<?> changePassword(@Valid @RequestBody ChangePasswordRequest request) {
        String username = tokenHolder.getUsername();
        userService.changePassword(username, request);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Password changed successfully",
                null);
    }

    @PutMapping("/profile")
    public ResponseEntity<?> updateProfile(@Valid @RequestBody UpdateUserProfileRequest request, MultipartFile file) {
        userService.updateProfile(request, file);
        return ResponseUtil.response(
                HttpStatus.OK,
                "Profile updated successfully",
                null);
    }

    @PutMapping("/fcm-token")
    public ResponseEntity<Void> updateFcmToken(@RequestBody UpdateFcmTokenRequest request) {
        userService.updateFcmToken(request);
        return ResponseEntity.ok().build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/BikeRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

import java.math.BigDecimal;

@Getter
public class BikeRequest {
    private String name;
    private String photoURL;
    private String plateNumber;
    private String brand;
    private int year;
    private String machineCapacity;
    private String transmissionType;
    private BigDecimal weekdayPricePerDay;
    private BigDecimal weekendPricePerDay;
    private int stock;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ChangePasswordRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ChangePasswordRequest {
    private String oldPassword;
    private String newPassword;
    private String confirmPassword;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ConfirmTransactionRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import com.doaibu.rebikeapi.constant.BookingStatus;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ConfirmTransactionRequest {
    private BookingStatus status;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/CreatePaymentRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;

@Data
@Builder
public class CreatePaymentRequest {
    private String orderId;
    private BigDecimal grossAmount;
    private String customerName;
    private String customerEmail;
    private String bank;
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ForgotPasswordRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;

@Getter
public class ForgotPasswordRequest {
    @NotBlank
    @Email
    private String email;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/LoginRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class LoginRequest {
    private String email;
    private String password;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PartnerDetailUpdateRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class PartnerDetailUpdateRequest {
    private String locationName;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PartnerUpdateRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class PartnerUpdateRequest {
    private String bankName;
    private String bankAccountName;
    private String bankAccountNumber;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PayoutRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

import java.math.BigDecimal;

@Getter
@Setter
public class PayoutRequest {
    private BigDecimal amount;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PayoutRequestPayload.java
---

package com.doaibu.rebikeapi.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Builder;
import lombok.Data;
import java.util.List;

@Data
@Builder
public class PayoutRequestPayload {
    private List<PayoutDetail> payouts;

    @Data
    @Builder
    public static class PayoutDetail {
        @JsonProperty("beneficiary_name")
        private String beneficiaryName;

        @JsonProperty("beneficiary_account")
        private String beneficiaryAccount;

        @JsonProperty("beneficiary_bank")
        private String beneficiaryBank;

        @JsonProperty("beneficiary_email")
        private String beneficiaryEmail;

        private String amount;

        private String notes;

        @JsonProperty("reference_no")
        private String referenceNo;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/PickupPointRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class PickupPointRequest {
    private String locationName;
    private String address;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ProcessPayoutRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class ProcessPayoutRequest {
    private PayoutStatus status;
    private String notes;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/RegisterCustomerRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class RegisterCustomerRequest {
    @NotBlank
    private String firstName;

    @NotBlank
    private String lastName;

    @NotBlank(message = "Username tidak boleh kosong")
    private String username;

    @NotBlank(message = "Email tidak boleh kosong")
    @Email(message = "Format email tidak valid")
    private String email;

    @NotBlank(message = "Password tidak boleh kosong")
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String password;

    @NotBlank(message = "Nomor telepon tidak boleh kosong")
    private String phoneNumber;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/RegisterPartnerRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class RegisterPartnerRequest {
    @NotBlank
    private String firstName;

    @NotBlank
    private String lastName;

    @NotBlank(message = "Username tidak boleh kosong")
    private String username;

    @NotBlank(message = "Email tidak boleh kosong")
    @Email(message = "Format email tidak valid")
    private String email;

    @NotBlank(message = "Password tidak boleh kosong")
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String password;

    @NotBlank(message = "Nomor telepon tidak boleh kosong")
    private String phoneNumber;

    private String locationName;
    private String bankAccountName;
    private String bankAccountNumber;
    private String bankName;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ResendOtpRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;

@Getter
public class ResendOtpRequest {
    @NotBlank
    @Email
    private String email;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ResetPasswordRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class ResetPasswordRequest {
    @NotBlank
    private String token;

    @NotBlank
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String newPassword;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/ResetPasswordWithOtpRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.Getter;

@Getter
public class ResetPasswordWithOtpRequest {
    @NotBlank
    @Email
    private String email;

    @NotBlank
    private String otp;

    @NotBlank
    @Size(min = 8, message = "Password minimal 8 karakter")
    private String newPassword;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/TransactionRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

import java.time.LocalDateTime;

@Getter
public class TransactionRequest {
    private String bikeID;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private String pickupPointId;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/UpdateBikeStatusRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import com.doaibu.rebikeapi.constant.BikeStatus;
import lombok.Getter;
import lombok.Setter;

@Getter
public class UpdateBikeStatusRequest {
    private BikeStatus status;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/UpdateFcmTokenRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Data;

@Data
public class UpdateFcmTokenRequest {
    private String fcmToken;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/UpdateUserProfileRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;

@Getter
public class UpdateUserProfileRequest {
    private String firstName;
    private String lastName;
    private String username;
    private String phoneNumber;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/VerifyOtpRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.Getter;

@Getter
public class VerifyOtpRequest {
    @NotBlank
    @Email
    private String email;

    @NotBlank
    private String otp;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/VerifyPartnerRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class VerifyPartnerRequest {
    private boolean isVerified;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/request/VerifyPaymentRequest.java
---

package com.doaibu.rebikeapi.dto.request;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class VerifyPaymentRequest {
    private boolean isValid;
    private String reason;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/other/CommonResponse.java
---

package com.doaibu.rebikeapi.dto.response.other;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class CommonResponse<T> {
    private String message;
    private int statusCode;
    private T data;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/other/PagedResponse.java
---

package com.doaibu.rebikeapi.dto.response.other;

import lombok.Builder;
import lombok.Data;
import java.util.List;

@Data
@Builder
public class PagedResponse<T> {
    private List<T> data;
    private int page;
    private int size;
    private long totalElements;
    private int totalPages;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/AdminPartnerResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
public class AdminPartnerResponse {
    private String id;
    private String name;
    private String email;
    private String locationName;
    private int totalBikes;
    private boolean isVerified;

    public AdminPartnerResponse(String id, String name, String email, String locationName, Integer totalBikes, boolean isVerified) {
        this.id = id;
        this.name = name;
        this.email = email;
        this.locationName = locationName;
        this.totalBikes = (totalBikes != null) ? totalBikes : 0;
        this.isVerified = isVerified;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/BikeDetailResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.BikeStatus;
import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.Set;

@Data
@Builder
public class BikeDetailResponse {
    private String bikeID;
    private String name;
    private String photoURL;
    private String brand;
    private String plateNumber;
    private int year;
    private String transmissionType;
    private String machineCapacity;
    private BigDecimal weekdayPricePerDay;
    private BigDecimal weekendPricePerDay;
    private BikeStatus status;
    private Set<UsagePolicyResponse> usagePolicies;
    private PartnerInfo partner;

    @Data
    @Builder
    public static class UsagePolicyResponse {
        private String policyID;
        private String policyName;
        private String description;
        private boolean isPermitted;
    }

    @Data
    @Builder
    public static class PartnerInfo {
        private String locationName;
        private boolean isVerified;
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/BikeResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;

@Data
@Builder
public class BikeResponse {
    private String bikeID;
    private String name;
    private int year;
    private String transmissionType;
    private String machineCapacity;
    private String photoURL;
    private String brand;
    private BigDecimal weekdayPricePerDay;
    private BigDecimal weekendPricePerDay;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/BusinessRecommendationResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class BusinessRecommendationResponse {
    private String recommendation;
    private String reason;
    private String severity;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/DashboardSummaryResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;

@Data
@Builder
public class DashboardSummaryResponse {
    private long totalUsers;
    private long totalPartners;
    private long totalTransactions;
    private BigDecimal platformRevenue;
    private ChartData userGrowth;
    private ChartData partnerGrowth;

    @Data
    @Builder
    public static class ChartData {
        private List<String> labels;
        private List<Long> data;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/FinancialSummaryResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;

@Data
@Builder
public class FinancialSummaryResponse {
    private BigDecimal totalRevenue;
    private Integer totalCompletedTransactions;
    private Integer totalPendingTransactions;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/FlaggedTransactionResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
public class FlaggedTransactionResponse {
    private String transactionId;
    private String customerName;
    private String bikeName;
    private LocalDateTime transactionDate;
    private BigDecimal totalCost;
    private String reason;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/LoginResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.UserRole;
import lombok.Builder;
import lombok.Data;

import java.util.Set;

@Data
@Builder
public class LoginResponse {
    private Set<UserRole> roles;
    private String token;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/MidtransChargeResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

@Data
public class MidtransChargeResponse {
    @JsonProperty("transaction_id")
    private String transactionId;

    @JsonProperty("order_id")
    private String orderId;

    @JsonProperty("payment_type")
    private String paymentType;

    @JsonProperty("transaction_status")
    private String transactionStatus;

    @JsonProperty("va_numbers")
    private Object vaNumbers;

    @JsonProperty("redirect_url")
    private String redirectUrl;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/PartnerDetailResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PartnerDetailResponse {
    private String bankName;
    private String bankAccountName;
    private String bankAccountNumber;
    private boolean isVerified;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/PayoutResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
public class PayoutResponse {
    private String id;
    private String partnerName;
    private BigDecimal amount;
    private PayoutStatus status;
    private LocalDateTime requestedAt;
    private LocalDateTime processedAt;
    private String bankDetailsSnapshot;
    private String notes;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/PickupPointResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class PickupPointResponse {
    private String pickupPointID;
    private String locationName;
    private String address;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/RegisterResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class RegisterResponse {
    private String userID;
    private String email;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/RevenueTrendResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
public class RevenueTrendResponse {
    private List<String> labels;
    private List<BigDecimal> data;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/TransactionDetailResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class TransactionDetailResponse {
    private String transactionID;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private BigDecimal baseCost;
    private BigDecimal totalCost;
    private PaymentStatus paymentStatus;
    private BookingStatus bookingStatus;
    private BikeResponse bike;
    private UserResponse customer;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/TransactionResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;

import lombok.Builder;
import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
public class TransactionResponse {
    private String transactionID;
    private LocalDateTime startDate;
    private LocalDateTime endDate;
    private BigDecimal baseCost;
    private BigDecimal totalCost;
    private PaymentStatus paymentStatus;
    private BookingStatus bookingStatus;

    @Data
    @Builder
    public static class AdditionalFeeResponse {
        private String feeID;
        private String description;
        private BigDecimal amount;
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/dto/response/UserResponse.java
---

package com.doaibu.rebikeapi.dto.response;

import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class UserResponse {
    private String userID;
    private String firstName;
    private String lastName;
    private String email;
    private String phoneNumber;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Bike.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.BikeStatus;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.util.Objects;
import java.util.Set;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "mst_bike")
public class Bike {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(nullable = false)
    private String name;

    @Column(name = "photo_url", nullable = false)
    private String photoURL;

    @Column(nullable = false)
    private String brand;

    @Column(name = "plate_number", nullable = false, unique = true)
    private String plateNumber;

    @Column(nullable = false)
    private int year;

    @Column(name = "machine_capacity", nullable = false)
    private String machineCapacity;

    @Column(name = "transmission_type", nullable = false)
    private String transmissionType;

    @Column(name = "weekday_price_per_day", nullable = false)
    private BigDecimal weekdayPricePerDay;

    @Column(name = "weekend_price_per_day", nullable = false)
    private BigDecimal weekendPricePerDay;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private BikeStatus status;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "partner_id", nullable = false)
    private User partner;

    @OneToMany(mappedBy = "bike", cascade = CascadeType.ALL)
    private Set<Transaction> transactions;

    @ManyToMany
    @JoinTable(
            name = "trx_bike_usage_policy",
            joinColumns = @JoinColumn(name = "bike_id"),
            inverseJoinColumns = @JoinColumn(name = "usage_policy_id")
    )
    private Set<UsagePolicy> usagePolicies;

    @Version
    private Long version;

    @Override
    public final boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Bike bike = (Bike) o;
        return id != null && Objects.equals(id, bike.id);
    }

    @Override
    public final int hashCode() {
        return Objects.hash(id);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/ChatMessage.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "chat_messages")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ChatMessage {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @ManyToOne
    @JoinColumn(name = "sender_id")
    private User sender;

    @ManyToOne
    @JoinColumn(name = "recipient_id")
    private User recipient;

    @Lob
    @Column(columnDefinition = "TEXT")
    private String content;

    private LocalDateTime timestamp;

    @Enumerated(EnumType.STRING)
    private MessageType type;

    public enum MessageType {
        TEXT,
        IMAGE
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Partner.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "mst_partner")
public class Partner {
    @Id
    private String id;

    @OneToOne
    @MapsId
    @JoinColumn(name = "id")
    private User user;

    @Column(name = "location_name", nullable = true)
    private String locationName;

    @Column(name = "bank_name", nullable = true)
    private String bankName;

    @Column(name = "bank_account_name", nullable = true)
    private String bankAccountName;

    @Column(name = "bank_account_number", nullable = true)
    private String bankAccountNumber;

    @Column(name = "is_verified", nullable = false)
    private boolean isVerified;
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Payment.java
---

package com.doaibu.rebikeapi.entity;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import com.doaibu.rebikeapi.constant.PaymentStatus;

import jakarta.persistence.*;
import lombok.*;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "trx_payment")
public class Payment {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(nullable = false, unique = true)
    private String orderId;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private PaymentStatus status;

    @Column(name = "payment_type")
    private String paymentType;

    @Column(nullable = false)
    private BigDecimal amount;

    @Column(name = "va_number")
    private String vaNumber;

    @Column(name = "bank")
    private String bank;

    @Column(name = "snap_url")
    private String snapUrl;

    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @OneToOne
    @JoinColumn(name = "transaction_id", nullable = false)
    private Transaction transaction;

    @PrePersist
    public void prePersist() {
        this.createdAt = LocalDateTime.now();
    }

    @PreUpdate
    public void preUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Payout.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "trx_payout")
public class Payout {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "partner_id", nullable = false)
    private User partner;

    @Column(nullable = false)
    private BigDecimal amount;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private PayoutStatus status;

    @Column(name = "requested_at", nullable = false)
    private LocalDateTime requestedAt;

    @Column(name = "processed_at")
    private LocalDateTime processedAt;

    @Column(name = "bank_details_snapshot", columnDefinition = "TEXT")
    private String bankDetailsSnapshot;

    @Column
    private String notes;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/PickupPoint.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
@Table(name = "mst_pickup_point")
public class PickupPoint {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(name = "location_name", nullable = false)
    private String locationName;

    @Column(columnDefinition = "TEXT", nullable = false)
    private String address;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Role.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.UserRole;
import jakarta.persistence.*;
import lombok.*;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
@Table(name = "mst_role")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole name;
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/SystemConfiguration.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "system_configuration")
public class SystemConfiguration {
    @Id
    private String configKey;
    private String configValue;
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/Transaction.java
---

package com.doaibu.rebikeapi.entity;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;
import jakarta.persistence.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
@Table(name = "trx_transaction")
public class Transaction {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "bike_id", nullable = false)
    private Bike bike;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "customer_id", nullable = false)
    private User customer;

    @Column(name = "start_date", nullable = false)
    private LocalDateTime startDate;

    @Column(name = "end_date", nullable = false)
    private LocalDateTime endDate;

    @Column(name = "base_cost", nullable = false)
    private BigDecimal baseCost;

    @Column(name = "additional_costs", nullable = false)
    private BigDecimal additionalCosts;

    @Column(name = "total_cost", nullable = false)
    private BigDecimal totalCost;

    @Enumerated(EnumType.STRING)
    @Column(name = "booking_status", nullable = false)
    private BookingStatus bookingStatus;

    @Enumerated(EnumType.STRING)
    @Column(name = "payment_status", nullable = false)
    private PaymentStatus paymentStatus;

    @OneToOne(mappedBy = "transaction", cascade = CascadeType.ALL)
    private Payment payment;

    @Column(name = "booking_date")
    private LocalDateTime bookingDate;

    @Column(name = "is_flagged_as_potential_fraud")
    private boolean isFlaggedAsPotentialFraud = false;

    @Column(name = "fraud_flag_reason")
    private String fraudFlagReason;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @PrePersist
    public void prePersist() {
        this.createdAt = LocalDateTime.now();
    }

    @PreUpdate
    public void preUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/UsagePolicy.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;

import java.util.Objects;
import java.util.Set;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "mst_usage_policy")
public class UsagePolicy {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(name = "policy_name", nullable = false)
    private String policyName;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(name = "is_permitted", nullable = false)
    private boolean isPermitted;

    @ManyToMany(mappedBy = "usagePolicies")
    private Set<Bike> bikes;

    @Override
    public final boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        UsagePolicy that = (UsagePolicy) o;
        return id != null && Objects.equals(id, that.id);
    }

    @Override
    public final int hashCode() {
        return Objects.hash(id);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/entity/User.java
---

package com.doaibu.rebikeapi.entity;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import java.time.LocalDateTime;
import java.util.Collection;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;

@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
@Entity
@Table(name = "mst_user")
public class User implements UserDetails {
    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private String id;

    @Column(name = "first_name", nullable = false)
    private String firstName;

    @Column(name = "last_name")
    private String lastName;

    @Column(nullable = false, unique = true)
    private String username;

    @Column(nullable = false, unique = true)
    private String email;

    @Column(nullable = false)
    private String password;

    @Column(name = "phone_number", nullable = false)
    private String phoneNumber;

    @Column(name = "photo_url")
    private String photoUrl;

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(name = "is_account_non_expired")
    private boolean isAccountNonExpired;

    @Column(name = "is_account_non_locked")
    private boolean isAccountNonLocked;

    @Column(name = "is_credentials_non_expired")
    private boolean isCredentialsNonExpired;

    @Column(name = "is_enabled")
    private boolean isEnabled = false;

    @Column(name = "is_email_verified")
    private boolean isEmailVerified = false;

    @Column(name = "verification_otp")
    private String verificationOtp;

    @Column(name = "otp_expiry_time")
    private LocalDateTime otpExpiryTime;

    @Column(name = "reset_password_token")
    private String resetPasswordToken;

    @Column(name = "reset_password_token_expiry")
    private LocalDateTime resetPasswordTokenExpiry;

    @Column(name = "fcm_token")
    private String fcmToken;

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(name = "trx_user_role", joinColumns = @JoinColumn(name = "user_id"), inverseJoinColumns = @JoinColumn(name = "role_id"))
    private Set<Role> roles;

    @OneToMany(mappedBy = "customer", cascade = CascadeType.ALL)
    private Set<Transaction> transactions;

    @OneToMany(mappedBy = "partner", cascade = CascadeType.ALL)
    private Set<Bike> ownedBikes;

    @OneToOne(mappedBy = "user", cascade = CascadeType.ALL)
    private Partner partnerDetail;

    @Version
    private Long version;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return roles.stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName().name()))
                .collect(Collectors.toList());
    }

    @Override
    public String getUsername() { return username; }

    @Override
    public String getPassword() { return password; }

    @Override
    public boolean isAccountNonExpired() { return isAccountNonExpired; }

    @Override
    public boolean isAccountNonLocked() { return isAccountNonLocked; }

    @Override
    public boolean isCredentialsNonExpired() { return isCredentialsNonExpired; }

    @Override
    public boolean isEnabled() { return isEnabled; }

    @Override
    public final boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        User user = (User) o;
        return id != null && Objects.equals(id, user.id);
    }

    @Override
    public final int hashCode() {
        return Objects.hash(id);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/exception/CustomException.java
---

package com.doaibu.rebikeapi.exception;

public class CustomException {

    public static class BadRequestException extends RuntimeException {
        public BadRequestException(String message) {
            super(message);
        }
    }

    public static class AuthenticationException extends RuntimeException {
        public AuthenticationException(String message) {
            super(message);
        }
    }

    public static class AuthorizationException extends RuntimeException {
        public AuthorizationException(String message) {
            super(message);
        }
    }

    public static class ResourceNotFoundException extends RuntimeException {
        public ResourceNotFoundException(String message) {
            super(message);
        }
    }

    public static class ConflictException extends RuntimeException {
        public ConflictException(String message) {
            super(message);
        }
    }

    public static class PaymentException extends RuntimeException {
        public PaymentException(String message) {
            super(message);
        }
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/exception/GlobalExceptionHandler.java
---

package com.doaibu.rebikeapi.exception;

import com.doaibu.rebikeapi.util.ResponseUtil;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(CustomException.BadRequestException.class)
    public ResponseEntity<?> handleBadRequest(CustomException.BadRequestException ex) {
        return ResponseUtil.response(
                HttpStatus.BAD_REQUEST,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.AuthenticationException.class)
    public ResponseEntity<?> handleAuthentication(CustomException.AuthenticationException ex) {
        return ResponseUtil.response(
                HttpStatus.UNAUTHORIZED,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.AuthorizationException.class)
    public ResponseEntity<?> handleAuthorization(CustomException.AuthorizationException ex) {
        return ResponseUtil.response(
                HttpStatus.FORBIDDEN,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.ResourceNotFoundException.class)
    public ResponseEntity<?> handleNotFound(CustomException.ResourceNotFoundException ex) {
        return ResponseUtil.response(
                HttpStatus.NOT_FOUND,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.ConflictException.class)
    public ResponseEntity<?> handleConflict(CustomException.ConflictException ex) {
        return ResponseUtil.response(
                HttpStatus.CONFLICT,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(CustomException.PaymentException.class)
    public ResponseEntity<?> handlePayment(CustomException.PaymentException ex) {
        return ResponseUtil.response(
                HttpStatus.PAYMENT_REQUIRED,
                ex.getMessage(),
                null);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleAll(Exception ex) {
        ex.printStackTrace();

        return ResponseUtil.response(
                HttpStatus.INTERNAL_SERVER_ERROR,
                "An unexpected internal server error occurred.",
                null);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/BikeRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.Bike;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface BikeRepository extends JpaRepository<Bike, String> {
    Page<Bike> findByPartner(User partner, Pageable pageable);
    Optional<Bike> findByPlateNumber(String plateNumber);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/ChatMessageRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.ChatMessage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ChatMessageRepository extends JpaRepository<ChatMessage, String> {

    @Query("SELECT cm FROM ChatMessage cm WHERE " +
            "(cm.sender.id = :userA_id AND cm.recipient.id = :userB_id) OR " +
            "(cm.sender.id = :userB_id AND cm.recipient.id = :userA_id) " +
            "ORDER BY cm.timestamp ASC")
    List<ChatMessage> findConversationBetweenUsers(@Param("userA_id") String userA_id,
                                                   @Param("userB_id") String userB_id);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PartnerRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface PartnerRepository extends JpaRepository<Partner, String> {
    Optional<Partner> findByUser(User user);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PaymentRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.Payment;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface PaymentRepository extends JpaRepository<Payment, String> {
    Optional<Payment> findByOrderId(String orderId);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PayoutRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.PayoutStatus;
import com.doaibu.rebikeapi.entity.Payout;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface PayoutRepository extends JpaRepository<Payout, String> {
    List<Payout> findByPartnerOrderByRequestedAtDesc(User partner);
    List<Payout> findAllByStatus(PayoutStatus status);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/PickupPointRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.PickupPoint;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface PickupPointRepository extends JpaRepository<PickupPoint, String> {

}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/RoleRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.Role;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface RoleRepository extends JpaRepository<Role, String> {
    Optional<Role> findByName(UserRole name);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/SystemConfigurationRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.SystemConfiguration;
import org.springframework.data.jpa.repository.JpaRepository;

public interface SystemConfigurationRepository extends JpaRepository<SystemConfiguration, String> {
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/TransactionRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface TransactionRepository extends JpaRepository<Transaction, String> {
    List<Transaction> findByCustomer(User customer);

    List<Transaction> findByBike_Partner(User partner);

    @Query("SELECT SUM(t.totalCost) FROM Transaction t WHERE t.bookingStatus = :status")
    BigDecimal sumTotalCostByBookingStatus(BookingStatus status);

    List<Transaction> findAllByBookingStatusAndStartDateBetween(BookingStatus bookingStatus, LocalDateTime start, LocalDateTime end);

    List<Transaction> findAllByIsFlaggedAsPotentialFraud(boolean isFlagged);

    List<Transaction> findAllByCreatedAtAfter(LocalDateTime dateTime);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/UsagePolicyRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.entity.UsagePolicy;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UsagePolicyRepository extends JpaRepository<UsagePolicy, String> {
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/repository/UserRepository.java
---

package com.doaibu.rebikeapi.repository;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.response.AdminPartnerResponse;
import com.doaibu.rebikeapi.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import com.doaibu.rebikeapi.entity.Role;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.Set;

@Repository
public interface UserRepository extends JpaRepository<User, String> {
    Optional<User> findByUsername(String username);

    Optional<User> findByEmail(String email);

    Boolean existsByEmail(String email);

    Boolean existsByUsername(String username);

    @Query("SELECT new com.doaibu.rebikeapi.dto.response.AdminPartnerResponse(" +
            "u.id, " +
            "CONCAT(u.firstName, ' ', u.lastName), " +
            "u.email, " +
            "p.locationName, " +
            "size(u.ownedBikes), " +
            "p.isVerified) " +
            "FROM User u JOIN u.partnerDetail p WHERE :role MEMBER OF u.roles")
    Page<AdminPartnerResponse> findAllPartnersWithBikeCount(@Param("role") Role role, Pageable pageable);

    List<User> findAllByRoles_Name(UserRole name);

    long countByRolesContaining(Role partnerRole);

    @Query("SELECT COUNT(u) FROM User u WHERE u.createdAt BETWEEN :start AND :end")
    long countNewUsersBetween(@Param("start") LocalDateTime start, @Param("end") LocalDateTime end);

    @Query("SELECT COUNT(u) FROM User u WHERE :role MEMBER OF u.roles AND u.createdAt BETWEEN :start AND :end")
    long countNewUsersWithRoleBetween(@Param("role") Role role, @Param("start") LocalDateTime start, @Param("end") LocalDateTime end);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/security/CustomOAuth2AuthenticationSuccessHandler.java
---

package com.doaibu.rebikeapi.security;

import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.service.AuthService;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.core.user.DefaultOAuth2User;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;

import java.io.IOException;

@Component
@RequiredArgsConstructor
public class CustomOAuth2AuthenticationSuccessHandler implements AuthenticationSuccessHandler {

    private final AuthService authService;
    private final JwtUtil jwtUtil;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        DefaultOAuth2User oauth2User = (DefaultOAuth2User) authentication.getPrincipal();
        String email = oauth2User.getAttribute("email");
        String name = oauth2User.getAttribute("name");

        User user = authService.processOAuthPostLogin(email, name);
        String token = jwtUtil.generateToken(user);

        String redirectUrl = UriComponentsBuilder.fromUriString("http://localhost:5173/auth/sso-callback")
                .queryParam("token", token)
                .build().toUriString();

        response.sendRedirect(redirectUrl);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/security/JwtAuthFilter.java
---

package com.doaibu.rebikeapi.security;

import com.doaibu.rebikeapi.service.impl.UserDetailsServiceImpl;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@RequiredArgsConstructor
@Component
public class JwtAuthFilter extends OncePerRequestFilter {
    private final JwtUtil jwtUtil;
    private final UserDetailsServiceImpl userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        String authHeader = request.getHeader("Authorization");

        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);

            String username = jwtUtil.extractUsername(token);

            if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) { // Pastikan belum ada autentikasi
                if (jwtUtil.validateToken(token)) {
                    UserDetails userDetails = userDetailsService.loadUserByUsername(username);

                    UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
                            userDetails,
                            null,
                            userDetails.getAuthorities());

                    SecurityContextHolder.getContext().setAuthentication(auth);
                } else {
                }
            } else {
            }
        } else {
        }

        filterChain.doFilter(request, response);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/security/JwtUtil.java
---

package com.doaibu.rebikeapi.security;

import com.doaibu.rebikeapi.config.JwtConfig;
import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTVerifier;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.exceptions.JWTVerificationException;
import com.auth0.jwt.interfaces.DecodedJWT;
import com.doaibu.rebikeapi.entity.User;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.stereotype.Component;

import java.util.Date;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class JwtUtil {

    private final JwtConfig jwtConfig;

    public String generateToken(User user) {
        return JWT.create()
                .withSubject(user.getUsername())
                .withClaim("roles", user.getAuthorities().stream().map(GrantedAuthority::getAuthority).collect(Collectors.toList()))
                .withClaim("firstName", user.getFirstName())
                .withClaim("lastName", user.getLastName())
                .withClaim("email", user.getEmail())
                .withClaim("phoneNumber", user.getPhoneNumber())
                .withClaim("photoUrl", user.getPhotoUrl())
                .withIssuedAt(new Date())
                .withExpiresAt(new Date(System.currentTimeMillis() + jwtConfig.getExpirationMs()))
                .sign(Algorithm.HMAC256(jwtConfig.getSecretKey()));
    }

    public boolean validateToken(String token) {
        try {
            JWTVerifier verifier = JWT.require(Algorithm.HMAC256(jwtConfig.getSecretKey())).build();
            verifier.verify(token);
            return true;
        } catch (JWTVerificationException e) {
            return false;
        }
    }

    public String extractUsername(String token) {
        DecodedJWT jwt = JWT.decode(token);
        return jwt.getSubject();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AdminDashboardServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.response.DashboardSummaryResponse;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.repository.RoleRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.AdminDashboardService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.TextStyle;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

@Service
@RequiredArgsConstructor
public class AdminDashboardServiceImpl implements AdminDashboardService {

    private final UserRepository userRepository;
    private final TransactionRepository transactionRepository;
    private final RoleRepository roleRepository;
    private static final BigDecimal PLATFORM_FEE_PERCENTAGE = new BigDecimal("0.10");

    @Override
    public DashboardSummaryResponse getDashboardSummary() {
        Role partnerRole = roleRepository.findByName(UserRole.PARTNER)
                .orElseThrow(() -> new IllegalStateException("Partner role not found in database"));

        long totalUsers = userRepository.count();
        long totalPartners = userRepository.countByRolesContaining(partnerRole);
        long totalTransactions = transactionRepository.count();

        BigDecimal totalRevenue = transactionRepository.sumTotalCostByBookingStatus(BookingStatus.COMPLETED);
        BigDecimal platformRevenue = (totalRevenue != null) ? totalRevenue.multiply(PLATFORM_FEE_PERCENTAGE) : BigDecimal.ZERO;

        LocalDateTime now = LocalDateTime.now();
        List<String> labels = IntStream.range(0, 6)
                .mapToObj(i -> now.minusMonths(i).getMonth())
                .map(month -> month.getDisplayName(TextStyle.SHORT, new Locale("id", "ID")))
                .collect(Collectors.toList());
        java.util.Collections.reverse(labels);

        List<Long> userGrowthData = new ArrayList<>();
        List<Long> partnerGrowthData = new ArrayList<>();

        for (int i = 5; i >= 0; i--) {
            LocalDateTime startOfMonth = now.minusMonths(i).withDayOfMonth(1).withHour(0).withMinute(0).withSecond(0);
            LocalDateTime endOfMonth = startOfMonth.plusMonths(1).minusNanos(1);
            userGrowthData.add(userRepository.countNewUsersBetween(startOfMonth, endOfMonth));
            partnerGrowthData.add(userRepository.countNewUsersWithRoleBetween(partnerRole, startOfMonth, endOfMonth));
        }

        DashboardSummaryResponse.ChartData userGrowth = DashboardSummaryResponse.ChartData.builder()
                .labels(labels)
                .data(userGrowthData)
                .build();
        DashboardSummaryResponse.ChartData partnerGrowth = DashboardSummaryResponse.ChartData.builder()
                .labels(labels)
                .data(partnerGrowthData)
                .build();

        return DashboardSummaryResponse.builder()
                .totalUsers(totalUsers)
                .totalPartners(totalPartners)
                .totalTransactions(totalTransactions)
                .platformRevenue(platformRevenue)
                .userGrowth(userGrowth)
                .partnerGrowth(partnerGrowth)
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AdminSettingServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.entity.SystemConfiguration;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.SystemConfigurationRepository;
import com.doaibu.rebikeapi.service.AdminSettingService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;

@Service
@RequiredArgsConstructor
public class AdminSettingServiceImpl implements AdminSettingService {

    private final SystemConfigurationRepository systemConfigRepository;
    private static final String FEE_KEY = "platform_fee_percentage";

    @Override
    public BigDecimal getPlatformFeePercentage() {
        return new BigDecimal(systemConfigRepository.findById(FEE_KEY)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Platform fee setting not found."))
                .getConfigValue());
    }

    @Override
    public void updatePlatformFeePercentage(BigDecimal newFee) {
        if (newFee.compareTo(BigDecimal.ZERO) < 0 || newFee.compareTo(new BigDecimal("100")) > 0) {
            throw new CustomException.BadRequestException("Fee percentage must be between 0 and 100.");
        }
        BigDecimal feeValue = newFee.divide(new BigDecimal("100"));

        SystemConfiguration feeConfig = systemConfigRepository.findById(FEE_KEY)
                .orElse(SystemConfiguration.builder().configKey(FEE_KEY).build());

        feeConfig.setConfigValue(feeValue.toPlainString());
        systemConfigRepository.save(feeConfig);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AIAssistantServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PayoutStatus;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.entity.Payout;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.repository.PayoutRepository;
import com.doaibu.rebikeapi.repository.SystemConfigurationRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.PayoutService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import com.doaibu.rebikeapi.service.AIAssistantService;

import java.math.BigDecimal;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class AIAssistantServiceImpl implements AIAssistantService{

    private final PayoutRepository payoutRepository;
    private final TransactionRepository transactionRepository;
    private final SystemConfigurationRepository systemConfigRepository;
    private final PayoutService payoutService;

    @Override
    @Scheduled(cron = "0 */15 * * * *")
    public void autoProcessPendingPayouts() {
        log.info("[AI Assistant] Running job: Auto Process Pending Payouts...");
        List<Payout> pendingPayouts = payoutRepository.findAllByStatus(PayoutStatus.PENDING);

        if (pendingPayouts.isEmpty()) {
            log.info("[AI Assistant] No pending payouts to process.");
            return;
        }

        log.info("[AI Assistant] Found {} pending payout(s).", pendingPayouts.size());

        for (Payout payout : pendingPayouts) {
            try {
                User partner = payout.getPartner();
                BigDecimal requestedAmount = payout.getAmount();

                BigDecimal availableBalance = calculateAvailableBalance(partner);

                if (requestedAmount.compareTo(availableBalance) <= 0) {
                    ProcessPayoutRequest processRequest = new ProcessPayoutRequest();
                    processRequest.setStatus(PayoutStatus.APPROVED);
                    processRequest.setNotes("Auto-approved by AI Assistant. Balance sufficient.");
                    payoutService.processPayout(payout.getId(), processRequest);
                    log.info("[AI Assistant] Auto-approved payout ID: {} for partner: {}", payout.getId(), partner.getUsername());
                } else {
                    ProcessPayoutRequest processRequest = new ProcessPayoutRequest();
                    processRequest.setStatus(PayoutStatus.REJECTED);
                    processRequest.setNotes("Auto-rejected by AI Assistant. Insufficient balance. Available: " + availableBalance);
                    payoutService.processPayout(payout.getId(), processRequest);
                    log.info("[AI Assistant] Auto-rejected payout ID: {} for partner: {}. Reason: Insufficient balance.", payout.getId(), partner.getUsername());
                }
            } catch (Exception e) {
                log.error("[AI Assistant] Error processing payout ID: {}. Error: {}", payout.getId(), e.getMessage());
            }
        }
    }

    private BigDecimal calculateAvailableBalance(User partner) {
        BigDecimal totalRevenue = transactionRepository.findByBike_Partner(partner).stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .map(Transaction::getTotalCost)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal platformFeePercentage = new BigDecimal(
                systemConfigRepository.findById("platform_fee_percentage")
                        .orElseThrow(() -> new IllegalStateException("Platform fee not configured."))
                        .getConfigValue()
        );

        BigDecimal totalFee = totalRevenue.multiply(platformFeePercentage);
        BigDecimal netRevenue = totalRevenue.subtract(totalFee);

        List<Payout> partnerPayouts = payoutRepository.findByPartnerOrderByRequestedAtDesc(partner);
        BigDecimal totalPaidOutOrPending = partnerPayouts.stream()
                .filter(p -> p.getStatus() == PayoutStatus.APPROVED || p.getStatus() == PayoutStatus.PROCESSING || p.getStatus() == PayoutStatus.PENDING)
                .map(Payout::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        return netRevenue.subtract(totalPaidOutOrPending);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/AuthServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.LoginResponse;
import com.doaibu.rebikeapi.dto.response.RegisterResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.security.JwtUtil;
import com.doaibu.rebikeapi.service.*;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.apache.commons.text.similarity.FuzzyScore;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.security.SecureRandom;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class AuthServiceImpl implements AuthService {

    private static final Logger logger = LoggerFactory.getLogger(AuthServiceImpl.class);

    private final UserRepository userRepository;
    private final RoleService roleService;
    private final PasswordEncoder passwordEncoder;
    private final EmailService emailService;
    private final JwtUtil jwtUtil;
    private final NotificationService notificationService;
    private final UserService userService;
    private final Random random = new SecureRandom();

    @Value("${app.user.default-photo-url}")
    private String defaultPhotoUrl;

    @Override //
    @Transactional //
    public RegisterResponse registerCustomer(RegisterCustomerRequest request) {
        try {
            if (request.getEmail() == null || request.getEmail().isBlank() ||
                    request.getPassword() == null || request.getPassword().isBlank()) {
                throw new CustomException.BadRequestException("Email and password are required."); // [cite: 892, 893]
            }

            // --- PERUBAHAN DIMULAI DI SINI ---
            Optional<User> existingUserOptional = userRepository.findByEmail(request.getEmail()); // [cite: 788]

            if (existingUserOptional.isPresent()) {
                User existingUser = existingUserOptional.get();
                if (existingUser.isEmailVerified()) { // [cite: 737]
                    // Jika email sudah terverifikasi, berarti akun sudah sepenuhnya terdaftar.
                    throw new CustomException.ConflictException("Email already in use and verified. Please login or use 'Forgot Password'."); // [cite: 893]
                } else {
                    // Jika email sudah ada tapi belum terverifikasi, kita bisa asumsikan pengguna ingin melanjutkan verifikasi.
                    // Kirim ulang OTP dan berikan respons yang sesuai.
                    // Penting: Di sini Anda mungkin ingin memperbarui OTP dan waktu kedaluwarsanya di user yang sudah ada.
                    String newOtp = generateOtp(); //
                    existingUser.setVerificationOtp(passwordEncoder.encode(newOtp)); // [cite: 737]
                    existingUser.setOtpExpiryTime(LocalDateTime.now().plusMinutes(10)); // [cite: 738]
                    userRepository.save(existingUser); //
                    sendVerificationEmail(existingUser, newOtp); //

                    return RegisterResponse.builder()
                            .userID(existingUser.getId()) //
                            .email(existingUser.getEmail()) //
                            .build(); //
                }
            }
            // --- PERUBAHAN BERAKHIR DI SINI ---


            if (userRepository.existsByUsername(request.getUsername())) { // [cite: 894]
                throw new CustomException.ConflictException("Username already in use."); // [cite: 895]
            }

            Set<Role> customerRole = new HashSet<>(); //
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER)); // [cite: 895]
            User user = buildUser(request.getFirstName(), request.getLastName(), request.getUsername(), request.getEmail(), request.getPassword(), request.getPhoneNumber(), customerRole); // [cite: 896]
            User savedUser = userRepository.save(user); //
            return mapToRegisterResponse(savedUser); // [cite: 897]
        } catch (CustomException.BadRequestException e) {
            logger.error("Failed to send verification email for {}. Rolling back transaction.", request.getEmail()); // [cite: 897]
            throw e; // [cite: 898]
        }
    }

    @Override //
    @Transactional //
    public RegisterResponse registerPartner(RegisterPartnerRequest request) {
        User savedUser; // [cite: 898]
        try {
            if (request.getEmail() == null || request.getEmail().isBlank() ||
                    request.getPassword() == null || request.getPassword().isBlank()) {
                throw new CustomException.BadRequestException("Email and password are required."); // [cite: 899, 900]
            }

            // --- PERUBAHAN DIMULAI DI SINI (MIRIP DENGAN REGISTER CUSTOMER) ---
            Optional<User> existingUserOptional = userRepository.findByEmail(request.getEmail()); // [cite: 788]

            if (existingUserOptional.isPresent()) {
                User existingUser = existingUserOptional.get();
                if (existingUser.isEmailVerified()) { // [cite: 737]
                    // Jika email sudah terverifikasi, berarti akun sudah sepenuhnya terdaftar.
                    throw new CustomException.ConflictException("Email already in use and verified. Please login or use 'Forgot Password'."); // [cite: 900]
                } else {
                    // Jika email sudah ada tapi belum terverifikasi, Anda bisa memilih untuk:
                    // 1. Mengirim ulang OTP dan mengembalikan respons yang sesuai.
                    // 2. Jika Anda tidak ingin partner auto-resend OTP saat register ulang,
                    //    Anda bisa lempar exception dengan pesan yang mengarahkan mereka ke resend OTP.
                    //    Untuk tujuan ini, saya akan asumsikan kita kirim ulang OTP juga.

                    String newOtp = generateOtp(); //
                    existingUser.setVerificationOtp(passwordEncoder.encode(newOtp)); // [cite: 737]
                    existingUser.setOtpExpiryTime(LocalDateTime.now().plusMinutes(10)); // [cite: 738]
                    userRepository.save(existingUser); //
                    sendVerificationEmail(existingUser, newOtp); //

                    return RegisterResponse.builder()
                            .userID(existingUser.getId()) //
                            .email(existingUser.getEmail()) //
                            .build(); //
                }
            }
            // --- PERUBAHAN BERAKHIR DI SINI ---

            if (userRepository.existsByUsername(request.getUsername())) { // [cite: 901]
                throw new CustomException.ConflictException("Username already in use."); // [cite: 902]
            }

            Set<Role> partnerRole = new HashSet<>(); //
            partnerRole.add(roleService.getOrCreate(UserRole.PARTNER)); // [cite: 902]
            User user = buildUser(
                    request.getFirstName(), request.getLastName(), request.getUsername(),
                    request.getEmail(), request.getPassword(), request.getPhoneNumber(),
                    partnerRole //
            ); // [cite: 903]
            Partner partner = Partner.builder()
                    .user(user) //
                    .isVerified(false) //
                    .locationName(request.getLocationName()) //
                    .bankAccountName(request.getBankAccountName()) //
                    .bankAccountNumber(request.getBankAccountNumber()) // [cite: 905]
                    .bankName(request.getBankName()) //
                    .build(); // [cite: 905]
            user.setPartnerDetail(partner); // [cite: 906]
            savedUser = userRepository.save(user); //

            Partner partnerDetail = savedUser.getPartnerDetail(); //
            if (isPartnerDataTrustworthy(savedUser, partnerDetail)) { //
                userService.verifyPartner(savedUser.getId(), true); //
                logger.info("[AI Assistant] Auto-verified partner: {}", savedUser.getEmail()); // [cite: 907]
            }

        } catch (CustomException.BadRequestException e) {
            logger.error("Failed to send verification email for partner {}. Rolling back transaction.", request.getEmail()); // [cite: 908]
            throw e; // [cite: 908]
        }

        try {
            List<User> admins = userRepository.findAllByRoles_Name(UserRole.ADMIN); // [cite: 908]
            for (User admin : admins) { //
                if (admin.getFcmToken() != null && !admin.getFcmToken().isEmpty()) { //
                    String locationName = savedUser.getPartnerDetail() != null ? //
                            savedUser.getPartnerDetail().getLocationName() : "N/A"; // [cite: 910]
                    notificationService.sendNotification(
                            admin.getFcmToken(), //
                            "🆕 Pendaftaran Mitra Baru", //
                            "Mitra '" + locationName + "' telah mendaftar dan menunggu verifikasi.", // [cite: 911]
                            Map.of("partnerId", savedUser.getId(), "screen", "PartnerVerification") //
                    ); // [cite: 912]
                }
            }
        } catch (Exception e) {
            System.err.println("Gagal mengirim notifikasi pendaftaran mitra ke admin: " + e.getMessage()); // [cite: 912]
        }

        return mapToRegisterResponse(savedUser); // [cite: 913]
    }

    private boolean isPartnerDataTrustworthy(User user, Partner partner) {
        if (user == null || partner == null) {
            return false;
        }

        if (partner.getBankName() == null || partner.getBankAccountNumber() == null || partner.getBankAccountName() == null) {
            return false;
        }

        FuzzyScore fuzzyScore = new FuzzyScore(Locale.ENGLISH);
        String fullName = (user.getFirstName() + " " + user.getLastName()).toLowerCase();
        String bankAccountName = partner.getBankAccountName().toLowerCase();

        Integer score = fuzzyScore.fuzzyScore(fullName, bankAccountName);

        if (score < 15) {
            logger.warn("[AI Assistant] Partner verification check failed for {}. Reason: Name mismatch (Score: {})", user.getEmail(), score);
            return false;
        }

        logger.info("[AI Assistant] Partner verification check passed for {}. Name match score: {}", user.getEmail(), score);
        return true;
    }

    @Override
    @Transactional
    public void verifyEmailOtp(String email, String otp) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (user.isEmailVerified()) {
            throw new CustomException.BadRequestException("Email has been verified.");
        }
        if (user.getOtpExpiryTime().isBefore(LocalDateTime.now())) {
            throw new CustomException.BadRequestException("OTP code has expired.");
        }
        if (!passwordEncoder.matches(otp, user.getVerificationOtp())) {
            throw new CustomException.BadRequestException("OTP code does not match.");
        }

        user.setEmailVerified(true);
        user.setEnabled(true);
        user.setVerificationOtp(null);
        user.setOtpExpiryTime(null);
        userRepository.save(user);
    }

    @Override
    @Transactional
    public void resendVerificationOtp(String email) {
        User user = userRepository.findByEmail(email)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (user.isEmailVerified()) {
            throw new CustomException.BadRequestException("Email has been verified.");
        }
        String newOtp = generateOtp();
        user.setVerificationOtp(passwordEncoder.encode(newOtp));
        user.setOtpExpiryTime(LocalDateTime.now().plusMinutes(10));
        userRepository.save(user);
        sendVerificationEmail(user, newOtp);
    }

    @Override
    public LoginResponse login(LoginRequest request) {
        User user = userRepository.findByEmail(request.getEmail())
                .orElseThrow(() -> new CustomException.AuthenticationException("Email or password is incorrect."));
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new CustomException.AuthenticationException("Email or password is incorrect.");
        }
        if (!user.isEmailVerified()) {
            throw new CustomException.AuthorizationException("Email is not verified. Please try again.");
        }
        if (!user.isEnabled()) {
            throw new CustomException.AuthorizationException("Your account is disabled.");
        }

        String token = jwtUtil.generateToken(user);
        return LoginResponse.builder()
                .roles(user.getRoles().stream().map(Role::getName).collect(Collectors.toSet()))
                .token(token)
                .build();
    }

    @Override
    @Transactional
    public void processForgotPassword(String email, String feBaseUrl) {
        userRepository.findByEmail(email).ifPresent(user -> {
            String otp = generateOtp();
            user.setResetPasswordToken(passwordEncoder.encode(otp));
            user.setResetPasswordTokenExpiry(LocalDateTime.now().plusMinutes(10));
            userRepository.save(user);

            String emailText = "Anda menerima email ini karena ada permintaan untuk mereset password akun Rebike Anda.\n\n"
                    + "Gunakan kode OTP ini untuk melanjutkan: \n\n"
                    + "Kode OTP: " + otp + "\n\n"
                    + "PENTING: Kode ini hanya berlaku selama 10 menit. Jika Anda tidak meminta ini, abaikan email ini.";

            emailService.sendEmail(user.getEmail(), "Reset Password Rebike (Berlaku 10 Menit)", emailText);
        });
    }

    @Override
    @Transactional
    public void resetPasswordWithOtp(ResetPasswordWithOtpRequest request) {
        User user = userRepository.findByEmail(request.getEmail())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (user.getResetPasswordToken() == null || user.getResetPasswordTokenExpiry().isBefore(LocalDateTime.now())) {
            throw new CustomException.BadRequestException("OTP code has expired.");
        }
        if (!passwordEncoder.matches(request.getOtp(), user.getResetPasswordToken())) {
            throw new CustomException.BadRequestException("OTP code does not match.");
        }
        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        user.setResetPasswordToken(null);
        user.setResetPasswordTokenExpiry(null);
        userRepository.save(user);
    }

    @Override
    @Transactional
    public User processOAuthPostLogin(String email, String name) {
        return userRepository.findByEmail(email).orElseGet(() -> {
            Set<Role> customerRole = new HashSet<>();
            customerRole.add(roleService.getOrCreate(UserRole.CUSTOMER));

            User newUser = User.builder()
                    .email(email).username(email).firstName(name)
                    .password(passwordEncoder.encode(UUID.randomUUID().toString()))
                    .roles(customerRole).createdAt(LocalDateTime.now())
                    .isAccountNonExpired(true).isAccountNonLocked(true).isCredentialsNonExpired(true)
                    .isEnabled(true).isEmailVerified(true)
                    .build();

            return userRepository.save(newUser);
        });
    }

    private String generateOtp() {
        return String.format("%06d", random.nextInt(999999));
    }

    private void sendVerificationEmail(User user, String otp) {
        String emailText = "Gunakan kode OTP ini untuk verifikasi email Rebike Anda.\n\n"
                + "Kode OTP: " + otp + "\n\n"
                + "PENTING: Kode ini hanya berlaku selama 10 menit. Jangan berikan kode ini kepada siapapun.";
        emailService.sendEmail(user.getEmail(), "Verifikasi Email Rebike (Berlaku 10 Menit)", emailText);
    }

    private User buildUser(String firstName, String lastName, String username, String email, String password, String phoneNumber, Set<Role> roles) {
        String otp = generateOtp();
        User user = User.builder()
                .firstName(firstName).lastName(lastName)
                .username(username).email(email)
                .password(passwordEncoder.encode(password))
                .phoneNumber(phoneNumber)
                .photoUrl(defaultPhotoUrl)
                .roles(roles).createdAt(LocalDateTime.now())
                .isAccountNonExpired(true).isAccountNonLocked(true).isCredentialsNonExpired(true)
                .isEnabled(false).isEmailVerified(false)
                .verificationOtp(passwordEncoder.encode(otp))
                .otpExpiryTime(LocalDateTime.now().plusMinutes(10))
                .build();
        sendVerificationEmail(user, otp);
        return user;
    }

    private RegisterResponse mapToRegisterResponse(User user) {
        return RegisterResponse.builder()
                .userID(user.getId())
                .email(user.getEmail())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/BikeServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.dto.request.BikeRequest;
import com.doaibu.rebikeapi.dto.response.BikeDetailResponse;
import com.doaibu.rebikeapi.dto.response.BikeResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.Bike;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.BikeRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.BikeService;
import com.doaibu.rebikeapi.service.CloudinaryService;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class BikeServiceImpl implements BikeService {

    private final BikeRepository bikeRepository;
    private final UserRepository userRepository;
    private final CloudinaryService cloudinaryService;
    private final TokenHolder tokenHolder;

    private final long maxSize = 5 * 1024 * 1024;

    @Override
    @Transactional
    public BikeResponse addBike(BikeRequest request, MultipartFile file) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (partner.getPartnerDetail() == null || !partner.getPartnerDetail().isVerified()) {
            throw new CustomException.AuthorizationException("Your partner account is not verified. Please contact administrator.");
        }

        if (file.getSize() > maxSize) {
            throw new CustomException.BadRequestException("File size exceeds 5MB limit.");
        }

        String fileName = file.getOriginalFilename();
        if (!fileName.endsWith(".jpg") && !fileName.endsWith(".jpeg") && !fileName.endsWith(".png")) {
            throw new CustomException.BadRequestException("Only JPG/PNG files are allowed.");
        }

        String url = cloudinaryService.uploadFile(file, "bikes");

        Bike bike = mapToBike(request);
        bike.setPartner(partner);
        bike.setStatus(BikeStatus.AVAILABLE);
        bike.setPhotoURL(url);
        bikeRepository.save(bike);
        return mapToBikeResponse(bike);
    }

    @Override
    public PagedResponse<BikeResponse> getAllBikes(Pageable pageable) {
        Page<Bike> bikePage = bikeRepository.findAll(pageable);
        List<BikeResponse> bikeResponses = bikePage.getContent().stream()
                .map(this::mapToBikeResponse)
                .collect(Collectors.toList());
        return PagedResponse.<BikeResponse>builder()
                .data(bikeResponses)
                .page(bikePage.getNumber())
                .size(bikePage.getSize())
                .totalElements(bikePage.getTotalElements())
                .totalPages(bikePage.getTotalPages())
                .build();
    }

    @Override
    public PagedResponse<BikeResponse> getAllMyBikes(Pageable pageable) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));
        if (!partner.getPartnerDetail().isVerified()) {
            throw new CustomException.AuthorizationException("Your partner account is not verified. Please contact administrator.");
        }

        Page<Bike> bikePage = bikeRepository.findByPartner(partner, pageable);
        List<BikeResponse> bikeResponses = bikePage.getContent().stream()
                .map(this::mapToBikeResponse)
                .collect(Collectors.toList());
        return PagedResponse.<BikeResponse>builder()
                .data(bikeResponses)
                .page(bikePage.getNumber())
                .size(bikePage.getSize())
                .totalElements(bikePage.getTotalElements())
                .totalPages(bikePage.getTotalPages())
                .build();
    }

    @Override
    public BikeDetailResponse getBikeById(String id) {
        Bike bike = bikeRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));
        return mapToBikeDetailResponse(bike);
    }

    @Override
    @Transactional
    public BikeResponse updateBike(String id, BikeRequest request) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Bike bike = bikeRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));

        if (!Objects.equals(bike.getPartner().getId(), partner.getId())) {
            throw new CustomException.AuthorizationException("You are not authorized to modify this bike.");
        }

        bike.setName(request.getName());
        bike.setPhotoURL(request.getPhotoURL());
        bike.setBrand(request.getBrand());
        bike.setPlateNumber(request.getPlateNumber());
        bike.setYear(request.getYear());
        bike.setMachineCapacity(request.getMachineCapacity());
        bike.setTransmissionType(request.getTransmissionType());
        bike.setWeekdayPricePerDay(request.getWeekdayPricePerDay());
        bike.setWeekendPricePerDay(request.getWeekendPricePerDay());
        bikeRepository.save(bike);
        return mapToBikeResponse(bike);
    }

    @Override
    @Transactional
    public BikeResponse updateBikeStatus(String bikeId, BikeStatus status) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Bike bike = bikeRepository.findById(bikeId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));
        if (!Objects.equals(bike.getPartner().getId(), partner.getId())) {
            throw new CustomException.AuthorizationException("You are not authorized to modify this bike.");
        }

        bike.setStatus(status);
        bikeRepository.save(bike);
        return mapToBikeResponse(bike);
    }

    @Override
    @Transactional
    public void deleteBike(String id) {
        Bike bike = bikeRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));
        bikeRepository.delete(bike);
    }

    private Bike mapToBike(BikeRequest request) {
        return Bike.builder()
                .name(request.getName())
                .photoURL(request.getPhotoURL())
                .brand(request.getBrand())
                .plateNumber(request.getPlateNumber())
                .year(request.getYear())
                .machineCapacity(request.getMachineCapacity())
                .transmissionType(request.getTransmissionType())
                .weekdayPricePerDay(request.getWeekdayPricePerDay())
                .weekendPricePerDay(request.getWeekendPricePerDay())
                .build();
    }

    private BikeResponse mapToBikeResponse(Bike bike) {
        return BikeResponse.builder()
                .bikeID(bike.getId())
                .name(bike.getName())
                .year(bike.getYear())
                .transmissionType(bike.getTransmissionType())
                .machineCapacity(bike.getMachineCapacity())
                .photoURL(bike.getPhotoURL())
                .brand(bike.getBrand())
                .weekdayPricePerDay(bike.getWeekdayPricePerDay())
                .weekendPricePerDay(bike.getWeekendPricePerDay())
                .build();
    }

    private BikeDetailResponse mapToBikeDetailResponse(Bike bike) {
        return BikeDetailResponse.builder()
                .bikeID(bike.getId())
                .name(bike.getName())
                .photoURL(bike.getPhotoURL())
                .brand(bike.getBrand())
                .plateNumber(bike.getPlateNumber())
                .year(bike.getYear())
                .transmissionType(bike.getTransmissionType())
                .machineCapacity(bike.getMachineCapacity())
                .weekdayPricePerDay(bike.getWeekdayPricePerDay())
                .weekendPricePerDay(bike.getWeekendPricePerDay())
                .status(bike.getStatus())
                .usagePolicies(
                        bike.getUsagePolicies().stream()
                                .map(policy -> BikeDetailResponse.UsagePolicyResponse.builder()
                                        .policyID(policy.getId())
                                        .policyName(policy.getPolicyName())
                                        .description(policy.getDescription())
                                        .isPermitted(policy.isPermitted())
                                        .build())
                                .collect(Collectors.toSet()))
                .partner(BikeDetailResponse.PartnerInfo.builder()
                        .locationName(bike.getPartner().getPartnerDetail().getLocationName())
                        .isVerified(bike.getPartner().getPartnerDetail().isVerified())
                        .build())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/BusinessInsightServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.response.BusinessRecommendationResponse;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.BusinessInsightService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class BusinessInsightServiceImpl implements BusinessInsightService {

    private final UserRepository userRepository;

    @Override
    public List<BusinessRecommendationResponse> generateRecommendations() {
        List<BusinessRecommendationResponse> recommendations = new ArrayList<>();

        long thisMonthUsers = userRepository.countNewUsersBetween(
                LocalDateTime.now().withDayOfMonth(1).toLocalDate().atStartOfDay(),
                LocalDateTime.now()
        );
        long lastMonthUsers = userRepository.countNewUsersBetween(
                LocalDateTime.now().minusMonths(1).withDayOfMonth(1).toLocalDate().atStartOfDay(),
                LocalDateTime.now().withDayOfMonth(1).toLocalDate().atStartOfDay().minusNanos(1)
        );

        if (lastMonthUsers > 0 && ((double)thisMonthUsers / lastMonthUsers) < 0.85) { // Pertumbuhan < 85% (turun > 15%)
            recommendations.add(BusinessRecommendationResponse.builder()
                    .recommendation("Lakukan promosi untuk pengguna baru.")
                    .reason("Pertumbuhan pengguna baru bulan ini melambat signifikan dibandingkan bulan lalu.")
                    .severity("HIGH")
                    .build());
        }

        if(recommendations.isEmpty()){
            recommendations.add(BusinessRecommendationResponse.builder()
                    .recommendation("Semua metrik terlihat baik.")
                    .reason("Tidak ada anomali negatif yang terdeteksi pada metrik utama.")
                    .severity("LOW")
                    .build());
        }

        return recommendations;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/CloudinaryServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.cloudinary.Cloudinary;
import com.doaibu.rebikeapi.service.CloudinaryService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class CloudinaryServiceImpl implements CloudinaryService {

    private final Cloudinary cloudinary;

    @Override
    public String uploadFile(MultipartFile file, String folder) {
        try {
            Map<?, ?> result = cloudinary.uploader().upload(file.getBytes(),
                    Map.of("folder", folder));
            return (String) result.get("secure_url");
        } catch (IOException e) {
            throw new RuntimeException("Upload to Cloudinary failed", e);
        }
    }

    @Override
    public void deleteByPublicId(String publicId) {
        try {
            cloudinary.uploader().destroy(publicId, Map.of());
        } catch (IOException e) {
            throw new RuntimeException("Failed to delete file from Cloudinary", e);
        }
    }
}




---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/EmailServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.service.EmailService;
import lombok.RequiredArgsConstructor;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class EmailServiceImpl implements EmailService {

    private final JavaMailSender mailSender;

    @Override
    public void sendEmail(String to, String subject, String text) {
        try {
            SimpleMailMessage message = new SimpleMailMessage();
            message.setTo(to);
            message.setSubject(subject);
            message.setText(text);
            mailSender.send(message);
        } catch (Exception e) {
            e.printStackTrace(); // This line will print the full stack trace to your console
            throw new CustomException.BadRequestException("Failed to send verification email, please try again later.");
        }
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/FraudDetectionServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.response.FlaggedTransactionResponse;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.FraudDetectionService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class FraudDetectionServiceImpl implements FraudDetectionService {

    private final TransactionRepository transactionRepository;
    private static final int RENTAL_FREQUENCY_THRESHOLD = 3;
    private static final int RENTAL_FREQUENCY_HOURS = 24;

    @Override
    @Scheduled(cron = "0 0 */1 * * *")
    public void detectAnomalies() {
        log.info("[AI Assistant] Running job: Fraud Detection...");

        LocalDateTime thresholdTime = LocalDateTime.now().minusHours(RENTAL_FREQUENCY_HOURS);

        List<Transaction> recentTransactions = transactionRepository.findAllByCreatedAtAfter(thresholdTime);

        Map<String, List<Transaction>> transactionsByUser = recentTransactions.stream()
                .collect(Collectors.groupingBy(tx -> tx.getCustomer().getId()));

        for (Map.Entry<String, List<Transaction>> entry : transactionsByUser.entrySet()) {
            if (entry.getValue().size() > RENTAL_FREQUENCY_THRESHOLD) {
                log.warn("[AI Assistant] Potential fraud detected for user ID: {}. Found {} rentals in the last {} hours.",
                        entry.getKey(), entry.getValue().size(), RENTAL_FREQUENCY_HOURS);

                for (Transaction tx : entry.getValue()) {
                    tx.setFlaggedAsPotentialFraud(true);
                    tx.setFraudFlagReason("Frequent rentals (" + entry.getValue().size() + "x in " + RENTAL_FREQUENCY_HOURS + "h) by user.");
                    transactionRepository.save(tx);
                }
            }
        }

        log.info("[AI Assistant] Fraud Detection job finished.");
    }

    @Override
    public List<FlaggedTransactionResponse> getFlaggedTransactions() {
        return transactionRepository.findAllByIsFlaggedAsPotentialFraud(true).stream()
                .map(tx -> FlaggedTransactionResponse.builder()
                        .transactionId(tx.getId())
                        .customerName(tx.getCustomer().getFirstName() + " " + tx.getCustomer().getLastName())
                        .bikeName(tx.getBike().getName())
                        .transactionDate(tx.getCreatedAt())
                        .totalCost(tx.getTotalCost())
                        .reason(tx.getFraudFlagReason())
                        .build())
                .collect(Collectors.toList());
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/MidtransServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.PaymentStatus;
import com.doaibu.rebikeapi.dto.request.CreatePaymentRequest;
import com.doaibu.rebikeapi.dto.response.MidtransChargeResponse;
import com.doaibu.rebikeapi.entity.Payment;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PaymentRepository;
import com.doaibu.rebikeapi.config.MidtransConfig;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.MidtransService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

@Service
@RequiredArgsConstructor
public class MidtransServiceImpl implements MidtransService {

    private final PaymentRepository paymentRepository;
    private final MidtransConfig config;
    private final RestTemplate restTemplate;
    private final TransactionRepository transactionRepository;

    public MidtransChargeResponse createTransaction(CreatePaymentRequest request) {
        /** For integration with FE
         String base64Key = Base64.getEncoder().encodeToString((config.getServerKey() + ":").getBytes());
         HttpHeaders headers = new HttpHeaders();
         headers.setContentType(MediaType.APPLICATION_JSON);
         headers.set("Authorization", "Basic " + base64Key);

         Map<String, Object> payload = new HashMap<>();

         payload.put("payment_type", "bank_transfer");

         Map<String, Object> transactionDetails = Map.of(
         "order_id", request.getOrderId(),
         "gross_amount", request.getGrossAmount()
         );
         Map<String, Object> customerDetails = Map.of(
         "name", request.getCustomerName(),
         "email", request.getCustomerEmail()
         );

         payload.put("transaction_details", transactionDetails);
         payload.put("customer_details", customerDetails);

         HttpEntity<Map<String, Object>> entity = new HttpEntity<>(payload, headers);
         ResponseEntity<MidtransChargeResponse> response = restTemplate.exchange(
         config.getApiUrl(),
         HttpMethod.POST,
         entity,
         MidtransChargeResponse.class
         );

         return response.getBody();*/

        String base64Key = Base64.getEncoder().encodeToString((config.getServerKey() + ":").getBytes());
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("Authorization", "Basic " + base64Key);

        Map<String, Object> payload = new HashMap<>();

        Map<String, Object> transactionDetails = Map.of(
                "order_id", request.getOrderId(),
                "gross_amount", request.getGrossAmount()
        );

        Map<String, Object> customerDetails = Map.of(
                "name", request.getCustomerName(),
                "email", request.getCustomerEmail()
        );

        Map<String, Object> bankTransfer = Map.of("bank", request.getBank());

        payload.put("payment_type", "bank_transfer");
        payload.put("transaction_details", transactionDetails);
        payload.put("customer_details", customerDetails);
        payload.put("bank_transfer", bankTransfer);

        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(payload, headers);
        ResponseEntity<MidtransChargeResponse> response = restTemplate.exchange(
                config.getApiUrl(),
                HttpMethod.POST,
                entity,
                MidtransChargeResponse.class
        );

        return response.getBody();
    }

    @Override
    public void handleWebhook(Map<String, Object> payload) {
        String orderId = (String) payload.get("order_id");
        String paymentType = (String) payload.get("payment_type");
        String trxStatus = (String) payload.get("transaction_status");
        BigDecimal amount = new BigDecimal((String) payload.get("gross_amount"));

        Payment payment = paymentRepository.findByOrderId(orderId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Payment not found."));

        PaymentStatus status = null;
        if ("settlement".equals(trxStatus)) {
            status = PaymentStatus.PAID;
        } else if ("expired".equals(trxStatus)) {
            status = PaymentStatus.EXPIRED;
        } else if ("cancelled".equals(trxStatus)) {
            status = PaymentStatus.CANCELLED;
        }

        payment.setOrderId(orderId);
        payment.setPaymentType(paymentType);
        payment.setStatus(status);
        payment.setAmount(amount);
        payment.setUpdatedAt(LocalDateTime.now());
        paymentRepository.save(payment);

        Transaction transaction = payment.getTransaction();
        transaction.setPaymentStatus(status);
        transactionRepository.save(transaction);
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/NotificationServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.service.NotificationService;
import com.google.firebase.messaging.FirebaseMessaging;
import com.google.firebase.messaging.FirebaseMessagingException;
import com.google.firebase.messaging.Message;
import com.google.firebase.messaging.Notification;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
@RequiredArgsConstructor
public class NotificationServiceImpl implements NotificationService {

    private final FirebaseMessaging firebaseMessaging;

    @Override
    public void sendNotification(String token, String title, String body, Map<String, String> data) {
        Notification notification = Notification.builder()
                .setTitle(title)
                .setBody(body)
                .build();

        Message message = Message.builder()
                .setToken(token)
                .setNotification(notification)
                .putAllData(data)
                .build();

        try {
            firebaseMessaging.send(message);
            System.out.println("Successfully sent message to token: " + token);
        } catch (FirebaseMessagingException e) {
            System.err.println("Failed to send notification: " + e.getMessage());
        }
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/PartnerServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.request.PartnerDetailUpdateRequest;
import com.doaibu.rebikeapi.dto.request.PartnerUpdateRequest;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PartnerRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.PartnerService;
import com.doaibu.rebikeapi.util.TokenHolder;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
@RequiredArgsConstructor
public class PartnerServiceImpl implements PartnerService {

    private final PartnerRepository partnerRepository;
    private final UserRepository userRepository;
    private final TokenHolder tokenHolder;

    @Override
    public void updatePartnerProfile(PartnerDetailUpdateRequest request) {
        String username = tokenHolder.getUsername();
        Optional<User> userOptional = userRepository.findByUsername(username);

        if (userOptional.isPresent()) {
            User user = userOptional.get();
            Optional<Partner> partnerOptional = partnerRepository.findByUser(user);

            if (partnerOptional.isPresent()) {
                Partner partner = partnerOptional.get();

                partner.setLocationName(request.getLocationName());
                partnerRepository.save(partner);
            } else {
                throw new CustomException.ResourceNotFoundException("Partner not found for the authenticated user.");
            }
        } else {
            throw new CustomException.ResourceNotFoundException("User not found.");
        }
    }

    @Override
    public PartnerDetailResponse getBankInformation() {
        String username = tokenHolder.getUsername();
        Optional<User> userOptional = userRepository.findByUsername(username);

        if (userOptional.isPresent()) {
            User user = userOptional.get();
            Optional<Partner> partnerOptional = partnerRepository.findByUser(user);

            if (partnerOptional.isPresent()) {
                Partner partner = partnerOptional.get();

                return PartnerDetailResponse.builder()
                        .bankName(partner.getBankName())
                        .bankAccountName(partner.getBankAccountName())
                        .bankAccountNumber(partner.getBankAccountNumber())
                        .isVerified(partner.isVerified())
                        .build();
            } else {
                throw new CustomException.ResourceNotFoundException("Partner not found for the authenticated user.");
            }
        } else {
            throw new CustomException.ResourceNotFoundException("User not found.");
        }
    }

    @Override
    public void updateBankInformation(PartnerUpdateRequest request) {
        String username = tokenHolder.getUsername();
        Optional<User> userOptional = userRepository.findByUsername(username);

        if (userOptional.isPresent()) {
            User user = userOptional.get();
            Optional<Partner> partnerOptional = partnerRepository.findByUser(user);

            if (partnerOptional.isPresent()) {
                Partner partner = partnerOptional.get();
                
                partner.setBankName(request.getBankName());
                partner.setBankAccountName(request.getBankAccountName());
                partner.setBankAccountNumber(request.getBankAccountNumber());
                partnerRepository.save(partner);
            } else {
                throw new CustomException.ResourceNotFoundException("Partner not found for the authenticated user.");
            }
        } else {
            throw new CustomException.ResourceNotFoundException("User not found.");
        }
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/PayoutServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PayoutStatus;
import com.doaibu.rebikeapi.dto.request.PayoutRequest;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.dto.response.PayoutResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.Payout;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PayoutRepository;
import com.doaibu.rebikeapi.repository.SystemConfigurationRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.PayoutService;
import com.doaibu.rebikeapi.util.TokenHolder;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.beans.factory.annotation.Value;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class PayoutServiceImpl implements PayoutService {

    private final PayoutRepository payoutRepository;
    private final UserRepository userRepository;
    private final TransactionRepository transactionRepository;
    private final TokenHolder tokenHolder;
    private final SystemConfigurationRepository systemConfigRepository;

    @Value("${app.payout.min-amount}")
    private BigDecimal minPayoutAmount;

    @Override
    public List<PayoutResponse> getAllPayouts() {
        return payoutRepository.findAll().stream()
                .map(this::mapToPayoutResponse)
                .collect(Collectors.toList());
    }

    @Override
    public List<PayoutResponse> getPayoutsForPartner() {
        User partnerUser = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        return payoutRepository.findByPartnerOrderByRequestedAtDesc(partnerUser).stream()
                .map(this::mapToPayoutResponse)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional
    public PayoutResponse requestPayout(PayoutRequest request) {
        User partnerUser = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Partner partnerDetails = partnerUser.getPartnerDetail();

        if (!partnerDetails.isVerified()) {
            throw new CustomException.AuthorizationException("Akun Anda harus terverifikasi untuk dapat mengajukan pencairan dana.");
        }

        if (partnerDetails.getBankName() == null || partnerDetails.getBankAccountNumber() == null) {
            throw new CustomException.BadRequestException("Bank information is incomplete. Please complete it in your profile.");
        }

        BigDecimal platformFeePercentage = new BigDecimal(
                systemConfigRepository.findById("platform_fee_percentage")
                        .orElseThrow(() -> new IllegalStateException("Platform fee not configured."))
                        .getConfigValue()
        );
        BigDecimal totalRevenue = transactionRepository.findByBike_Partner(partnerUser).stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .map(Transaction::getTotalCost)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal totalFee = totalRevenue.multiply(platformFeePercentage);
        BigDecimal netRevenue = totalRevenue.subtract(totalFee);

        List<Payout> partnerPayouts = payoutRepository.findByPartnerOrderByRequestedAtDesc(partnerUser);

        BigDecimal totalPaidOut = partnerPayouts.stream()
                .filter(p -> p.getStatus() == PayoutStatus.APPROVED)
                .map(Payout::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal totalPendingOrProcessing = partnerPayouts.stream()
                .filter(p -> p.getStatus() == PayoutStatus.PENDING || p.getStatus() == PayoutStatus.PROCESSING)
                .map(Payout::getAmount)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal availableBalance = netRevenue.subtract(totalPaidOut).subtract(totalPendingOrProcessing);

        if (request.getAmount().compareTo(availableBalance) > 0) {
            throw new CustomException.BadRequestException("The withdrawal amount exceeds the available balance. Balance is IDR " + availableBalance);
        }

        if (request.getAmount().compareTo(minPayoutAmount) < 0) {
            throw new CustomException.BadRequestException("The minimum withdrawal amount is IDR " + minPayoutAmount);
        }

        String bankDetails = String.format("%s - %s a/n %s",
                partnerDetails.getBankName(),
                partnerDetails.getBankAccountNumber(),
                partnerDetails.getBankAccountName());
        Payout payout = Payout.builder()
                .partner(partnerUser)
                .amount(request.getAmount())
                .status(PayoutStatus.PENDING)
                .requestedAt(LocalDateTime.now())
                .bankDetailsSnapshot(bankDetails)
                .build();
        payoutRepository.save(payout);
        return mapToPayoutResponse(payout);
    }

    @Override
    @Transactional
    public void processPayout(String payoutId, ProcessPayoutRequest request) {
        Payout payout = payoutRepository.findById(payoutId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Payout request not found."));
        if (payout.getStatus() != PayoutStatus.PENDING) {
            throw new CustomException.BadRequestException("This payout has already been processed.");
        }

        if (request.getStatus() == PayoutStatus.APPROVED) {
            payout.setStatus(PayoutStatus.APPROVED);
            payout.setNotes(request.getNotes() != null ? request.getNotes() : "Approved manually by admin.");
        } else if (request.getStatus() == PayoutStatus.REJECTED) {
            payout.setStatus(PayoutStatus.REJECTED);
            payout.setNotes(request.getNotes());
        } else {
            payout.setStatus(request.getStatus());
            payout.setNotes(request.getNotes());
        }


        payout.setProcessedAt(LocalDateTime.now());
        payoutRepository.save(payout);
    }

    private PayoutResponse mapToPayoutResponse(Payout payout) {
        return PayoutResponse.builder()
                .id(payout.getId())
                .partnerName(payout.getPartner().getFirstName())
                .amount(payout.getAmount())
                .status(payout.getStatus())
                .requestedAt(payout.getRequestedAt())
                .processedAt(payout.getProcessedAt())
                .bankDetailsSnapshot(payout.getBankDetailsSnapshot())
                .notes(payout.getNotes())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/PickupPointServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.dto.request.PickupPointRequest;
import com.doaibu.rebikeapi.dto.response.PickupPointResponse;
import com.doaibu.rebikeapi.entity.PickupPoint;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PickupPointRepository;
import com.doaibu.rebikeapi.service.PickupPointService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class PickupPointServiceImpl implements PickupPointService {

    private final PickupPointRepository pickupPointRepository;

    @Override
    public PickupPointResponse createPickupPoint(PickupPointRequest request) {
        PickupPoint pickupPoint = PickupPoint.builder()
                .locationName(request.getLocationName())
                .address(request.getAddress())
                .build();

        pickupPointRepository.save(pickupPoint);
        return mapToPickupPointResponse(pickupPoint);
    }

    @Override
    public List<PickupPointResponse> getAllPickupPoints() {
        return pickupPointRepository.findAll().stream()
                .map(this::mapToPickupPointResponse)
                .collect(Collectors.toList());
    }

    @Override
    public PickupPointResponse updatePickupPoint(String id, PickupPointRequest request) {
        PickupPoint pickupPoint = pickupPointRepository.findById(id)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Pickup point not found."));

        pickupPoint.setLocationName(request.getLocationName());
        pickupPoint.setAddress(request.getAddress());
        pickupPointRepository.save(pickupPoint);
        return mapToPickupPointResponse(pickupPoint);
    }

    @Override
    public void deletePickupPoint(String id) {
        if (!pickupPointRepository.existsById(id)) {
            throw new CustomException.ResourceNotFoundException("Pickup point not found.");
        }

        pickupPointRepository.deleteById(id);
    }

    public PickupPointResponse mapToPickupPointResponse(PickupPoint pickupPoint) {
        return PickupPointResponse.builder()
                .pickupPointID(pickupPoint.getId())
                .locationName(pickupPoint.getLocationName())
                .address(pickupPoint.getAddress())
                .build();
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/RoleServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.repository.RoleRepository;
import com.doaibu.rebikeapi.service.RoleService;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
@RequiredArgsConstructor
public class RoleServiceImpl implements RoleService {
    private final RoleRepository roleRepository;

    @Override
    public Optional<Role> findByName(UserRole name) {
        return roleRepository.findByName(name);
    }

    @Override
    public Role save(Role role) {
        return roleRepository.save(role);
    }

    @Override
    public Role getOrCreate(UserRole name) {
        return findByName(name)
                .orElseGet(() -> {
                    Role role = new Role();
                    role.setName(name);
                    return save(role);
                });
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/ScheduledTasksServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.service.NotificationService;
import com.doaibu.rebikeapi.service.ScheduledTasksService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class ScheduledTasksServiceImpl implements ScheduledTasksService {

    private final TransactionRepository transactionRepository;
    private final NotificationService notificationService;

    @Override
    @Scheduled(cron = "0 0 * * * *")
    public void sendRentalReminders() {
        log.info("Running scheduled task: sendRentalReminders");
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime reminderWindowStart = now.plusHours(1);
        LocalDateTime reminderWindowEnd = now.plusHours(2);

        List<Transaction> upcomingTransactions = transactionRepository
                .findAllByBookingStatusAndStartDateBetween(BookingStatus.CONFIRMED, reminderWindowStart, reminderWindowEnd);

        for (Transaction tx : upcomingTransactions) {
            try {
                String fcmToken = tx.getCustomer().getFcmToken();
                if (fcmToken != null && !fcmToken.isEmpty()) {
                    notificationService.sendNotification(
                            fcmToken,
                            "⏰ Pengingat Jadwal Sewa",
                            "Sewa " + tx.getBike().getName() + " Anda akan segera dimulai.",
                            Map.of("transactionId", tx.getId(), "screen", "TransactionDetail")
                    );
                    log.info("Reminder sent for transaction ID: {}", tx.getId());
                }
            } catch (Exception e) {
                log.error("Failed to send reminder for transaction ID: {}. Error: {}", tx.getId(), e.getMessage());
            }
        }
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/TransactionServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.constant.PaymentStatus;
import com.doaibu.rebikeapi.dto.request.CreatePaymentRequest;
import com.doaibu.rebikeapi.dto.request.TransactionRequest;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.Bike;
import com.doaibu.rebikeapi.entity.Payment;
import com.doaibu.rebikeapi.entity.Transaction;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.BikeRepository;
import com.doaibu.rebikeapi.repository.PaymentRepository;
import com.doaibu.rebikeapi.repository.TransactionRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.MidtransService;
import com.doaibu.rebikeapi.service.NotificationService;
import com.doaibu.rebikeapi.service.TransactionService;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.orm.ObjectOptimisticLockingFailureException;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.Month;
import java.time.format.TextStyle;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class TransactionServiceImpl implements TransactionService {

    private final TransactionRepository transactionRepository;
    private final PaymentRepository paymentRepository;
    private final MidtransService midtransService;
    private final BikeRepository bikeRepository;
    private final UserRepository userRepository;
    private final NotificationService notificationService;
    private final TokenHolder tokenHolder;

    @Override
    @Transactional
    public MidtransChargeResponse createBooking(TransactionRequest request) {
        try {
            User customer = userRepository.findByUsername(tokenHolder.getUsername())
                    .orElseThrow(() -> new CustomException.ResourceNotFoundException("Customer not found."));
            Bike bike = bikeRepository.findById(request.getBikeID())
                    .orElseThrow(() -> new CustomException.ResourceNotFoundException("Bike not found."));

            if (bike.getStatus() != BikeStatus.AVAILABLE) {
                throw new CustomException.BadRequestException("Bike is not available for booking.");
            }

            bike.setStatus(BikeStatus.PENDING);
            bikeRepository.save(bike);

            long days = ChronoUnit.DAYS.between(request.getStartDate(), request.getEndDate()) + 1;
            BigDecimal baseCost = bike.getWeekdayPricePerDay().multiply(BigDecimal.valueOf(days));

            Transaction transaction = Transaction.builder()
                    .bike(bike)
                    .customer(customer)
                    .startDate(request.getStartDate())
                    .endDate(request.getEndDate())
                    .baseCost(baseCost)
                    .additionalCosts(BigDecimal.ZERO)
                    .totalCost(baseCost)
                    .bookingStatus(BookingStatus.PENDING)
                    .paymentStatus(PaymentStatus.PENDING)
                    .build();

            transactionRepository.save(transaction);

            String orderId = "INV-RBK-" + transaction.getId();
            CreatePaymentRequest payRequest = CreatePaymentRequest.builder()
                    .orderId(orderId)
                    .grossAmount(transaction.getTotalCost())
                    .customerName(customer.getFirstName() + " " + customer.getLastName())
                    .customerEmail(customer.getEmail())
                    .bank("BRI") // remove for integration with fe
                    .build();

            MidtransChargeResponse response = midtransService.createTransaction(payRequest);

            String bank = null;
            String vaNumber = null;
            if (response.getVaNumbers() instanceof List<?> vaList && !vaList.isEmpty()) {
                Object vaObj = vaList.get(0);
                if (vaObj instanceof Map<?, ?> map) {
                    bank = (String) map.get("bank");
                    vaNumber = (String) map.get("va_number");
                }
            }

            Payment payment = Payment.builder()
                    .orderId(orderId)
                    .status(PaymentStatus.PENDING)
                    .paymentType(response.getPaymentType())
                    .amount(baseCost)
                    .bank(bank)
                    .vaNumber(vaNumber)
                    .snapUrl(response.getRedirectUrl())
                    .transaction(transaction)
                    .build();

            paymentRepository.save(payment);
            return response;
        } catch (ObjectOptimisticLockingFailureException e) {
            throw new CustomException.ConflictException("Sorry, this bike has just been reserved by someone else.");
        }
    }

    @Override
    public PagedResponse<TransactionDetailResponse> getAllTransactions(Pageable pageable) {
        Page<Transaction> transactionPage = transactionRepository.findAll(pageable);
        List<TransactionDetailResponse> transactionResponses = transactionPage.stream()
                .map(this::mapToTransactionDetailedResponse)
                .collect(Collectors.toList());
        return PagedResponse.<TransactionDetailResponse>builder()
                .data(transactionResponses)
                .page(transactionPage.getNumber())
                .size(transactionPage.getSize())
                .totalElements(transactionPage.getTotalElements())
                .totalPages(transactionPage.getTotalPages())
                .build();
    }

    @Override
    public List<TransactionResponse> getTransactionHistory() {
        User customer = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Customer not found."));
        return transactionRepository.findByCustomer(customer).stream()
                .map(this::mapToTransactionResponse)
                .collect(Collectors.toList());
    }

    @Override
    public TransactionDetailResponse getTransactionDetails(String transactionId) {
        User currentUser = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User not found."));

        Transaction transaction = transactionRepository.findById(transactionId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));

        boolean isCustomer = transaction.getCustomer().getId().equals(currentUser.getId());
        boolean isPartner = transaction.getBike().getPartner().getId().equals(currentUser.getId());

        if (!isCustomer && !isPartner) {
            throw new CustomException.AuthorizationException("You are not authorized to view this transaction.");
        }

        return mapToTransactionDetailedResponse(transaction);
    }

    @Override
    public List<TransactionDetailResponse> getTransactionsForPartner() {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        return transactionRepository.findByBike_Partner(partner).stream()
                .map(this::mapToTransactionDetailedResponse)
                .collect(Collectors.toList());
    }

    @Override
    @Transactional
    public void verifyPayment(String transactionId, boolean isValid, String reason) {
        Transaction transaction = transactionRepository.findById(transactionId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));
        if (isValid) {
            transaction.setPaymentStatus(PaymentStatus.PAID);
            transaction.setBookingStatus(BookingStatus.CONFIRMED);
        } else {
            transaction.setPaymentStatus(PaymentStatus.EXPIRED);
            transaction.setBookingStatus(BookingStatus.CANCELLED);
        }

        transactionRepository.save(transaction);
    }

//    @Transactional
//    @Override
//    public void uploadPaymentProof(String transactionId, String paymentProofUrl) {
//        Transaction transaction = transactionRepository.findById(transactionId)
//                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));
//        transaction.setPaymentStatus(PaymentStatus.PENDING);
//        transactionRepository.save(transaction);
//    }

    @Override
    @Transactional
    public void confirmTransaction(String transactionId, BookingStatus status) {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        Transaction transaction = transactionRepository.findById(transactionId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Transaction not found."));
        if (!Objects.equals(transaction.getBike().getPartner().getId(), partner.getId())) {
            throw new CustomException.AuthorizationException("You are not authorized to modify this transaction.");
        }

        if (transaction.getBookingStatus() != BookingStatus.PENDING) {
            throw new CustomException.BadRequestException("Only pending transactions can be confirmed or cancelled.");
        }

        transaction.setBookingStatus(status);
        Transaction savedTransaction = transactionRepository.save(transaction);
        try {
            User customer = savedTransaction.getCustomer();
            if (customer.getFcmToken() != null && !customer.getFcmToken().isEmpty()) {
                String title = "";
                String body = "";

                if (savedTransaction.getBookingStatus() == BookingStatus.CONFIRMED) {
                    title = "✅ Order Dikonfirmasi!";
                    body = "Pesanan Anda untuk sepeda '" + savedTransaction.getBike().getName() + "' telah diterima.";
                } else if (savedTransaction.getBookingStatus() == BookingStatus.CANCELLED) {
                    title = "❌ Order Dibatalkan";
                    body = "Pesanan Anda untuk sepeda '" + savedTransaction.getBike().getName() + "' telah dibatalkan oleh partner.";
                }

                if (!title.isEmpty()) {
                    notificationService.sendNotification(
                            customer.getFcmToken(), title, body,
                            Map.of("transactionId", savedTransaction.getId(), "screen", "TransactionDetail")
                    );
                }
            }
        } catch (Exception e) {
            System.err.println("Gagal mengirim notifikasi konfirmasi ke pelanggan: " + e.getMessage());
        }
    }

    @Override
    public FinancialSummaryResponse getFinancialSummaryForPartner() {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        List<Transaction> transactions = transactionRepository.findByBike_Partner(partner);

        BigDecimal totalRevenue = transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .map(Transaction::getTotalCost)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        int totalCompleted = (int) transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED)
                .count();
        int totalPending = (int) transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.PENDING)
                .count();
        return FinancialSummaryResponse.builder()
                .totalRevenue(totalRevenue)
                .totalCompletedTransactions(totalCompleted)
                .totalPendingTransactions(totalPending)
                .build();
    }

    @Override
    public RevenueTrendResponse getRevenueTrendForPartner() {
        User partner = userRepository.findByUsername(tokenHolder.getUsername())
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        List<Transaction> transactions = transactionRepository.findByBike_Partner(partner);

        Map<Month, BigDecimal> monthlyRevenue = transactions.stream()
                .filter(t -> t.getBookingStatus() == BookingStatus.COMPLETED && t.getStartDate().getYear() == LocalDate.now().getYear())
                .collect(Collectors.groupingBy(
                        t -> t.getStartDate().getMonth(),
                        Collectors.mapping(Transaction::getTotalCost, Collectors.reducing(BigDecimal.ZERO, BigDecimal::add))
                ));
        List<String> labels = new ArrayList<>();
        List<BigDecimal> data = new ArrayList<>();
        LocalDate currentDate = LocalDate.now();
        for (int i = 5; i >= 0; i--) {
            Month month = currentDate.minusMonths(i).getMonth();
            String monthLabel = month.getDisplayName(TextStyle.SHORT, new Locale("id", "ID"));
            labels.add(monthLabel);
            data.add(monthlyRevenue.getOrDefault(month, BigDecimal.ZERO));
        }

        return RevenueTrendResponse.builder()
                .labels(labels)
                .data(data)
                .build();
    }

    private TransactionResponse mapToTransactionResponse(Transaction transaction) {
        return TransactionResponse.builder()
                .transactionID(transaction.getId())
                .startDate(transaction.getStartDate())
                .endDate(transaction.getEndDate())
                .baseCost(transaction.getBaseCost())
                .totalCost(transaction.getTotalCost())
                .paymentStatus(transaction.getPaymentStatus())
                .bookingStatus(transaction.getBookingStatus())
                .build();
    }

    private TransactionDetailResponse mapToTransactionDetailedResponse(Transaction transaction) {
        return TransactionDetailResponse.builder()
                .transactionID(transaction.getId())
                .startDate(transaction.getStartDate())
                .endDate(transaction.getEndDate())
                .baseCost(transaction.getBaseCost())
                .totalCost(transaction.getTotalCost())
                .paymentStatus(transaction.getPaymentStatus())
                .bookingStatus(transaction.getBookingStatus())
                .bike(mapToBikeResponse(transaction.getBike()))
                .customer(mapToUserResponse(transaction.getCustomer()))
                .build();
    }

    private BikeResponse mapToBikeResponse(Bike bike) {
        return BikeResponse.builder()
                .bikeID(bike.getId())
                .name(bike.getName())
                .brand(bike.getBrand())
                .weekdayPricePerDay(bike.getWeekdayPricePerDay())
                .build();
    }

    private UserResponse mapToUserResponse(User user) {
        return UserResponse.builder()
                .userID(user.getId())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/UserDetailsServiceImpl.java
---

// be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/UserDetailsServiceImpl.java
package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.repository.UserRepository;

import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class UserDetailsServiceImpl implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        UserDetails user = userRepository.findByUsername(username)
                .orElseThrow(() -> {
                    return new UsernameNotFoundException("Username not found");
                });
        return user;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/impl/UserServiceImpl.java
---

package com.doaibu.rebikeapi.service.impl;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.dto.request.ChangePasswordRequest;
import com.doaibu.rebikeapi.dto.request.UpdateFcmTokenRequest;
import com.doaibu.rebikeapi.dto.request.UpdateUserProfileRequest;
import com.doaibu.rebikeapi.dto.response.AdminPartnerResponse;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;
import com.doaibu.rebikeapi.dto.response.UserResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import com.doaibu.rebikeapi.entity.Partner;
import com.doaibu.rebikeapi.entity.Role;
import com.doaibu.rebikeapi.entity.User;
import com.doaibu.rebikeapi.exception.CustomException;
import com.doaibu.rebikeapi.repository.PartnerRepository;
import com.doaibu.rebikeapi.repository.UserRepository;
import com.doaibu.rebikeapi.service.CloudinaryService;
import com.doaibu.rebikeapi.service.RoleService;
import com.doaibu.rebikeapi.service.UserService;
import com.doaibu.rebikeapi.util.TokenHolder;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.server.ResponseStatusException;

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {

    private final UserRepository userRepository;
    private final RoleService roleService;
    private final PasswordEncoder passwordEncoder;
    private final PartnerRepository partnerRepository;
    private final CloudinaryService cloudinaryService;
    private final TokenHolder tokenHolder;

    private final long maxSize = 5 * 1024 * 1024;

    @Override
    public UserResponse getCustomerProfile(String userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Customer not found."));
        if (user.getRoles().stream().noneMatch(role -> role.getName().equals(UserRole.CUSTOMER))) {
            throw new CustomException.BadRequestException("User is not a customer.");
        }
        return mapToUserResponse(user);
    }

    private UserResponse mapToUserResponse(User user) {
        return UserResponse.builder()
                .userID(user.getId())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .email(user.getEmail())
                .phoneNumber(user.getPhoneNumber())
                .build();
    }

    @Override
    public PartnerDetailResponse getPartnerProfile(String userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        if (user.getRoles().stream().noneMatch(role -> role.getName().equals(UserRole.PARTNER))) {
            throw new CustomException.BadRequestException("User is not a partner.");
        }
        Partner partnerDetails = user.getPartnerDetail();
        if (partnerDetails == null) {
            throw new CustomException.ResourceNotFoundException("Partner details not found for this user.");
        }
        return PartnerDetailResponse.builder()
                .bankName(partnerDetails.getBankName())
                .bankAccountName(partnerDetails.getBankAccountName())
                .bankAccountNumber(partnerDetails.getBankAccountNumber())
                .isVerified(partnerDetails.isVerified())
                .build();
    }

    @Override
    public PagedResponse<AdminPartnerResponse> getAllPartners(Pageable pageable) {
        Role partnerRole = roleService.getOrCreate(UserRole.PARTNER);
        Page<AdminPartnerResponse> partnerPage = userRepository.findAllPartnersWithBikeCount(partnerRole, pageable);

        return PagedResponse.<AdminPartnerResponse>builder()
                .data(partnerPage.getContent())
                .page(partnerPage.getNumber())
                .size(partnerPage.getSize())
                .totalElements(partnerPage.getTotalElements())
                .totalPages(partnerPage.getTotalPages())
                .build();
    }

    @Override
    public AdminPartnerResponse getPartnerById(String partnerId) {
        User user = userRepository.findById(partnerId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        if (user.getRoles().stream().noneMatch(role -> role.getName().equals(UserRole.PARTNER))) {
            throw new CustomException.BadRequestException("User is not a partner.");
        }
        return mapToAdminPartnerResponse(user);
    }

    @Override
    @Transactional
    public void updateProfile(UpdateUserProfileRequest request, MultipartFile file) {
        String username = tokenHolder.getUsername();
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "User not found."));
        if (file != null && !file.isEmpty()) {
            if (file.getSize() > maxSize) {
                throw new CustomException.BadRequestException("File size exceeds 5MB limit.");
            }
            String fileName = file.getOriginalFilename();
            if (fileName != null && !fileName.endsWith(".jpg") && !fileName.endsWith(".jpeg") && !fileName.endsWith(".png")) {
                throw new CustomException.BadRequestException("Only JPG/PNG files are allowed.");
            }

            String url = cloudinaryService.uploadFile(file, "profile_pictures");
            user.setPhotoUrl(url);
        }

        user.setFirstName(request.getFirstName());
        user.setLastName(request.getLastName());
        user.setUsername(request.getUsername());
        user.setPhoneNumber(request.getPhoneNumber());
        userRepository.save(user);
    }

    @Override
    @Transactional
    public void verifyPartner(String partnerId, boolean isVerified) {
        Partner partner = partnerRepository.findById(partnerId)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("Partner not found."));
        partner.setVerified(isVerified);
        partnerRepository.save(partner);
    }

    @Override
    @Transactional
    public void changePassword(String username, ChangePasswordRequest request) {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "User not found."));
        if (!passwordEncoder.matches(request.getOldPassword(), user.getPassword())) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Old password is incorrect.");
        }
        if (!request.getNewPassword().equals(request.getConfirmPassword())) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Confirm password does not match.");
        }
        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        userRepository.save(user);
    }

    @Override
    @Transactional
    public void updateFcmToken(UpdateFcmTokenRequest request) {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        String email;
        if (principal instanceof UserDetails) {
            email = ((UserDetails) principal).getUsername();
        } else {
            email = principal.toString();
        }
        User currentUser = userRepository.findByEmail(email)
                .orElseThrow(() -> new CustomException.ResourceNotFoundException("User with email '" + email + "' not found"));
        currentUser.setFcmToken(request.getFcmToken());
        userRepository.save(currentUser);
    }

    private AdminPartnerResponse mapToAdminPartnerResponse(User user) {
        Partner partnerDetails = user.getPartnerDetail();
        return AdminPartnerResponse.builder()
                .id(user.getId())
                .name(user.getFirstName() + " " + user.getLastName())
                .email(user.getEmail())
                .locationName(partnerDetails != null ? partnerDetails.getLocationName() : "N/A")
                .totalBikes(user.getOwnedBikes() != null ? user.getOwnedBikes().size() : 0)
                .isVerified(partnerDetails != null && partnerDetails.isVerified())
                .build();
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AdminDashboardService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.response.DashboardSummaryResponse;

public interface AdminDashboardService {
    DashboardSummaryResponse getDashboardSummary();
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AdminSettingService.java
---

package com.doaibu.rebikeapi.service;

import java.math.BigDecimal;

public interface AdminSettingService {
    BigDecimal getPlatformFeePercentage();
    void updatePlatformFeePercentage(BigDecimal newFee);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AIAssistantService.java
---

package com.doaibu.rebikeapi.service;

public interface AIAssistantService {

    void autoProcessPendingPayouts();

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/AuthService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.*;
import com.doaibu.rebikeapi.dto.response.LoginResponse;
import com.doaibu.rebikeapi.dto.response.RegisterResponse;
import com.doaibu.rebikeapi.entity.User;

public interface AuthService {

    RegisterResponse registerCustomer(RegisterCustomerRequest request);

    RegisterResponse registerPartner(RegisterPartnerRequest request);

    void verifyEmailOtp(String email, String otp);

    void resendVerificationOtp(String email);

    LoginResponse login(LoginRequest request);

    void processForgotPassword(String email, String feBaseUrl);

    void resetPasswordWithOtp(ResetPasswordWithOtpRequest request);

    User processOAuthPostLogin(String email, String name);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/BikeService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.constant.BikeStatus;
import com.doaibu.rebikeapi.dto.request.BikeRequest;
import com.doaibu.rebikeapi.dto.response.BikeDetailResponse;
import com.doaibu.rebikeapi.dto.response.BikeResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import org.springframework.data.domain.Pageable;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

public interface BikeService {
    BikeResponse addBike(BikeRequest request, MultipartFile file);

    PagedResponse<BikeResponse> getAllBikes(Pageable pageable);

    PagedResponse<BikeResponse> getAllMyBikes(Pageable pageable);

    BikeDetailResponse getBikeById(String id);

    BikeResponse updateBike(String id, BikeRequest request);

    BikeResponse updateBikeStatus(String bikeId, BikeStatus status);

    void deleteBike(String id);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/BusinessInsightService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.response.BusinessRecommendationResponse;
import java.util.List;

public interface BusinessInsightService {
    List<BusinessRecommendationResponse> generateRecommendations();
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/CloudinaryService.java
---

package com.doaibu.rebikeapi.service;

import org.springframework.web.multipart.MultipartFile;

public interface CloudinaryService {
    String uploadFile(MultipartFile file, String folder);

    void deleteByPublicId(String publicId);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/EmailService.java
---

package com.doaibu.rebikeapi.service;

public interface EmailService {
    void sendEmail(String to, String subject, String text);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/FraudDetectionService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.response.FlaggedTransactionResponse;
import java.util.List;

public interface FraudDetectionService {
    void detectAnomalies();
    List<FlaggedTransactionResponse> getFlaggedTransactions();
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/MidtransService.java
---

package com.doaibu.rebikeapi.service;

import java.util.Map;

import com.doaibu.rebikeapi.dto.request.CreatePaymentRequest;
import com.doaibu.rebikeapi.dto.response.MidtransChargeResponse;

public interface MidtransService {
    MidtransChargeResponse createTransaction(CreatePaymentRequest request);

    void handleWebhook(Map<String, Object> payload);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/NotificationService.java
---

package com.doaibu.rebikeapi.service;

import java.util.Map;

public interface NotificationService {
    void sendNotification(String token, String title, String body, Map<String, String> data);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/PartnerService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.PartnerDetailUpdateRequest;
import com.doaibu.rebikeapi.dto.request.PartnerUpdateRequest;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;

public interface PartnerService {
    void updatePartnerProfile(PartnerDetailUpdateRequest request);

    PartnerDetailResponse getBankInformation();

    void updateBankInformation(PartnerUpdateRequest request);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/PayoutService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.PayoutRequest;
import com.doaibu.rebikeapi.dto.request.ProcessPayoutRequest;
import com.doaibu.rebikeapi.dto.response.PayoutResponse;

import java.util.List;

public interface PayoutService {
    List<PayoutResponse> getAllPayouts();

    List<PayoutResponse> getPayoutsForPartner();

    PayoutResponse requestPayout(PayoutRequest request);

    void processPayout(String payoutId, ProcessPayoutRequest request);

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/PickupPointService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.PickupPointRequest;
import com.doaibu.rebikeapi.dto.response.PickupPointResponse;

import java.util.List;

public interface PickupPointService {
    PickupPointResponse createPickupPoint(PickupPointRequest request);

    List<PickupPointResponse> getAllPickupPoints();

    PickupPointResponse updatePickupPoint(String id, PickupPointRequest request);

    void deletePickupPoint(String id);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/RoleService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.constant.UserRole;
import com.doaibu.rebikeapi.entity.Role;

import java.util.Optional;

public interface RoleService {
    Optional<Role> findByName(UserRole name);

    Role save(Role role);

    Role getOrCreate(UserRole name);
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/ScheduledTasksService.java
---

package com.doaibu.rebikeapi.service;

public interface ScheduledTasksService {

    void sendRentalReminders();

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/TransactionService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.constant.BookingStatus;
import com.doaibu.rebikeapi.dto.request.TransactionRequest;
import com.doaibu.rebikeapi.dto.response.*;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import org.springframework.data.domain.Pageable;

import java.util.List;

public interface TransactionService {
    MidtransChargeResponse createBooking(TransactionRequest request);

    PagedResponse<TransactionDetailResponse> getAllTransactions(Pageable pageable);
    List<TransactionResponse> getTransactionHistory();

    TransactionDetailResponse getTransactionDetails(String transactionId);

    List<TransactionDetailResponse> getTransactionsForPartner();

    void verifyPayment(String transactionId, boolean isValid, String reason);

//    void uploadPaymentProof(String transactionId, String paymentProofUrl);
    void confirmTransaction(String transactionId, BookingStatus status);

    FinancialSummaryResponse getFinancialSummaryForPartner();

    RevenueTrendResponse getRevenueTrendForPartner();

}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/service/UserService.java
---

package com.doaibu.rebikeapi.service;

import com.doaibu.rebikeapi.dto.request.ChangePasswordRequest;
import com.doaibu.rebikeapi.dto.request.UpdateFcmTokenRequest;
import com.doaibu.rebikeapi.dto.request.UpdateUserProfileRequest;
import com.doaibu.rebikeapi.dto.response.AdminPartnerResponse;
import com.doaibu.rebikeapi.dto.response.PartnerDetailResponse;
import com.doaibu.rebikeapi.dto.response.UserResponse;
import com.doaibu.rebikeapi.dto.response.other.PagedResponse;
import org.springframework.data.domain.Pageable;
import org.springframework.web.multipart.MultipartFile;

public interface UserService {

    UserResponse getCustomerProfile(String userId);

    PartnerDetailResponse getPartnerProfile(String userId);

    PagedResponse<AdminPartnerResponse> getAllPartners(Pageable pageable);

    AdminPartnerResponse getPartnerById(String partnerId);

    void updateProfile(UpdateUserProfileRequest request, MultipartFile file);

    void verifyPartner(String partnerId, boolean isVerified);

    void changePassword(String username, ChangePasswordRequest request);

    void updateFcmToken(UpdateFcmTokenRequest request);
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/util/ResponseUtil.java
---

package com.doaibu.rebikeapi.util;

import com.doaibu.rebikeapi.dto.response.other.CommonResponse;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

public class ResponseUtil {
    public static <T> ResponseEntity<CommonResponse<T>> response(HttpStatus status, String message, T data) {
        CommonResponse<T> commonResponse = new CommonResponse<>();

        commonResponse.setMessage(message);
        commonResponse.setStatusCode(status.value());
        commonResponse.setData(data);

        return ResponseEntity.status(status).body(commonResponse);
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/util/TokenHolder.java
---

package com.doaibu.rebikeapi.util;

import com.doaibu.rebikeapi.security.JwtUtil;

import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class TokenHolder {
    private final HttpServletRequest request;
    private final JwtUtil jwtUtil;

    public String getUsername() {
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            return jwtUtil.extractUsername(token);
        }
        return null;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/RebikeApplication.java
---

package com.doaibu.rebikeapi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@EnableScheduling
public class RebikeApplication {

    public static void main(String[] args) {
        SpringApplication.run(RebikeApplication.class, args);
    }

}



---
File: be-rebike/src/test/java/com/doaibu/rebikeapi/RebikeApplicationTests.java
---

package com.doaibu.rebikeapi;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class RebikeApplicationTests {

    @Test
    void contextLoads() {
    }

}


import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

public class ResponseUtil {
    public static <T> ResponseEntity<CommonResponse<T>> response(HttpStatus status, String message, T data) {
        CommonResponse<T> commonResponse = new CommonResponse<>();

        commonResponse.setMessage(message);
        commonResponse.setStatusCode(status.value());
        commonResponse.setData(data);

        return ResponseEntity.status(status).body(commonResponse);
    }
}



---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/util/TokenHolder.java
---

package com.doaibu.rebikeapi.util;

import com.doaibu.rebikeapi.security.JwtUtil;

import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class TokenHolder {
    private final HttpServletRequest request;
    private final JwtUtil jwtUtil;

    public String getUsername() {
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            return jwtUtil.extractUsername(token);
        }
        return null;
    }
}


---
File: be-rebike/src/main/java/com/doaibu/rebikeapi/RebikeApplication.java
---

package com.doaibu.rebikeapi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@EnableScheduling
public class RebikeApplication {

    public static void main(String[] args) {
        SpringApplication.run(RebikeApplication.class, args);
    }

}



---
File: be-rebike/src/test/java/com/doaibu/rebikeapi/RebikeApplicationTests.java
---

package com.doaibu.rebikeapi;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class RebikeApplicationTests {

    @Test
    void contextLoads() {
    }

}

